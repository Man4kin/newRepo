&НаКлиенте
Процедура ПриемкаТовара(Команда)
	ЭтаФорма.Закрыть();
	Объект.Контрагент = ОткрытьФормуМодально("Справочник.Контрагенты.ФормаВыбора");
	Если НЕ ЗначениеЗаполнено(Объект.Контрагент) Тогда 
		Возврат;
	КонецЕсли;
	ЕстьЗадачиПриемки(Объект.Контрагент);
	Если ЗначениеЗаполнено(Объект.Задачи) Тогда 
		П = Новый Структура("Задачи", Объект.Задачи);
		Рез = ОткрытьФормуМодально("Обработка.Izh_ПриемкаТоваров.Форма.ФормаЗадач",П);	
	КонецЕсли;
	Если НЕ ЗначениеЗаполнено(Объект.Задачи) ИЛИ Рез = КодВозвратаДиалога.Да Тогда 
		Если РазрешенаПрямаяПоставка(Объект.Контрагент) Тогда 
			Форма = ПолучитьФорму("Обработка.Izh_ПриемкаТоваров.Форма.ФормаПН");
			ДанныеФормы = Форма.Объект; 
			Заполнить(ДанныеФормы, Объект.Контрагент);
			КопироватьДанныеФормы(ДанныеФормы, Форма.Объект); 
			Если Форма.ОткрытьМодально() = КодВозвратаДиалога.ОК Тогда 
				ДанныеФормы2 = Форма.Объект; 
				бп = СоздатьПН(ДанныеФормы2);
				ПараметрыФормы = Новый Структура("Ключ", бп );
				ОткрытьФорму("БизнесПроцесс.иж_ПриемкаТоваров.Форма.ФормаАктПриемки", ПараметрыФормы);
			КонецЕсли;
		Иначе 
			ПараметрыФормы = Новый Структура("Контрагент", Объект.Контрагент);
			Заказ = ОткрытьФормуМодально("Обработка.Izh_ПриемкаТоваров.Форма.ФормаПП", ПараметрыФормы);
			//П = Новый Структура("Отбор",Новый Структура("Контрагент", Объект.Контрагент)); 
			//Заказ = ОткрытьФормуМодально("Документ.ПланируемаяПоставка.ФормаВыбора",П);
			Если НЕ ЗначениеЗаполнено(Заказ) Тогда 
				Возврат;
			КонецЕсли;
			Форма = ПолучитьФорму("Обработка.Izh_ПриемкаТоваров.Форма.ФормаПН");
			ДанныеФормы = Форма.Объект; 
			Заполнить(ДанныеФормы, Объект.Контрагент, Заказ);
			КопироватьДанныеФормы(ДанныеФормы, Форма.Объект); 
			Если Форма.ОткрытьМодально() = КодВозвратаДиалога.ОК Тогда 
				ДанныеФормы2 = Форма.Объект; 
				бп = СоздатьПН(ДанныеФормы2,Заказ);
				ПараметрыФормы = Новый Структура("Ключ", бп );
				ОткрытьФорму("БизнесПроцесс.иж_ПриемкаТоваров.Форма.ФормаАктПриемки", ПараметрыФормы);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция РазрешенаПрямаяПоставка(Кон)
	Возврат Кон.РазрешенаПрямаяПоставка;
КонецФункции

&НаСервере
Процедура Заполнить(ДанныеФормы, Контрагент, Заказ = Неопределено)
	Объект1 = ДанныеФормыВЗначение(ДанныеФормы, Тип("ОбработкаОбъект.Izh_ПриемкаТоваров")); 
	Объект1.Контрагент = Контрагент; 
	Объект1.Склад = ПараметрыСеанса.ТекущаяСтруктурнаяЕдиница.СкладТорговогоЗала;
	Если ЗначениеЗаполнено(Заказ) Тогда
		Объект1.Фирма = Заказ.Фирма;
		Объект1.Состав.Загрузить(Заказ.Состав.Выгрузить());	
	Иначе
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ 
		|	СвязьФирмИКонтрагентов.Фирма
		|ИЗ
		|	РегистрСведений.СвязьФирмИКонтрагентов КАК СвязьФирмИКонтрагентов
		|ГДЕ
		|	СвязьФирмИКонтрагентов.Контрагент = &Контрагент";
		Запрос.УстановитьПараметр("Контрагент", Контрагент);
		Результат = Запрос.Выполнить();
		ВыборкаДетальныеЗаписи = Результат.Выбрать();
		Если ВыборкаДетальныеЗаписи.Количество()=1 Тогда 
			ВыборкаДетальныеЗаписи.Следующий();
			Объект1.Фирма = ВыборкаДетальныеЗаписи.Фирма;
		КонецЕсли;
	КонецЕсли;
	ЗначениеВДанныеФормы(Объект1,ДанныеФормы); 
КонецПроцедуры

&НаСервере
Функция СоздатьПН(ДанныеФормы, Заказ = Неопределено)
	Док = Документы.ПриходнаяНакладная.СоздатьДокумент();
	Док.Фирма = ДанныеФормы.Фирма;
	Док.ДокОснование = Заказ; 
	Док.Контрагент = ДанныеФормы.Контрагент;
	Док.Склад = ДанныеФормы.Склад;
	Док.СтруктурнаяЕдиница = ДанныеФормы.Склад.Владелец;
	Док.ИнициализироватьДокумент();
	Док.ТипДоговора = Перечисления.ТипыДоговоров.КупляПродажа; 
	тз = ДанныеФормы.Состав.Выгрузить();
	тз.Колонки.Удалить("КоличествоПоДокументу");
	Док.Состав.Загрузить(тз);
	Для Каждого Строка Из Док.Состав Цикл
		Строка.Коэффициент = Строка.ЕдиницаИзмерения.Коэффициент;
		//++БИТ БВО 2015-09-30 - 0000140081 Необходимо брать цену протокола на дату создания документа.
		ЗапросЦены = Новый Запрос;
		ЗапросЦены.Текст = "ВЫБРАТЬ
		|	НоменклатураКонтрагента.Цена
		|ИЗ
		|	РегистрСведений.НоменклатураКонтрагента КАК НоменклатураКонтрагента
		|ГДЕ
		|	НоменклатураКонтрагента.Контрагент = &Контрагент
		|	И НоменклатураКонтрагента.Номенклатура = &Номенклатура";
		ЗапросЦены.УстановитьПараметр("Контрагент"	, ДанныеФормы.Контрагент);
		ЗапросЦены.УстановитьПараметр("Номенклатура", Строка.Номенклатура);
		Выборка = ЗапросЦены.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			Строка.Цена = Выборка.Цена;			
			Izh_ОбработкаТабличныхЧастейКлиентСервер.РассчитатьСуммуВСтрокеТабличнойЧасти(Строка);
		КонецЕсли;		
		//--БИТ БВО 2015-09-30 - 0000140081 Необходимо брать цену протокола на дату создания документа.
	КонецЦикла;
	Док.Дата = ТекущаяДата();
	Док.Автор = ПараметрыСеанса.ТекущийПользователь;
	
	Док.Записать();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	ЗадачаИсполнителя.Ссылка
	|ИЗ
	|	Задача.ЗадачаИсполнителя КАК ЗадачаИсполнителя
	|ГДЕ
	|	ЗадачаИсполнителя.БизнесПроцесс = &БизнесПроцесс";
	Запрос.УстановитьПараметр("БизнесПроцесс",БизнесПроцессы.иж_ПриемкаТоваров.НайтиПоРеквизиту("Основание", Док.Ссылка));
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда 
		Возврат Выборка.Ссылка;
	КонецЕсли;
КонецФункции

&НаСервере
Процедура ЕстьЗадачиПриемки(Контрагент)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЗадачаИсполнителя.Ссылка,
	               |	ЗадачаИсполнителя.БизнесПроцесс.НомерВходящейНакладной КАК Номер,
	               |	ЗадачаИсполнителя.БизнесПроцесс.ДатаВходящейНакладной КАК Дата
	               |ИЗ
	               |	Задача.ЗадачаИсполнителя КАК ЗадачаИсполнителя
	               |ГДЕ
	               |	НЕ ЗадачаИсполнителя.Выполнена
	               |	И ЗадачаИсполнителя.БизнесПроцесс ССЫЛКА БизнесПроцесс.иж_ПриемкаТоваров
	               |	И ЗадачаИсполнителя.БизнесПроцесс.Основание.Контрагент = &Контрагент";
	Запрос.УстановитьПараметр("Контрагент",Контрагент);
	Результат = Запрос.Выполнить().Выбрать();
	Пока Результат.Следующий() Цикл
		НоваяСтрока = Объект.Задачи.Добавить();
		НоваяСтрока.Задача = Результат.Ссылка;
		НоваяСтрока.Номер = Результат.Номер;
		НоваяСтрока.Дата = Результат.Дата;
	КонецЦикла;
КонецПроцедуры
