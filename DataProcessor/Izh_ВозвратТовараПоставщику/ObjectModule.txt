Функция ПолучитьПодчиненныеДокументы(Ссылка, ТаблицаДокументов, НачальныйДокумент) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	СтруктураПодчиненности.Ссылка
	|ИЗ
	|	КритерийОтбора.СтруктураПодчиненности(&Ссылка) КАК СтруктураПодчиненности
	|ГДЕ
	|	(СтруктураПодчиненности.Ссылка ССЫЛКА Документ.КорректировкаПоступления
	|			ИЛИ СтруктураПодчиненности.Ссылка ССЫЛКА Документ.КорректировкаРеализации	
	|			ИЛИ СтруктураПодчиненности.Ссылка ССЫЛКА Документ.РасходнаяНакладная
	|			ИЛИ СтруктураПодчиненности.Ссылка ССЫЛКА Документ.КоррекцияЗапасов)	
	|	И СтруктураПодчиненности.Ссылка.Проведен = ИСТИНА";
	Запрос.УстановитьПараметр("Ссылка"			, Ссылка);	
	Запрос.УстановитьПараметр("ДокПриходная"	, НачальныйДокумент);
	Запрос.УстановитьПараметр("ФирмаПолучатель"	, НачальныйДокумент.Фирма);
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Возврат Ложь; //Когда нет подчиненных документов
	КонецЕсли;	
	
	Выборка = РезультатЗапроса.Выбрать();		
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = ТаблицаДокументов.Добавить();		
		НоваяСтрока.Ссылка			= Выборка.Ссылка;
		НоваяСтрока.ТипДокумента	= ТипЗнч(Выборка.Ссылка);
		НоваяСтрока.ДокОснование	= НачальныйДокумент;
		
		ЕстьПодчиненныеДокументы = ПолучитьПодчиненныеДокументы(Выборка.Ссылка, ТаблицаДокументов, НачальныйДокумент);
		НоваяСтрока.ПоследнийДокВЦепочке = НЕ ЕстьПодчиненныеДокументы;		
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

Процедура ПолучитьКонечныеОстаткиПоДокументу(ДокументПриходная, ТаблицаДокументов, ТаблицаОстатков, МассивФильтруемойНоменклатуры = Неопределено) Экспорт

	НоваяСтрока = ТаблицаДокументов.Добавить();		
	НоваяСтрока.Ссылка			= ДокументПриходная;
	НоваяСтрока.ТипДокумента	= ТипЗнч(ДокументПриходная);
	НоваяСтрока.ДокОснование	= ДокументПриходная;
	НоваяСтрока.ПоследнийДокВЦепочке = Ложь;
	//Получение всех подчиненных документов для расчета остатка по кличеству и изменений по реквизитам
	ЕстьПодчиненныеДокументы = ПолучитьПодчиненныеДокументы(ДокументПриходная, ТаблицаДокументов, ДокументПриходная);
				
	Если ТаблицаДокументов.Количество() > 0 Тогда
		МассивНоменклатуры = МассивФильтруемойНоменклатуры;
		//Все подчиненные документы - во временную таблицу
		Запрос = Новый Запрос;
		Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
		Запрос.Текст = "ВЫБРАТЬ			
		|	ТЗ.Ссылка,		
		|	ТЗ.ДокОснование,
		|	ТЗ.ПоследнийДокВЦепочке
		|ПОМЕСТИТЬ ВТТаблицаДокументов
		|ИЗ
		|	&ТЗ КАК ТЗ";
		Запрос.УстановитьПараметр("ТЗ", ТаблицаДокументов);
		Запрос.Выполнить();
		//Нужна последняя по дате корретировка поступления, чтобы из нее взять Количество, Цену и Ставку НДС
		Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
		|	ВТТаблицаДокументов.Ссылка.МоментВремени КАК МоментВремени,
		|	ВТТаблицаДокументов.Ссылка,
		|	ВТТаблицаДокументов.ДокОснование
		|ПОМЕСТИТЬ ВТПоследнееПоступлениеСУчетомКорректировки
		|ИЗ
		|	ВТТаблицаДокументов КАК ВТТаблицаДокументов
		|ГДЕ
		|	(ВТТаблицаДокументов.Ссылка ССЫЛКА Документ.КорректировкаПоступления
		|			ИЛИ ВТТаблицаДокументов.Ссылка ССЫЛКА Документ.ПриходнаяНакладная)
		|
		|УПОРЯДОЧИТЬ ПО
		|	МоментВремени УБЫВ";
		Запрос.Выполнить();
		//Еще нужны все расходные накладные (без корретировок) и корректировки расх. накл. для последующего уменьшения количества прихода 
		Запрос.Текст = "ВЫБРАТЬ
		|	ВТТаблицаДокументов.ДокОснование,
		|	ВТТаблицаДокументов.Ссылка
		|ПОМЕСТИТЬ ВТРасходныеНакладные
		|ИЗ
		|	ВТТаблицаДокументов КАК ВТТаблицаДокументов
		|ГДЕ
		|	(ВТТаблицаДокументов.Ссылка ССЫЛКА Документ.КорректировкаРеализации
		|			ИЛИ ВТТаблицаДокументов.Ссылка ССЫЛКА Документ.РасходнаяНакладная)
		|	И ВТТаблицаДокументов.ПоследнийДокВЦепочке = ИСТИНА
		|";
		Запрос.Выполнить();
		//Необходимо поместить все временные таблицы для получения остатка по количеству, итоговых цен и ставок НДС.
		Запрос.Текст = "ВЫБРАТЬ
		|	ВТДокиПрихода.ДокОснование КАК Документ,
		|	ПриходСостав.Номенклатура КАК Номенклатура,
		|	ПриходСостав.Количество КАК Количество,
		|	ПриходСостав.Цена КАК Цена,
		|	ПриходСостав.СтавкаНДС КАК СтавкаНДС
		|ПОМЕСТИТЬ ВТДвиженияНоменклатуры
		|ИЗ
		|	Документ.ПриходнаяНакладная.Состав КАК ПриходСостав
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПоследнееПоступлениеСУчетомКорректировки КАК ВТДокиПрихода
		|		ПО ПриходСостав.Ссылка = ВТДокиПрихода.Ссылка
		|ГДЕ
		|	ИСТИНА
		|	//ОтборПоНоменклатуреПриход
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТДокиПрихода.ДокОснование,
		|	ПриходСостав.Номенклатура,
		|	ПриходСостав.Количество,
		|	ПриходСостав.Цена,
		|	ПриходСостав.СтавкаНДС
		|ИЗ
		|	Документ.КорректировкаПоступления.Состав КАК ПриходСостав
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТПоследнееПоступлениеСУчетомКорректировки КАК ВТДокиПрихода
		|		ПО ПриходСостав.Ссылка = ВТДокиПрихода.Ссылка
		|ГДЕ
		|	ИСТИНА
		|	//ОтборПоНоменклатуреПриход
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТРасходныеНакладные.ДокОснование,
		|	РасходСостав.Номенклатура,
		|	-РасходСостав.Количество,
		|	NULL,
		|	NULL
		|ИЗ
		|	Документ.РасходнаяНакладная.Состав КАК РасходСостав
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТРасходныеНакладные КАК ВТРасходныеНакладные
		|		ПО РасходСостав.Ссылка = ВТРасходныеНакладные.Ссылка
		|ГДЕ
		|	ИСТИНА
		|	//ОтборПоНоменклатуреРасход
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТРасходныеНакладные.ДокОснование,			
		|	РасходСостав.Номенклатура,
		|	-РасходСостав.Количество,
		|	NULL,
		|	NULL
		|ИЗ
		|	Документ.КорректировкаРеализации.Состав КАК РасходСостав
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТРасходныеНакладные КАК ВТРасходныеНакладные
		|		ПО РасходСостав.Ссылка = ВТРасходныеНакладные.Ссылка
		|ГДЕ
		|	ИСТИНА
		|	//ОтборПоНоменклатуреРасход
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТРасходныеНакладные.ДокОснование,
		|	РасходСостав.Номенклатура,
		|	-РасходСостав.Количество,
		|	NULL,
		|	NULL
		|ИЗ
		|	Документ.ПередачаТоваровМеждуФирмами.Состав КАК РасходСостав		
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТРасходныеНакладные КАК ВТРасходныеНакладные
		|		ПО РасходСостав.Ссылка = ВТРасходныеНакладные.Ссылка	  	
		|ГДЕ
		|	ИСТИНА
		|	//ОтборПоНоменклатуреРасход
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТРасходныеНакладные.ДокОснование,
		|	РасходСостав.Номенклатура,
		|	-РасходСостав.Количество,
		|	NULL,
		|	NULL
		|ИЗ
		|	Документ.КоррекцияЗапасов.Состав КАК РасходСостав		
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТРасходныеНакладные КАК ВТРасходныеНакладные
		|		ПО РасходСостав.Ссылка = ВТРасходныеНакладные.Ссылка	  	
		|ГДЕ
		|	РасходСостав.Ссылка.ВидСписания = &ВидСписанияКоррекцииЗапасов
		|	//ОтборПоНоменклатуреРасход
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТДвиженияНоменклатуры.Документ,
		|	ВТДвиженияНоменклатуры.Номенклатура,
		|	СУММА(ВТДвиженияНоменклатуры.Количество) КАК КоличествоОстаток,
		|	СУММА(ВТДвиженияНоменклатуры.Количество) КАК Количество,
		|	МАКСИМУМ(ВТДвиженияНоменклатуры.Цена) КАК Цена,
		|	МАКСИМУМ(ВТДвиженияНоменклатуры.СтавкаНДС) КАК СтавкаНДС		
		|ИЗ
		|	ВТДвиженияНоменклатуры КАК ВТДвиженияНоменклатуры
		|
		|СГРУППИРОВАТЬ ПО
		|	ВТДвиженияНоменклатуры.Документ,
		|	ВТДвиженияНоменклатуры.Номенклатура";		
		Запрос.УстановитьПараметр("МассивНоменклатуры"			, МассивНоменклатуры);		
		Запрос.УстановитьПараметр("ВидСписанияКоррекцииЗапасов"	, Справочники.ВидыСписания.НайтиПоНаименованию("СписаниеЗаСчетПоставщика"));
		Если ЗначениеЗаполнено(МассивНоменклатуры) Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ОтборПоНоменклатуреРасход", "И РасходСостав.Номенклатура В (&МассивНоменклатуры)");
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ОтборПоНоменклатуреПриход", "И ПриходСостав.Номенклатура В (&МассивНоменклатуры)");
		КонецЕсли;
		
		РезультатЗапроса = Запрос.Выполнить();
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл
			Если Выборка.Количество > 0 Тогда
				НС = ТаблицаОстатков.Добавить();
				ЗаполнитьЗначенияСвойств(НС, Выборка);				
			КонецЕсли;
		КонецЦикла;						
	КонецЕсли;
	
КонецПроцедуры