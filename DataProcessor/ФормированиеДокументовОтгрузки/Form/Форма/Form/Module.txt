
&НаКлиенте
Процедура Заполнить(Команда)
	Объект.Состав.Очистить();
	ЗаполнитьНаСервере();
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНаСервере()
	Если Объект.ФильтрКонтрагенты = Ложь И Объект.ФильтрСтруктурныеЕдиницы = Ложь Тогда 
    	Возврат;
	КонецЕсли;	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВнешнийЗаказ.Номенклатура КАК Номенклатура,
	|	ВнешнийЗаказ.Контрагент КАК Контрагент,
	|	СУММА(ВнешнийЗаказ.Количество) КАК Заказано,
	|	СУММА(ОстаткиНоменклатурыОстатки.КоличествоОстаток) КАК Остаток,
	|	0 КАК КОтгрузке,
	|	ЕдиницыИзмерения.Ссылка КАК ЕдиницаИзмерения,
	|	ЕдиницыИзмерения.Коэффициент КАК Коэффициент,
	|	ОстаткиНоменклатуры.Количество КАК УжеОтгружено,
	|	ЦеныНоменклатуры.Цена,
	|	ВнешнийЗаказ.Регистратор.Дата КАК ДатаЗаказа,
	|	ВнешнийЗаказ.ПоДокументу КАК ПоДокументу
	|ИЗ
	|	РегистрСведений.ВнешнийЗаказ КАК ВнешнийЗаказ
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЕдиницыИзмерения КАК ЕдиницыИзмерения
	|		ПО ВнешнийЗаказ.Номенклатура = ЕдиницыИзмерения.Владелец
	|			И ВнешнийЗаказ.Номенклатура.БазоваяЕдиницаИзмерения = ЕдиницыИзмерения.ЕдиницаПоКлассификатору
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры.Остатки(&Момент, МестоХранения = &СкладГП) КАК ОстаткиНоменклатурыОстатки
	|		ПО ВнешнийЗаказ.Номенклатура = ОстаткиНоменклатурыОстатки.Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры КАК ОстаткиНоменклатуры
	|		ПО ВнешнийЗаказ.Номенклатура = ОстаткиНоменклатуры.Номенклатура
	|			И ВнешнийЗаказ.Контрагент = ОстаткиНоменклатуры.Регистратор.Контрагент
	|			И ВнешнийЗаказ.ПоДокументу = ОстаткиНоменклатуры.Регистратор.ДокОснование
	|			И (ОстаткиНоменклатуры.ВидДвижения = &ВидДвижения)
	//|			И (ОстаткиНоменклатуры.Период МЕЖДУ &ДатаНачала И &ДатаКонца)
	//|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&Момент, ) КАК ЦеныНоменклатуры
	//|		ПО ВнешнийЗаказ.Номенклатура = ЦеныНоменклатуры.Номенклатура
	//|			И (ЦеныНоменклатуры.АктивностьЗаписи)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказВнешний.Состав КАК ЦеныНоменклатуры
	|		ПО ВнешнийЗаказ.Номенклатура = ЦеныНоменклатуры.Номенклатура
	|			И ВнешнийЗаказ.ПоДокументу = ЦеныНоменклатуры.Ссылка
	|ГДЕ
	|	ВнешнийЗаказ.ДатаПоставки = &ДатаНачала
	|	И ВнешнийЗаказ.Склад = &Склад";
	Если Объект.ФильтрКонтрагенты И Объект.ФильтрСтруктурныеЕдиницы = Ложь Тогда 
		Запрос.Текст = Запрос.Текст + "
		|		И ТИПЗНАЧЕНИЯ(ВнешнийЗаказ.Контрагент) = ТИП(Справочник.Контрагенты)";
	ИначеЕсли Объект.ФильтрКонтрагенты = Ложь И Объект.ФильтрСтруктурныеЕдиницы Тогда 
		Запрос.Текст = Запрос.Текст + "
		|		И ТИПЗНАЧЕНИЯ(ВнешнийЗаказ.Контрагент) = ТИП(Справочник.СтруктурныеЕдиницы)";
	КонецЕсли;
	Запрос.Текст = Запрос.Текст + "
	|
	|СГРУППИРОВАТЬ ПО
	|	ВнешнийЗаказ.Номенклатура,
	|	ВнешнийЗаказ.Контрагент,
	|	ЕдиницыИзмерения.Ссылка,
	|	ЕдиницыИзмерения.Коэффициент,
	|	ОстаткиНоменклатуры.Количество,
	|	ЦеныНоменклатуры.Цена,
	|	ВнешнийЗаказ.Регистратор.Дата,
	|	ВнешнийЗаказ.ПоДокументу";
	Если Объект.ВидГруппировки = 0 Тогда
		Запрос.Текст = Запрос.Текст + "
		|ИТОГИ
		|	СУММА(Заказано),
		|	МАКСИМУМ(Остаток),
		|	МАКСИМУМ(ЕдиницаИзмерения),
		|	МАКСИМУМ(Коэффициент)
		|ПО
		|	Номенклатура";
	Иначе
		Запрос.Текст = Запрос.Текст + "
		|ИТОГИ
		|	СУММА(КОтгрузке)
		|ПО
		|	Контрагент";
	КонецЕсли;	
	
	Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(Объект.ДатаОтгрузки));
	Запрос.УстановитьПараметр("ДатаКонца", КонецДня(Объект.ДатаОтгрузки));
	Запрос.УстановитьПараметр("Момент", Новый МоментВремени(Объект.ДатаОтгрузки));
	Запрос.УстановитьПараметр("Склад", Объект.Склад);
	Запрос.УстановитьПараметр("СкладГП", Объект.СкладГотовойПродукции);
	Запрос.УстановитьПараметр("ВидДвижения", ВидДвиженияНакопления.Расход);
	Запрос.УстановитьПараметр("ФлагСтруктурнаяЕдиница", Объект.ФильтрСтруктурныеЕдиницы);

	Результат = Запрос.Выполнить();

	//Элементы.ДеревоНоменклатуры.ПодчиненныеЭлементы.ДеревоНоменклатурыНоменклатура.Видимость = Объект.ВидГруппировки = 0;
	//Элементы.ДеревоНоменклатуры.ПодчиненныеЭлементы.ДеревоНоменклатурыНоменклатура1.Видимость = Объект.ВидГруппировки = 1;
	
	Дерево = Результат.Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкам);
	ЗначениеВДанныеФормы(Дерево, ДеревоНоменклатуры);
	Элементы.ФормаОформитьДокументы.Доступность = ДеревоНоменклатуры.ПолучитьЭлементы().Количество()>0 И ЗначениеЗаполнено(Объект.Фирма);
	Элементы.ФормаОформитьДокументы.КнопкаПоУмолчанию = ДеревоНоменклатуры.ПолучитьЭлементы().Количество()>0;
	//Элементы.ФормаЗаполнить.Доступность = НЕ Элементы.ФормаОформитьДокументы.КнопкаПоУмолчанию;
	
	
	Если Объект.Состав.Количество() = 0 Тогда
		ВыборкаПервыйУровень = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		Пока ВыборкаПервыйУровень.Следующий() Цикл
			ВыборкаВторойУровень = ВыборкаПервыйУровень.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			Пока ВыборкаВторойУровень.Следующий() Цикл
				НоваяСтрока = Объект.Состав.Добавить();
				ЗаполнитьЗначенияСвойств(НоваяСтрока,ВыборкаВторойУровень);
				НоваяСтрока.ТипКонтрагента = Строка(ТипЗнч(НоваяСтрока.Контрагент));
			КонецЦикла;	
		КонецЦикла;
	КонецЕсли;
	КолонкиСортировки = "";
	Для Каждого Строка Из Объект.ПараметрыЗаполнения Цикл
		Если Строка.Флаг Тогда
			Если Строка.Сортировка = "По убыванию" Тогда
				Направление = "Убыв";
			Иначе
				Направление = "Возр";
			КонецЕсли;	
			КолонкиСортировки = КолонкиСортировки + Строка.Значение+" "+Направление+",";	
		КонецЕсли;	
	КонецЦикла;
	ТаблицаОстатков = Объект.Состав.Выгрузить(,"Номенклатура,Остаток");
	ТаблицаОстатков.Свернуть("Номенклатура,Остаток",);
	Если КолонкиСортировки <> "" Тогда
		Объект.Состав.Сортировать(КолонкиСортировки);
	КонецЕсли;	
	Для Каждого Строка Из Объект.Состав Цикл
		НайденнаяСтрока = ТаблицаОстатков.Найти(Строка.Номенклатура,"Номенклатура");
		Потребность = ?(Строка.Заказано-Строка.УжеОтгружено<0,0,Строка.Заказано-Строка.УжеОтгружено);
		Строка.КОтгрузке = Мин(НайденнаяСтрока.Остаток,Потребность);
		НайденнаяСтрока.Остаток = НайденнаяСтрока.Остаток - Строка.КОтгрузке;
	КонецЦикла;	
	
	Отбор = Новый Структура;
	Для Каждого ВыборкаПервыйУровень Из ДеревоНоменклатуры.ПолучитьЭлементы() Цикл
		ИтогоКОтгрузке = 0;
		Для Каждого ВыборкаВторойУровень Из ВыборкаПервыйУровень.ПолучитьЭлементы() Цикл
			Отбор.Вставить("Контрагент",ВыборкаВторойУровень.Контрагент);
			Отбор.Вставить("Номенклатура",ВыборкаВторойУровень.Номенклатура);
			Отбор.Вставить("ПоДокументу",ВыборкаВторойУровень.ПоДокументу);
			Массив = Объект.Состав.НайтиСтроки(Отбор);
			Если Массив.Количество()>0 Тогда
				ВыборкаВторойУровень.КОтгрузке = Массив[0].КОтгрузке;
			КонецЕсли;	
			ИтогоКОтгрузке = ИтогоКОтгрузке + ВыборкаВторойУровень.КОтгрузке;
		КонецЦикла;	
		ВыборкаПервыйУровень.КОтгрузке = ИтогоКОтгрузке;
	КонецЦикла;
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Объект.ДатаОтгрузки = ТекущаяДата();
	Объект.ФильтрКонтрагенты = Истина;
	Объект.ФильтрСтруктурныеЕдиницы = Истина;
	
	НоваяСтрока = Объект.ПараметрыЗаполнения.Добавить();
	НоваяСтрока.Наименование = "По типу контрагента";
	НоваяСтрока.Значение = "ТипКонтрагента";
	НоваяСтрока.Сортировка = "По возрастанию";
	НоваяСтрока = Объект.ПараметрыЗаполнения.Добавить();
	НоваяСтрока.Наименование = "По времени заказа";
	НоваяСтрока.Значение = "ДатаЗаказа";
	НоваяСтрока.Сортировка = "По возрастанию";
КонецПроцедуры

&НаКлиенте
Процедура СкладПриИзменении(Элемент)
	Элементы.ФормаЗаполнить.Доступность = ЗначениеЗаполнено(Объект.Склад) И ЗначениеЗаполнено(Объект.ДатаОтгрузки) И ЗначениеЗаполнено(Объект.СкладГотовойПродукции);
КонецПроцедуры

&НаКлиенте
Процедура ОформитьДокументы(Команда)
	Если Вопрос("Оформление документов. Продолжить?",РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;	
	КоличествоДокументов = ОформитьНаСервере();
	Если КоличествоДокументов <> 0 Тогда 		
		Состояние("Оформлено документов - "+КоличествоДокументов,,,);
    КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ВидГруппировкиПриИзменении(Элемент)
	Элементы.ДеревоНоменклатуры.ПодчиненныеЭлементы.ДеревоНоменклатурыНоменклатура.Видимость = Объект.ВидГруппировки = 0;
	Элементы.ДеревоНоменклатуры.ПодчиненныеЭлементы.ДеревоНоменклатурыНоменклатура1.Видимость = Объект.ВидГруппировки = 1;
	ЗаполнитьНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ДеревоНоменклатурыПередНачаломИзменения(Элемент, Отказ)
	Отказ = Элементы.ДеревоНоменклатуры.ТекущиеДанные.ПолучитьРодителя() = Неопределено;
КонецПроцедуры

&НаКлиенте
Процедура ДеревоНоменклатурыКОтпускуПриИзменении(Элемент)
	Отбор = Новый Структура;
	Отбор.Вставить("Контрагент",Элементы.ДеревоНоменклатуры.ТекущиеДанные.Контрагент);
	Отбор.Вставить("Номенклатура",Элементы.ДеревоНоменклатуры.ТекущиеДанные.Номенклатура);
	Отбор.Вставить("ПоДокументу",Элементы.ДеревоНоменклатуры.ТекущиеДанные.ПоДокументу);
	Массив = Объект.Состав.НайтиСтроки(Отбор);
	Если Массив.Количество()>0 Тогда
		Массив[0].КОтгрузке = Элементы.ДеревоНоменклатуры.ТекущиеДанные.КОтгрузке;
	КонецЕсли;	
	Если Объект.ВидГруппировки = 0 Тогда
		СтрокаРодителя = Элементы.ДеревоНоменклатуры.ТекущиеДанные.ПолучитьРодителя();
		ИтогКОтгрузке = 0;
		Для Каждого Строка Из СтрокаРодителя.ПолучитьЭлементы() Цикл
			ИтогКОтгрузке = ИтогКОтгрузке + Строка.КОтгрузке;
		КонецЦикла;	
		СтрокаРодителя.КОтгрузке = ИтогКОтгрузке;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция ОформитьНаСервере()
	Попытка
		НачатьТранзакцию();
		Объект.Состав.Сортировать("ПоДокументу Возр");
		ПоДокументу = "";
		НовыйДок = "";
		КоличествоДокументов = 0;
		Для Каждого Строка Из Объект.Состав Цикл
			Если Строка.КОтгрузке = 0 Тогда
				Продолжить;
			КонецЕсли;	
			Если ПоДокументу <> Строка.ПоДокументу Тогда
				Если НовыйДок <> "" Тогда
					НовыйДок.Записать(РежимЗаписиДокумента.Запись);
					КоличествоДокументов = КоличествоДокументов + 1;
				КонецЕсли;	
				ПоДокументу = Строка.ПоДокументу;
				НовыйДок = Документы.РасходнаяНакладная.СоздатьДокумент();
				НовыйДок.Контрагент = Строка.Контрагент;
				НовыйДок.Склад = Объект.СкладГотовойПродукции;
				НовыйДок.Фирма = Объект.Фирма;
				НовыйДок.Дата = Объект.ДатаОтгрузки;
				НовыйДок.ДокОснование = Строка.ПоДокументу;
				НовыйДок.ИнициализироватьДокумент();
			КонецЕсли;
			НоваяСтрока = НовыйДок.Состав.Добавить();
			НоваяСтрока.Номенклатура = Строка.Номенклатура;
			НоваяСтрока.ЕдиницаИзмерения = Строка.ЕдиницаИзмерения;
			НоваяСтрока.Коэффициент = Строка.Коэффициент;
			НоваяСтрока.Количество = Строка.КОтгрузке;
			НоваяСтрока.Цена = Строка.Цена;
			НоваяСтрока.СтавкаНДС = ?(ЗначениеЗаполнено(Строка.Номенклатура.СтавкаНДС),Строка.Номенклатура.СтавкаНДС,Справочники.СтавкиНДС.БезНДС);
			НоваяСтрока.Сумма = Окр(НоваяСтрока.Количество * НоваяСтрока.Цена,2);
			СтавкаНДС = ОбщегоНазначенияСервер.ПолучитьСтавкуНДС(НоваяСтрока.СтавкаНДС);
			НоваяСтрока.СуммаНДС = Окр(СтавкаНДС * НоваяСтрока.Сумма / (100 + СтавкаНДС),2);
		КонецЦикла;	
		Если НовыйДок <> "" Тогда
			НовыйДок.Записать(РежимЗаписиДокумента.Запись);
			КоличествоДокументов = КоличествоДокументов + 1;
		КонецЕсли;	
		ЗафиксироватьТранзакцию();
		Объект.Состав.Очистить();
		ДеревоНоменклатуры.ПолучитьЭлементы().Очистить();
		Элементы.ФормаОформитьДокументы.Доступность = Ложь;
	Исключение
		ОтменитьТранзакцию();
		КоличествоДокументов = 0;
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
	КонецПопытки;	
	Возврат КоличествоДокументов;
КонецФункции

&НаКлиенте
Процедура ПриЗакрытии()
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	Элементы.ФормаЗаполнить.Доступность = ЗначениеЗаполнено(Объект.Склад) И ЗначениеЗаполнено(Объект.ДатаОтгрузки) И ЗначениеЗаполнено(Объект.СкладГотовойПродукции);
	Элементы.ФормаОформитьДокументы.Доступность = ДеревоНоменклатуры.ПолучитьЭлементы().Количество()>0 И ЗначениеЗаполнено(Объект.Фирма);
КонецПроцедуры


&НаКлиенте
Процедура ЗаполнитьПоЗаказам(Команда)
	Для Каждого Строка Из Объект.Состав Цикл
		Строка.КОтгрузке = Строка.Заказано;
	КонецЦикла;	
	Отбор = Новый Структура;
	Для Каждого ВыборкаПервыйУровень Из ДеревоНоменклатуры.ПолучитьЭлементы() Цикл
		ИтогоКОтгрузке = 0;
		Для Каждого ВыборкаВторойУровень Из ВыборкаПервыйУровень.ПолучитьЭлементы() Цикл
			Отбор.Вставить("Контрагент",ВыборкаВторойУровень.Контрагент);
			Отбор.Вставить("Номенклатура",ВыборкаВторойУровень.Номенклатура);
			Отбор.Вставить("ПоДокументу",ВыборкаВторойУровень.ПоДокументу);
			
			Массив = Объект.Состав.НайтиСтроки(Отбор);
			Если Массив.Количество()>0 Тогда
				ВыборкаВторойУровень.КОтгрузке = Массив[0].КОтгрузке;
			КонецЕсли;	
			ИтогоКОтгрузке = ИтогоКОтгрузке + ВыборкаВторойУровень.КОтгрузке;
		КонецЦикла;	
		ВыборкаПервыйУровень.КОтгрузке = ИтогоКОтгрузке;
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПоОстаткам(Команда)
	Для Каждого Строка Из Объект.Состав Цикл
		Строка.КОтгрузке = Строка.Остаток;
	КонецЦикла;
	Отбор = Новый Структура;
	Для Каждого ВыборкаПервыйУровень Из ДеревоНоменклатуры.ПолучитьЭлементы() Цикл
		ИтогоКОтгрузке = 0;
		Для Каждого ВыборкаВторойУровень Из ВыборкаПервыйУровень.ПолучитьЭлементы() Цикл
			Отбор.Вставить("Контрагент",ВыборкаВторойУровень.Контрагент);
			Отбор.Вставить("Номенклатура",ВыборкаВторойУровень.Номенклатура);
			Отбор.Вставить("ПоДокументу",ВыборкаВторойУровень.ПоДокументу);
			Массив = Объект.Состав.НайтиСтроки(Отбор);
			Если Массив.Количество()>0 Тогда
				ВыборкаВторойУровень.КОтгрузке = Массив[0].КОтгрузке;
			КонецЕсли;	
			ИтогоКОтгрузке = ИтогоКОтгрузке + ВыборкаВторойУровень.КОтгрузке;
		КонецЦикла;	
		ВыборкаПервыйУровень.КОтгрузке = ИтогоКОтгрузке;
	КонецЦикла;
КонецПроцедуры
