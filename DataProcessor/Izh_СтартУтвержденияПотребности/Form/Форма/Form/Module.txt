
&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ЭтаФорма.Закрыть();
	Ответ = Вопрос("Создать Утверждение потребности по сторонним контрагентам?",РежимДиалогаВопрос.ДаНет);
	Если Ответ = КодВозвратаДиалога.Нет Тогда 
		мсв = НайтиБППоСЕ();
		сзБП = Новый СписокЗначений;
		сзБП.ЗагрузитьЗначения(мсв);
		выбБП = сзБП.ВыбратьЭлемент("Выберите Бизнес процесс.");
		Если выбБП <> Неопределено Тогда
			Объект.БизнесПроцесс = НайтиБППоСЕ(выбБП.Значение);
		КонецЕсли;
	ИначеЕсли Ответ = КодВозвратаДиалога.Да Тогда 
		Объект.Контрагент = ОткрытьФормуМодально("Справочник.Контрагенты.ФормаВыбора");
		Если НЕ ЗначениеЗаполнено(Объект.Контрагент) Тогда 
			Возврат;
		КонецЕсли;
		НайтиБП();
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Объект.БизнесПроцесс) ИЛИ ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект.БизнесПроцесс,"ПометкаУдаления")  Тогда 
		Вопрос("У поставщика осутствует бизнес-процесс по формированию заявки!",РежимДиалогаВопрос.ОК);
		Возврат;
	КонецЕсли;
	Если ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Объект.БизнесПроцесс,"Стартован") Тогда
		Вопрос("Данный бизнес-процесс уже стартован!",РежимДиалогаВопрос.ОК);    
		Возврат;
	КонецЕсли;
	Если СегодняСтартовал() Тогда 
		Ответ = Вопрос("По указанному поставщику уже создавалась задача: Утверждение потребности. Создать новую задачу?",РежимДиалогаВопрос.ДаНет);
		Если Ответ = КодВозвратаДиалога.Нет Тогда 
			Возврат;
		КонецЕсли;	
	КонецЕсли;
	АвтоЗаказ.ЗапускБПАвтоЗаказ(Объект.БизнесПроцесс);
КонецПроцедуры

&НаСервере
Процедура НайтиБП()
	Запрос = Новый Запрос;
	ЭтоМагазин = ОбщегоНазначенияСервер.ПолучитьТекущуюСтруктурнуюЕдиницу().ТипСтруктурнойЕдиницы = Перечисления.ТипыСтруктурныхЕдиниц.Магазин;
	Запрос.Текст = "ВЫБРАТЬ
	|	АвтоЗаказ.Ссылка
	|ИЗ
	|	БизнесПроцесс.АвтоЗаказ КАК АвтоЗаказ
	|ГДЕ
	|	АвтоЗаказ.Поставщик = &Контрагент
	|	И НЕ АвтоЗаказ.Завершен"+?(ЭтоМагазин,"
	|	И АвтоЗаказ.Izh_ВариантРасчета = 0","");
	Запрос.УстановитьПараметр("Контрагент", Объект.Контрагент);
	рез = Запрос.Выполнить().Выбрать();
	рез.Следующий();
	Объект.БизнесПроцесс = рез.Ссылка;
КонецПроцедуры

&НаСервере
Функция  НайтиБППоСЕ(Наименование = Неопределено)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	АвтоЗаказ.Ссылка КАК Ссылка,
	|	АвтоЗаказ.Наименование
	|ИЗ
	|	БизнесПроцесс.АвтоЗаказ КАК АвтоЗаказ
	|ГДЕ
	|	АвтоЗаказ.Поставщик ССЫЛКА Справочник.СтруктурныеЕдиницы
	|	И НЕ АвтоЗаказ.Завершен
	|	И ВЫРАЗИТЬ(АвтоЗаказ.Поставщик КАК Справочник.СтруктурныеЕдиницы).ТипСтруктурнойЕдиницы = &ТипСтруктурнойЕдиницыСклад"+?(ЗначениеЗаполнено(Наименование),"
	|	И АвтоЗаказ.Наименование = &Наименование","");
	Запрос.УстановитьПараметр("ТипСтруктурнойЕдиницыСклад", Перечисления.ТипыСтруктурныхЕдиниц.Склад);
	Если ЗначениеЗаполнено(Наименование) Тогда  
		Запрос.УстановитьПараметр("Наименование", Наименование);
		рез = Запрос.Выполнить().Выбрать();
		рез.Следующий();
		Возврат рез.Ссылка;
	Иначе
		тз = Запрос.Выполнить().Выгрузить();
		Возврат тз.ВыгрузитьКолонку("Наименование");
	КонецЕсли;
КонецФункции 

&НаСервере
Функция СегодняСтартовал()
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЗадачаИсполнителя.Ссылка
	               |ИЗ
	               |	Задача.ЗадачаИсполнителя КАК ЗадачаИсполнителя
	               |ГДЕ
	               |	ЗадачаИсполнителя.БизнесПроцесс.Поставщик = &Контрагент
	               |	И НАЧАЛОПЕРИОДА(ЗадачаИсполнителя.Дата, ДЕНЬ) = НАЧАЛОПЕРИОДА(&Дата, ДЕНЬ)";
	Запрос.УстановитьПараметр("Дата",ТекущаяДата());
	Запрос.УстановитьПараметр("Контрагент",Объект.Контрагент);
	рез = Запрос.Выполнить().Выбрать();
	Возврат рез.Количество() > 0;
КонецФункции