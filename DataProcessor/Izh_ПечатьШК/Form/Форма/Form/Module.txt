
&НаКлиенте
Процедура СоставПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	Отказ = Истина;
	Элементы.ПодборНоменклатуры.Видимость = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ЗакрытьПодбор(Команда)
	Элементы.ПодборНоменклатуры.Видимость = Не Элементы.ПодборНоменклатуры.Видимость;
КонецПроцедуры

&НаКлиенте
Процедура ПодборНоменклатурыВыборЗначения(Элемент, Значение, СтандартнаяОбработка)
	Номенклатура = Элемент.ТекущаяСтрока;
	Строки = Объект.Состав.НайтиСтроки(Новый Структура("Номенклатура",Номенклатура)); 
	Если Строки.Количество()=0 Тогда
		стр = Объект.Состав.Добавить();
		стр.Номенклатура = Номенклатура;
		стр.КолЭкз = 1;
		стр.ДатаФасовки = ТекущаяДата();
		ШК = ПолучитьШтрихКод(Номенклатура);
		Если ШК = Истина Тогда 
			Объект.Состав.Удалить(стр);
			Сообщить("Можно выбрать только номенклатуру транзакционного уровня!");
		Иначе стр.ШК = ШК;
		КонецЕсли;
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура ПечатьШК(Команда)
	Отказ = ПроверитьЗаполнение();
	Если НЕ Отказ Тогда Возврат; КонецЕсли;
	Если Объект.ИмяПринтера="" Тогда
		Сообщить("Принтер не выбран");
		Возврат;
	КонецЕсли;

	Док = ПечатьШКСервер();
	Док.Записать(КаталогВременныхФайлов()+"Этикетка.epl","windows-1251");
	//Док.Записать(КаталогВременныхФайлов()+"Этикетка.epl");
	Порт = "";
	Если Найти(Объект.ИмяПринтера,"\\") = 0 Тогда 
		Символ = Прав(Объект.ИмяПринтера,1);
		Если Символ=":" Тогда Объект.ИмяПринтера = Лев(Объект.ИмяПринтера,СтрДлина(Объект.ИмяПринтера)-1) КонецЕсли;
		Позиция=Найти(Объект.ИмяПринтера,"Порт:");
		Порт=Прав(Объект.ИмяПринтера,СтрДлина(Объект.ИмяПринтера)-Позиция-4);
	КонецЕсли;
	КомандаСистемы("copy "+Символ(34)+КаталогВременныхФайлов()+"Этикетка.epl"+Символ(34)+" "+Символ(34)+?(Порт="",Объект.ИмяПринтера,Порт)+Символ(34));
	//КомандаСистемы("copy "+"C:\Этикетка.epl "+СокрЛП(Объект.ИмяПринтера));
	//КомандаСистемы("del "+"C:\Этикетка.epl");
КонецПроцедуры

&НаСервере
Функция ПечатьШКСервер()
	ТабДок = Новый ТекстовыйДокумент;
	СвойствоИнфоОТоваре = ПланыВидовХарактеристик.ДополнительныеРеквизитыНоменклатуры.НайтиПоКоду("1619");
	Для Каждого Этикетка из Объект.Состав Цикл
		А = "N";
		ТабДок.ДобавитьСтроку(А);
		ПолноеНаименование = ФорматированиеСтроки(Этикетка.Номенклатура.ПолноеНаименование);
		ШтрихКод = ПолучитьШтрихКод(Этикетка.Номенклатура);
		Если Объект.ТипЭтикетки="60" Тогда 
			ДопРекИнфоОТоваре = Этикетка.Номенклатура.ДополнительныеРеквизиты.Найти(СвойствоИнфоОТоваре,"Свойство");
			Если ДопРекИнфоОТоваре = Неопределено Тогда Продолжить; КонецЕсли;
			ИнфоОТоваре = ФорматированиеСтроки(ДопРекИнфоОТоваре.Значение);
			
			//Выводим наименование
			Н = 0;
			ПозицияВСтроке = 0;
			Пока Н<>90 Цикл
				ЧислоСимволов = 27;
				Стр = Сред(ПолноеНаименование,ПозицияВСтроке,ЧислоСимволов);
				ПозицияВСтроке = ПозицияВСтроке+ЧислоСимволов+1;
				СтрШК = Стр+" ";
				А = "A0,"+Н+",0,4,1,1,N,"+Символ(34)+СтрШК+Символ(34);
				ТабДок.ДобавитьСтроку(А);
				Н=Н+30;
			КонецЦикла;
			
			//Выводим Инфо о товаре
			ПозицияВСтроке = 0;
			Пока Н<268 Цикл
				ЧислоСимволов = 42;
				СтрШК = Сред(ИнфоОТоваре,ПозицияВСтроке,ЧислоСимволов);
				ПозицияВСтроке = ПозицияВСтроке+ЧислоСимволов+1;
				А = "A0,"+Н+",0,1,1,1,N,"+Символ(34)+СтрШК+Символ(34);
				ТабДок.ДобавитьСтроку(А);
				Н=Н+13;
			КонецЦикла;
			
			//Выводим штрихкод
			А="B0,268,0,E30,2,5,70,B,"+Символ(34)+ШтрихКод+Символ(34);
			ТабДок.ДобавитьСтроку(А);
			
			Если Объект.ВыводитьДатаИзг Тогда 
				А = "A210,268,0,2,1,1,N,"+Символ(34)+"Дата изг.:"+Формат(Этикетка.ДатаИзготовления, "ДФ=dd.MM.yy")+Символ(34);
				ТабДок.ДобавитьСтроку(А);
			КонецЕсли;
			Если Объект.ВыводитьДатаФас Тогда 
				А = "A210,288,0,2,1,1,N,"+Символ(34)+"Дата фас.:"+Формат(Этикетка.ДатаФасовки, "ДФ=dd.MM.yy")+Символ(34);
				ТабДок.ДобавитьСтроку(А);
			КонецЕсли;
			Если Объект.ВыводитьВес Тогда
				Вес = ПолучитьВес(Этикетка.Номенклатура);
				А = "A210,308,0,2,1,1,N,"+Символ(34)+"Вес:"+Вес+"кг"+Символ(34);
				ТабДок.ДобавитьСтроку(А);
			КонецЕсли;
		ИначеЕсли Объект.ТипЭтикетки="30" Тогда 
			//Выводим наименование
			Н = 0;
			ПозицияВСтроке = 0;
			Пока Н<>30 Цикл
				ЧислоСимволов = 23;
				Стр = Сред(ПолноеНаименование,ПозицияВСтроке,ЧислоСимволов);
				ПозицияВСтроке = ПозицияВСтроке+ЧислоСимволов+1;
				СтрШК = Стр+" ";
				А = "A110,"+Н+",0,1,1,1,N,"+Символ(34)+СтрШК+Символ(34);
				ТабДок.ДобавитьСтроку(А);
				Н=Н+15;
			КонецЦикла;
			
			//Пробел между названием и штрихкодом
			А="A115,"+Н+",0,1,1,1,N,"+Символ(34)+Символ(34);
			ТабДок.ДобавитьСтроку(А);
			
			//Выводим штрихкод
			А="B110,45,0,E30,2,5,65,B,"+Символ(34)+ШтрихКод+Символ(34);
			ТабДок.ДобавитьСтроку(А);
			
			Если Объект.ВыводитьДатаФас Тогда 
				А = "A340,35,1,1,1,1,N,"+Символ(34)+Формат(Этикетка.ДатаФасовки, "ДФ=dd.MM.yy")+Символ(34);
				ТабДок.ДобавитьСтроку(А);
			КонецЕсли;
			
		КонецЕсли;
		А = "P"+Этикетка.КолЭкз;
		ТабДок.ДобавитьСтроку(А);
	КонецЦикла;
	Возврат ТабДок;
КонецФункции

&НаСервере
Функция ПолучитьШтрихКод(Данные)
	Если Данные.Группа = 1 Тогда 
		Возврат Истина;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	|	Номенклатура.Ссылка
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.Родитель = &Родитель
	|	И Номенклатура.ФлагОсновногоШК";
	Запрос.УстановитьПараметр("Родитель",Данные);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда 
		Возврат Ложь;
	Иначе Возврат Результат.Выгрузить()[0].Ссылка.Код;
	КонецЕсли;
КонецФункции

&НаСервереБезКонтекста
Функция ФорматированиеСтроки(Строка)
	НоваяСтрока = СтрЗаменить(Строка,"  "," ");
	Если СтрДлина(Строка)=СтрДлина(НоваяСтрока) Тогда 
		Возврат СокрЛП(НоваяСтрока);
	Иначе 
		Возврат ФорматированиеСтроки(НоваяСтрока);
	КонецЕсли;
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьВес(Ном)
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1
	|	МассогабаритныеХарактеристики.Нетто * МассогабаритныеХарактеристики.ЕдиницаВеса.Коэффициент КАК Вес
	|ИЗ
	|	РегистрСведений.МассогабаритныеХарактеристики КАК МассогабаритныеХарактеристики
	|ГДЕ
	|	МассогабаритныеХарактеристики.Номенклатура = &Номенклатура
	|	И МассогабаритныеХарактеристики.ЕдиницаИзмерения = &ЕдиницаИзмерения";
	Запрос.УстановитьПараметр("Номенклатура",Ном);
	Запрос.УстановитьПараметр("ЕдиницаИзмерения",Ном.БазоваяЕдиницаИзмерения);
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда 
		Возврат Строка(0);
	Иначе 
		Возврат Строка(Результат.Выгрузить()[0].Вес);
	КонецЕсли;
КонецФункции

&НаКлиенте
Процедура ИмяПринтераНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	СписокПринтеров = ПолучитьФорму("РегистрСведений.Izh_ПринтерыШК.Форма.ФормаСписка");
	СписокПринтеров.ВладелецФормы = ЭтаФорма;
	СписокПринтеров.ЗакрыватьПриЗакрытииВладельца = Истина;
	СписокПринтеров.ЗакрыватьПриВыборе = Истина;
	Объект.ИмяПринтера = СписокПринтеров.ОткрытьМодально();
	
	Если Объект.ИмяПринтера="" Тогда
		Сообщить("Принтер не выбран");
		Возврат;
	КонецЕсли;
КонецПроцедуры
