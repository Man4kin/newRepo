
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	Результат = ОткрытьФормуМодально("БизнесПроцесс.иж_ПриемкаТоваров.Форма.ФормаВыбораАктаДляКорректировки");
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	СледующаяЗадача = ВыполнитьЗадачу(Результат.Задача);
	Если ЗначениеЗаполнено(СледующаяЗадача) Тогда
		УправлениеБизнесПроцессамиКлиент.ОткрытьФормуВыполненияЗадачи(СледующаяЗадача);
	КонецЕсли;
	
	ОповеститьОбИзменении(Результат.Задача);
	
КонецПроцедуры

&НаСервере
Функция ВыполнитьЗадачу(Знач Задача)
	
	// !!!! efim
	#Если _ Тогда
		Задача = Задачи.ЗадачаИсполнителя.ПустаяСсылка();
	#КонецЕсли
	// !!!!
	
	БП = Задача.БизнесПроцесс.ПолучитьОбъект();
	// !!!! efim
	#Если _ Тогда
		БП = БизнесПроцессы.иж_ПриемкаТоваров.СоздатьБизнесПроцесс();
	#КонецЕсли
	// !!!!
	БП.Корректировка = Истина;
	БП.Записать();
	
	УправлениеБизнесПроцессамиСервер.ВыполнитьЗадачу(Задача);
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("БП", Задача.БизнесПроцесс);
	Запрос.УстановитьПараметр("Исполнитель", Задача.ЗадачуВыполнил);
	Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ЗадачаИсполнителяЗадачиПоИсполнителю.Ссылка
		|ИЗ
		|	Задача.ЗадачаИсполнителя.ЗадачиПоИсполнителю(
		|			&Исполнитель,
		|			НЕ Выполнена
		|				И БизнесПроцесс = &БП) КАК ЗадачаИсполнителяЗадачиПоИсполнителю";
	Результат = Запрос.Выполнить();
	
	Если Результат.Пустой() Тогда
		Возврат Неопределено;
	Иначе
		СледующаяЗадача = Результат.Выбрать();
		СледующаяЗадача.Следующий();
		Возврат СледующаяЗадача.Ссылка;
	КонецЕсли;
	
КонецФункции
