
&НаКлиенте
Процедура СоздатьДокументы(Команда)
	
	Массив = ПолучитьТаблицуФирм();

	й=0;
	Для Каждого СтрокаМассива Из Массив Цикл
		Структура = Массив.Получить(й);
		й=й+1;
		КлючУникальности = Новый УникальныйИдентификатор;
		Форма = ПолучитьФорму("Документ.ИнвентаризацияПоАлкоголю.ФормаОбъекта",,,КлючУникальности);
		ДанныеФормы = Форма.Объект;
		ЗаполнитьДокументНаСервере(ДанныеФормы, Структура.Фирма);
		КопироватьДанныеФормы(ДанныеФормы, Форма.Объект);
		Форма.Открыть();
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция ЗаполнитьДокументНаСервере(ДанныеФормы, Фирма)
	
	Док = ДанныеФормыВЗначение(ДанныеФормы, Тип("ДокументОбъект.ИнвентаризацияПоАлкоголю"));
	Док.Дата = Объект.Дата + 1;
	Док.Фирма = Фирма;
	СтруктурнаяЕдиница = Объект.СтруктурнаяЕдиница;
	Док.СтруктурнаяЕдиница = СтруктурнаяЕдиница;
	Док.ДокОснование = Объект.Ссылка;
	Док.Основание = Объект.Основание;
	Док.Комментарий = Объект.Комментарий;
	
	//получим номенклатуру по данным фирме и складу
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ИнвентаризацияСоставПоФирмам.Номенклатура,
		|	ИнвентаризацияСоставПоФирмам.ЕдиницаИзмерения,
		|	ИнвентаризацияСоставПоФирмам.Количество,
		|	ИнвентаризацияСоставПоФирмам.КоличествоУчет
		|ИЗ
		|	Документ.Инвентаризация.СоставПоФирмам КАК ИнвентаризацияСоставПоФирмам
		|ГДЕ
		|	ИнвентаризацияСоставПоФирмам.Ссылка = &Ссылка
		|	И ИнвентаризацияСоставПоФирмам.Фирма = &Фирма";

	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	Запрос.УстановитьПараметр("Фирма", Фирма);
	
	Результат = Запрос.Выполнить();
	ТаблицаФирмы = Результат.Выгрузить();
	ТаблицаФирмы.Свернуть("Номенклатура"); 
	ТаблицаАлкоголя = УчетАлкогольнойПродукции.ВернутьТаблицуАлкоголя(ТаблицаФирмы);
	
	//получим остатки по регистрам "ОстаткиНоменклатуры" и "УчетАлкоголяПоПроизводителям"
	//и заполним  табличную часть "Состав"
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	врСостав.Номенклатура
	|ПОМЕСТИТЬ врСостав
	|ИЗ
	|	&врСостав КАК врСостав
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВложенныйЗапрос.Номенклатура,
	|	СУММА(ВложенныйЗапрос.КоличествоОстаткиНоменклатуры) КАК Количество,
	|	СУММА(ВложенныйЗапрос.КоличествоУчетАлкоголя) КАК КоличествоУчет
	|ПОМЕСТИТЬ врОстатки
	|ИЗ
	|	(ВЫБРАТЬ
	|		ОстаткиНоменклатурыОстатки.Номенклатура КАК Номенклатура,
	|		ОстаткиНоменклатурыОстатки.КоличествоОстаток КАК КоличествоОстаткиНоменклатуры,
	|		0 КАК КоличествоУчетАлкоголя
	|	ИЗ
	|		РегистрНакопления.ОстаткиНоменклатуры.Остатки(
	|				&Дата,
	|				Номенклатура В
	|						(ВЫБРАТЬ
	|							с.Номенклатура
	|						ИЗ
	|							врСостав КАК с)
	|					И МестоХранения.Владелец = &СтруктурнаяЕдиница
	|					И Фирма = &Фирма) КАК ОстаткиНоменклатурыОстатки
	|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|				НоменклатураДополнительныеРеквизиты.Ссылка КАК Ссылка,
	|				НоменклатураДополнительныеРеквизиты.Значение КАК Значение
	|			ИЗ
	|				Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
	|			ГДЕ
	|				НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоВидАлкогольнойПродукции) КАК ТабВидАлкогольнойПродукции
	|			ПО ОстаткиНоменклатурыОстатки.Номенклатура = ТабВидАлкогольнойПродукции.Ссылка
	|	ГДЕ
	|		НЕ ТабВидАлкогольнойПродукции.Значение ЕСТЬ NULL 
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		УчетАлкоголяПоПроизводителямОстатки.Номенклатура,
	|		0,
	|		УчетАлкоголяПоПроизводителямОстатки.КоличествоОстаток
	|	ИЗ
	|		РегистрНакопления.УчетАлкоголяПоПроизводителям.Остатки(
	|				&Дата,
	|				Номенклатура В
	|						(ВЫБРАТЬ
	|							с.Номенклатура
	|						ИЗ
	|							врСостав КАК с)
	|					И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|					И Фирма = &Фирма) КАК УчетАлкоголяПоПроизводителямОстатки
	|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|				НоменклатураДополнительныеРеквизиты.Ссылка КАК Ссылка,
	|				НоменклатураДополнительныеРеквизиты.Значение КАК Значение
	|			ИЗ
	|				Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
	|			ГДЕ
	|				НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоВидАлкогольнойПродукции) КАК ТабВидАлкогольнойПродукции
	|			ПО УчетАлкоголяПоПроизводителямОстатки.Номенклатура = ТабВидАлкогольнойПродукции.Ссылка
	|	ГДЕ
	|		НЕ ТабВидАлкогольнойПродукции.Значение ЕСТЬ NULL) КАК ВложенныйЗапрос
	|
	|СГРУППИРОВАТЬ ПО
	|	ВложенныйЗапрос.Номенклатура
	|;
	|ВЫБРАТЬ 
	|   врСостав.Номенклатура,
	|	ЕСТЬNULL(врОстатки.Количество,0) КАК Количество,	
	|	ЕСТЬNULL(врОстатки.КоличествоУчет,0) КАК КоличествоУчет,
	|	ЕСТЬNULL(врОстатки.Количество-врОстатки.КоличествоУчет,0) КАК КоличествоРазница
	|ИЗ 
	|	врСостав КАК врСостав
	|	ЛЕВОЕ СОЕДИНЕНИЕ врОстатки 
	|	ПО врСостав.Номенклатура = врОстатки.Номенклатура";
	
	Запрос.УстановитьПараметр("Дата",Док.Дата);
    Запрос.УстановитьПараметр("СвойствоВидАлкогольнойПродукции",ПланыВидовХарактеристик.ДополнительныеРеквизитыНоменклатуры.НайтиПоКоду(ОбщегоНазначения.ПолучитьЗначениеСвойстваСлужебногоЗначения(ПланыВидовХарактеристик.СлужебныеЗначения.КодРеквизитаВидАлкогольнойПродукции)));
	Запрос.УстановитьПараметр("врСостав",ТаблицаАлкоголя);
	Запрос.УстановитьПараметр("Фирма", Фирма);
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СтруктурнаяЕдиница);
	
	РезультатЗапроса = Запрос.Выполнить();
	ТаблицаЗапроса = РезультатЗапроса.Выгрузить();
	Док.Состав.Загрузить(ТаблицаЗапроса);
	
	//получим остатки по регистру "УчетАлкоголяПоПроизводителям"
	//и заполним  табличную часть "Состав по производителям"
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	врСостав.Номенклатура
	|ПОМЕСТИТЬ врСостав
	|ИЗ
	|	&врСостав КАК врСостав
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	УчетАлкоголяПоПроизводителямОстатки.Номенклатура КАК Номенклатура,
	|	УчетАлкоголяПоПроизводителямОстатки.ВидАлкогольнойПродукции КАК ВидАлкогольнойПродукции,
	|	УчетАлкоголяПоПроизводителямОстатки.Производитель КАК Производитель,
	|	УчетАлкоголяПоПроизводителямОстатки.КоличествоОстаток КАК КоличествоУчет,
	|	УчетАлкоголяПоПроизводителямОстатки.КоличествоОстаток КАК Количество
	|ИЗ
	|	РегистрНакопления.УчетАлкоголяПоПроизводителям.Остатки(
	|			&Дата,
	|			Номенклатура В
	|					(ВЫБРАТЬ
	|						с.Номенклатура
	|					ИЗ
	|						врСостав КАК с)
	|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
	|				И Фирма = &Фирма) КАК УчетАлкоголяПоПроизводителямОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			НоменклатураДополнительныеРеквизиты.Ссылка КАК Ссылка,
	|			НоменклатураДополнительныеРеквизиты.Значение КАК Значение
	|		ИЗ
	|			Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
	|		ГДЕ
	|			НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоВидАлкогольнойПродукции) КАК ТабВидАлкогольнойПродукции
	|		ПО УчетАлкоголяПоПроизводителямОстатки.Номенклатура = ТабВидАлкогольнойПродукции.Ссылка
	|ГДЕ
	|	НЕ ТабВидАлкогольнойПродукции.Значение ЕСТЬ NULL";
	
	Запрос.УстановитьПараметр("Дата",Док.Дата);
    Запрос.УстановитьПараметр("СвойствоВидАлкогольнойПродукции",ПланыВидовХарактеристик.ДополнительныеРеквизитыНоменклатуры.НайтиПоКоду(ОбщегоНазначения.ПолучитьЗначениеСвойстваСлужебногоЗначения(ПланыВидовХарактеристик.СлужебныеЗначения.КодРеквизитаВидАлкогольнойПродукции)));
	Запрос.УстановитьПараметр("врСостав",ТаблицаАлкоголя);
	Запрос.УстановитьПараметр("Фирма", Фирма);
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница", СтруктурнаяЕдиница);
	
	РезультатЗапроса = Запрос.Выполнить();
	ТаблицаЗапроса = РезультатЗапроса.Выгрузить();
	Док.СоставПоПроизводителям.Загрузить(ТаблицаЗапроса);

	//заполним табчасть СоставПоПроизводителям теми товарами, которых не нашли в алкогольном регистре
	Для Каждого СтрокаСостава Из Док.Состав Цикл
		мсв=Док.СоставПоПроизводителям.НайтиСтроки(Новый Структура("Номенклатура",СтрокаСостава.Номенклатура));
		Если мсв.Количество() = 0 Тогда
			СтрокаСоставаПоПроизводителям = Док.СоставПоПроизводителям.Добавить();
			СтрокаСоставаПоПроизводителям.Номенклатура            = СтрокаСостава.Номенклатура;
			СтрокаСоставаПоПроизводителям.ВидАлкогольнойПродукции = УчетАлкогольнойПродукции.ОсновнойВидАлкогольнойПродукции(СтрокаСостава.Номенклатура);
			СтрокаСоставаПоПроизводителям.Производитель           = УчетАлкогольнойПродукции.ОсновнойПроизводительАлкогольнойПродукции(СтрокаСостава.Номенклатура);
			СтрокаСоставаПоПроизводителям.КоличествоУчет          = 0;
			СтрокаСоставаПоПроизводителям.Количество              = СтрокаСостава.Количество;
		КонецЕсли;
	КонецЦикла;
	
	ЗначениеВДанныеФормы(Док,ДанныеФормы);
	
КонецФункции 

&НаСервере
Функция ПолучитьТаблицуФирм();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВложенныйЗапрос.Фирма
		|ИЗ
		|	(ВЫБРАТЬ
		|		ИнвентаризацияСоставПоФирмам.Номенклатура КАК Номенклатура,
		|		ИнвентаризацияСоставПоФирмам.Фирма КАК Фирма
		|	ИЗ
		|		Документ.Инвентаризация.СоставПоФирмам КАК ИнвентаризацияСоставПоФирмам
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				НоменклатураДополнительныеРеквизиты.Ссылка КАК Ссылка,
		|				НоменклатураДополнительныеРеквизиты.Значение КАК Значение
		|			ИЗ
		|				Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
		|			ГДЕ
		|				НоменклатураДополнительныеРеквизиты.Ссылка В(&МассивНоменклатуры)
		|				И НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоВидАлкогольнойПродукции) КАК ТабВидАлкогольнойПродукции
		|			ПО ИнвентаризацияСоставПоФирмам.Номенклатура = ТабВидАлкогольнойПродукции.Ссылка
		|	ГДЕ
		|		ИнвентаризацияСоставПоФирмам.Ссылка = &Ссылка
		|		И НЕ ТабВидАлкогольнойПродукции.Значение ЕСТЬ NULL) КАК ВложенныйЗапрос
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.Фирма
		|
		|УПОРЯДОЧИТЬ ПО
		|	ВложенныйЗапрос.Фирма.Наименование";

	МассивНоменклатуры = ПолучитьМассивНоменклатуры();
    СвойствоВидАлкогольнойПродукции = ПолучитьСвойствоВидАлкогольнойПродукции();
	
	Запрос.УстановитьПараметр("Ссылка", Объект.Ссылка);
	Запрос.УстановитьПараметр("СвойствоВидАлкогольнойПродукции", СвойствоВидАлкогольнойПродукции);
	Запрос.УстановитьПараметр("МассивНоменклатуры", МассивНоменклатуры);
	
	Результат = Запрос.Выполнить();
	
	Т = Результат.Выгрузить();
	
	Массив = Новый Массив;
	
	й = 0;
	Для Каждого Стр Из Т Цикл
		Структура = Новый Структура();
		Структура.Вставить("Фирма",Стр.Фирма);
		Массив.Вставить(й,Структура);
		й = й +1;
	КонецЦикла;
	
	Возврат Массив;
	
КонецФункции 

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	МассивНоменклатуры = ПолучитьМассивНоменклатуры();
    СвойствоВидАлкогольнойПродукции = ПолучитьСвойствоВидАлкогольнойПродукции();
	
	СкладыИФирмы.Параметры.УстановитьЗначениеПараметра("Ссылка", Объект.Ссылка);
 	СкладыИФирмы.Параметры.УстановитьЗначениеПараметра("СвойствоВидАлкогольнойПродукции", СвойствоВидАлкогольнойПродукции);
	СкладыИФирмы.Параметры.УстановитьЗначениеПараметра("МассивНоменклатуры", МассивНоменклатуры);
    СоздатьДокументы("");
	Отказ = ИСТИНА;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьСвойствоВидАлкогольнойПродукции() 
	
	Возврат ПланыВидовХарактеристик.ДополнительныеРеквизитыНоменклатуры.НайтиПоКоду(ОбщегоНазначения.ПолучитьЗначениеСвойстваСлужебногоЗначения(ПланыВидовХарактеристик.СлужебныеЗначения.КодРеквизитаВидАлкогольнойПродукции));	
	
КонецФункции

&НаСервере
Функция ПолучитьМассивНоменклатуры() 
	
	ТЗСоставПоФирмам = Объект.СоставПоФирмам.Выгрузить();
	Возврат ТЗСоставПоФирмам.ВыгрузитьКолонку("Номенклатура");
	
КонецФункции




