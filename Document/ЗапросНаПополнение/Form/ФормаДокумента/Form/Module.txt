


&НаКлиенте
Процедура ЦенаПриИзменении(Элемент)
	ОбработкаТабличныхЧастейКлиент.РасчитатьСуммуВСтрокеТабличнойЧасти(Элементы.Состав.ТекущиеДанные);
КонецПроцедуры

&НаКлиенте
Процедура ЕдиницаИзмеренияПриИзменении(Элемент)
	ОбработкаТабличныхЧастейКлиент.ПриИзмененииЕдиницыИзмеренияВТабличнойЧасти(ЭтаФорма);
КонецПроцедуры

&НаКлиенте
Процедура КоличествоПриИзменении(Элемент)
	ОбработкаТабличныхЧастейКлиент.ПриИзмененииКоличестваВТабличнойЧасти(Элементы.Состав.ТекущиеДанные);
КонецПроцедуры

&НаКлиенте
Процедура СуммаПриИзменении(Элемент)
	ОбработкаТабличныхЧастейКлиент.ПриИзмененииСуммыВТабличнойЧасти(Элементы.Состав.ТекущиеДанные);
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	ТолькоПросмотр = РаботаСФормамиСервер.ЗапрещеноРедактировать(Объект.Ссылка,ЭтаФорма);
	Централизованный = ?(ЗначениеЗаполнено(Объект.СкладПроизводства),1,0);
	Элементы.СкладПроизводства.Доступность = ?(Централизованный = 1, Истина, Ложь);
	Элементы.ГруппаПереключателей.Доступность = Объект.Состав.Количество() = 0;
	Элементы.СкладПроизводства.АвтоОтметкаНезаполненного = ?(Централизованный = 0, Истина, Ложь);
	ОбщегоНазначенияСервер.ЗапретМодификацииОбъектов(ЭтаФорма,Элементы.ФормаСоздатьНаОсновании);
	ДополнительныеОтчетыИОбработки.ПриСозданииНаСервере(ЭтаФорма);
КонецПроцедуры

&НаСервере
Процедура ПриЗагрузкеДанныхИзНастроекНаСервере(Настройки)
	Если Элементы.Найти("ПодборНоменклатуры")<>Неопределено тогда
		Значение = Настройки.Получить("ОтображениеТаблицыПодбор");
		Если Значение<>Неопределено тогда
			Элементы.ПодборНоменклатуры.Отображение = Значение;
		конецесли;
	конецесли;
	Если ЗначениеЗаполнено(Объект.Ссылка) или ЗначениеЗаполнено(Параметры.Основание) или ЗначениеЗаполнено(Параметры.ЗначениеКопирования) Тогда
		Настройки.Очистить();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПриСохраненииДанныхВНастройкахНаСервере(Настройки)
	Если Элементы.Найти("ПодборНоменклатуры")<>Неопределено тогда
	Настройки.вставить("ОтображениеТаблицыПодбор",элементы.подборНоменклатуры.Отображение);
	конецесли;
КонецПроцедуры


//Процедуры и функции для организации подбора
&НаКлиенте
Процедура ПодборНоменклатурыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	Для Каждого Строка Из Элемент.ВыделенныеСтроки Цикл
		Количество = ОбработкаТабличныхЧастейКлиент.ЗапросКоличества(ЗапрашиватьКоличество);
		ОбработкаТабличныхЧастейКлиент.ЗаполнитьИзПодбора(ЭтаФорма,Объект,Элемент.ДанныеСтроки(Строка),Элементы.состав,СтандартнаяОбработка,Количество);
	КонецЦикла;	
КонецПроцедуры

&НаКлиенте
Процедура ПодборОткрыть(Команда)
	ЗаменитьТексПодбора();
	Элементы.ГруппаПодбор.Видимость = НЕ Элементы.ГруппаПодбор.Видимость;
КонецПроцедуры

&НаКлиенте
Процедура СоставПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	Отказ = Истина;
	ПодборОткрыть(Неопределено);
КонецПроцедуры

&НаКлиенте              
Процедура ВнешнееСобытие(Источник, Событие, Данные)
	Если Источник = "BarCodeScaner" И Событие = "BarCodeValue" Тогда
		Если Не ВводДоступен() Тогда
			КомпонентаСканераШК.СобытиеОбработано();
			Возврат;   
		КонецЕсли;
		СтруктураПодбора = ПолучитьСтруктуруЗапросаПодбора();
		СтрокаТЧ = РаботаСоСканеромШККлиент.ОбработкаШтрихКодаВДокументах(ЭтаФорма,Объект,Элементы.Состав,Данные,СтруктураПодбора);
		КомпонентаСканераШК.СобытиеОбработано();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция ПолучитьСтруктуруЗапросаПодбора() Экспорт
	СтруктураПодбора = Новый Структура;
	СтруктураПодбора.Вставить("ТекстЗапроса",ПодборНоменклатуры.ТекстЗапроса);
	СтруктураПодбора.Вставить("Параметры",ПодборНоменклатуры.Параметры);
	Возврат СтруктураПодбора;
КонецФункции	


&НаКлиенте
Процедура ПоказатьГруппыВПодборе(Команда)
	элементы.кнГруппы.пометка = не элементы.кнГруппы.пометка;
	флаг = Элементы.кнГруппы.пометка;
	ВЫполнить("ОбработкаТабличныхЧастейКлиент.ОтображениеГрупп(ПодборНоменклатуры,флаг)");
КонецПроцедуры

 &НаСервере
Процедура Сохранитьпараметрыподбора()
	ПОдборНоменклатурыСервер.СохранитьПараметрыПодбора(Объект.Ссылка.Метаданные().имя,ЭтаФорма.ИмяФормы,ЭтаФорма.Элементы);
конецпроцедуры

&НаСервере
Функция получитьНастройкуПодбора()
	возврат подборНоменклатурыСервер.ПолучитьНастройкуподбора(Объект.Ссылка.Метаданные().Имя,ЭтаФорма.ИмяФормы);	
конецфункции

&НаКлиенте
процедура ЗагрузитьНастройкиПодбора()
		Настройки = ПолучитьНастройкуПодбора();
		ОбработкаТабличныхЧастейКлиент.загрузитьнастройкиподбора(ЭтаФорма,Настройки);
конецпроцедуры

//Конец Процедуры и функции для организации подбора


  
&НаКлиенте
Процедура ПодборЗакрыть(Команда)
	Элементы.ГруппаПодбор.Видимость  = Ложь;
КонецПроцедуры


процедура Установитьпараметры()
	Если Не ПодборНоменклатуры.Параметры.ДоступныеПараметры.Элементы.Найти("Структурнаяединица") = Неопределено Тогда
		ПодборНоменклатуры.Параметры.УстановитьЗначениеПараметра("Структурнаяединица", Объект.Структурнаяединица);
	КонецЕсли;
	Если Не ПодборНоменклатуры.Параметры.ДоступныеПараметры.Элементы.Найти("Дата") = Неопределено Тогда
		ПодборНоменклатуры.Параметры.УстановитьЗначениеПараметра("Дата", Объект.Дата);
	КонецЕсли;
	Если Не ПодборНоменклатуры.Параметры.ДоступныеПараметры.Элементы.Найти("СписокТоваров") = Неопределено Тогда
		ПодборНоменклатуры.Параметры.УстановитьЗначениеПараметра("СписокТоваров", СписокНомеклатуры);
	КонецЕсли;
конецпроцедуры


&НаКлиенте
Процедура Дерево(Команда)
	обработкатабличныхчастейклиент.ОтображениеДинамическогоСпискаДерево(ЭтаФорма);	
КонецПроцедуры


&НаКлиенте
Процедура Иерархия(Команда)
	обработкатабличныхчастейклиент.отображениединамическогоспискаиерархия(этаформа);	
КонецПроцедуры


&НаКлиенте
Процедура Список(Команда)
	обработкатабличныхчастейклиент.ОтображениеДинамическогоСпискаСписок(этаформа);	
КонецПроцедуры


&НаКлиенте
Процедура ЦентрализованныйПриИзменении(Элемент)
	Элементы.СкладПроизводства.Доступность = ?(Централизованный = 1, Истина, Ложь);
	Элементы.СкладПроизводства.АвтоОтметкаНезаполненного = ?(Централизованный = 0, Истина, Ложь);
	Если Централизованный = 0 Тогда 
		Объект.СкладПроизводства = "";
	КонецЕсли;
	СтруктураШапки();
КонецПроцедуры


&НаКлиенте
Процедура СоставПриИзменении(Элемент)
	Элементы.ГруппаПереключателей.Доступность = Объект.Состав.Количество() = 0;
КонецПроцедуры


&НаКлиенте
Процедура ПриОткрытии(Отказ)
	загрузитьНастройкиПодбора();
	СтруктураШапки();
КонецПроцедуры


&НаКлиенте
Процедура ПриЗакрытии()
	СохранитьПараметрыПодбора();
КонецПроцедуры


&НаКлиенте
Процедура ДатаПриИзменении(Элемент)
	РаботаСФормамиКлиент.ПроверкаДатыРедактирования(Объект);
	Установитьпараметры();
КонецПроцедуры

&НаКлиенте
Процедура НастройкаПодбора(Команда)
	ПараметрыПодбора = ОткрытьФормуМодально("ОбщаяФорма.НастройкаПодбора", Новый Структура("ЗапрашиватьКоличество", ЗапрашиватьКоличество));
	ЗапрашиватьКоличество = ПараметрыПодбора.ЗапрашиватьКоличество;
КонецПроцедуры

&НаСервере
Процедура ОбработкаПроверкиЗаполненияНаСервере(Отказ, ПроверяемыеРеквизиты)
	Если Централизованный = 1 И НЕ ЗначениеЗаполнено(Объект.СкладПроизводства) Тогда
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
							НСтр("ru = 'Поле ""Склад"" не заполнено!'"), ,
							, ,
							Отказ);
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура СтруктурнаяЕдиницаПриИзменении(Элемент)
	Установитьпараметры();
КонецПроцедуры

&НаКлиенте
Процедура УстановитьДатуПоставки(Команда)
	
	ДатаПоставки = Объект.Дата;
	Если ВвестиДату(ДатаПоставки,"Введите дату поставки",ЧастиДаты.Дата) Тогда
		Для Каждого Строка Из Элементы.Состав.ВыделенныеСтроки Цикл
			Элементы.Состав.ДанныеСтроки(Строка).ДатаПоставки = ДатаПоставки;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаменитьТексПодбора()
	Если Централизованный = 1 Тогда
		ПодборНоменклатуры.ПроизвольныйЗапрос = Истина;
		ПодборНоменклатуры.ТекстЗапроса = "ВЫБРАТЬ
		                                  |	СписокНоменклатуры.Код,
		                                  |	СписокНоменклатуры.Наименование,
		                                  |	СписокНоменклатуры.Группа,
		                                  |	ВЫБОР
		                                  |		КОГДА СписокНоменклатуры.ПометкаУдаления
		                                  |			ТОГДА ВЫБОР
		                                  |					КОГДА СписокНоменклатуры.Группа = 0
		                                  |						ТОГДА 2
		                                  |					ИНАЧЕ 3
		                                  |				КОНЕЦ
		                                  |		ИНАЧЕ ВЫБОР
		                                  |				КОГДА СписокНоменклатуры.Группа = 0
		                                  |					ТОГДА 0
		                                  |				ИНАЧЕ 1
		                                  |			КОНЕЦ
		                                  |	КОНЕЦ КАК Картинка,
		                                  |	СписокНоменклатуры.Ссылка КАК Номенклатура
		                                  |ИЗ
		                                  |	Справочник.Номенклатура КАК СписокНоменклатуры
		                                  |ГДЕ
		                                  |	ВЫБОР
		                                  |			КОГДА СписокНоменклатуры.Группа = 0
		                                  |				ТОГДА СписокНоменклатуры.Заказываемый
		                                  |						И СписокНоменклатуры.Ссылка В
		                                  |							(ВЫБРАТЬ
		                                  |								СтатусыНоменклатуры.Номенклатура
		                                  |							ИЗ
		                                  |								РегистрСведений.СтатусыНоменклатуры КАК СтатусыНоменклатуры
		                                  |							ГДЕ
		                                  |								СтатусыНоменклатуры.СтруктурнаяЕдиница = &СтруктурнаяЕдиница
		                                  |								И СтатусыНоменклатуры.Статус = ЗНАЧЕНИЕ(перечисление.статусытоваров.активный))
		                                  |						И ВЫБОР
		                                  |							КОГДА &СписокТоваров = ЗНАЧЕНИЕ(Справочник.СпискиНоменклатуры.ПустаяСсылка)
		                                  |								ТОГДА ИСТИНА
		                                  |							ИНАЧЕ СписокНоменклатуры.Ссылка В
		                                  |									(ВЫБРАТЬ
		                                  |										СпискиНоменклатурыСостав.Номенклатура
		                                  |									ИЗ
		                                  |										Справочник.СпискиНоменклатуры.Состав КАК СпискиНоменклатурыСостав
		                                  |									ГДЕ
		                                  |										СпискиНоменклатурыСостав.Ссылка = &СписокТоваров)
		                                  |						КОНЕЦ
		                                  |			ИНАЧЕ ИСТИНА
		                                  |		КОНЕЦ";
	Иначе
		ПодборНоменклатуры.ПроизвольныйЗапрос = Истина;
		ПодборНоменклатуры.ТекстЗапроса = "ВЫБРАТЬ
		                                  |	СписокНоменклатуры.Код,
		                                  |	СписокНоменклатуры.Наименование,
		                                  |	СписокНоменклатуры.Группа,
		                                  |	ВЫБОР
		                                  |		КОГДА СписокНоменклатуры.ПометкаУдаления
		                                  |			ТОГДА ВЫБОР
		                                  |					КОГДА СписокНоменклатуры.Группа = 0
		                                  |						ТОГДА 2
		                                  |					ИНАЧЕ 3
		                                  |				КОНЕЦ
		                                  |		ИНАЧЕ ВЫБОР
		                                  |				КОГДА СписокНоменклатуры.Группа = 0
		                                  |					ТОГДА 0
		                                  |				ИНАЧЕ 1
		                                  |			КОНЕЦ
		                                  |	КОНЕЦ КАК Картинка,
		                                  |	СписокНоменклатуры.Ссылка КАК Номенклатура
		                                  |ИЗ
		                                  |	Справочник.Номенклатура КАК СписокНоменклатуры
		                                  |ГДЕ
		                                  |	ВЫБОР
		                                  |			КОГДА СписокНоменклатуры.Группа = 0
		                                  |				ТОГДА СписокНоменклатуры.Заказываемый
		                                  |						И СписокНоменклатуры.Ссылка В
		                                  |							(ВЫБРАТЬ
		                                  |								СтатусыНоменклатуры.Номенклатура
		                                  |							ИЗ
		                                  |								РегистрСведений.СтатусыНоменклатуры КАК СтатусыНоменклатуры
		                                  |							ГДЕ
		                                  |								СтатусыНоменклатуры.СтруктурнаяЕдиница = &СтруктурнаяЕдиница
		                                  |								И СтатусыНоменклатуры.Статус = ЗНАЧЕНИЕ(перечисление.статусытоваров.активный))
		                                  |						И СписокНоменклатуры.Ссылка В
		                                  |							(ВЫБРАТЬ РАЗЛИЧНЫЕ
		                                  |								МетодыПополнения.Номенклатура
		                                  |							ИЗ
		                                  |								РегистрСведений.МетодыПополнения.СрезПоследних(&Дата, ) КАК МетодыПополнения
		                                  |							ГДЕ
		                                  |								МетодыПополнения.СтруктурнаяЕдиница = &СтруктурнаяЕдиница
		                                  |								И МетодыПополнения.МетодПополнения = ЗНАЧЕНИЕ(перечисление.методыпополнения.so))
		                                  |						И ВЫБОР
		                                  |							КОГДА &СписокТоваров = ЗНАЧЕНИЕ(Справочник.СпискиНоменклатуры.ПустаяСсылка)
		                                  |								ТОГДА ИСТИНА
		                                  |							ИНАЧЕ СписокНоменклатуры.Ссылка В
		                                  |									(ВЫБРАТЬ
		                                  |										СпискиНоменклатурыСостав.Номенклатура
		                                  |									ИЗ
		                                  |										Справочник.СпискиНоменклатуры.Состав КАК СпискиНоменклатурыСостав
		                                  |									ГДЕ
		                                  |										СпискиНоменклатурыСостав.Ссылка = &СписокТоваров)
		                                  |						КОНЕЦ
		                                  |			ИНАЧЕ ИСТИНА
		                                  |		КОНЕЦ";
	КонецЕсли;	
	УстановитьПараметры();
КонецПроцедуры

&НаКлиенте
Процедура СписокНомеклатурыПриИзменении(Элемент)
	УстановитьПараметры();
КонецПроцедуры
//КотлячковаЕВ++ 10.04.14 получение остатков РЦ в магазине
&НаКлиенте
Процедура ПолучитьОстаткиРЦ(Команда)
	
	Структура = Новый Структура("Состав");
	Структура.Вставить("АдресТаблицы",ПолучитьТЧВХранилище());
	Структура.Вставить("Склад",Объект.СкладПроизводства);
	//Если нужно использовать полученную ТЗ то можно ее в результат передавать.
	Результат = ОткрытьФормуМодально("ОбщаяФорма.ОстаткиРЦ",Структура,ЭтаФорма);
	
	
КонецПроцедуры
&НаСервере
Функция ПолучитьТЧВХранилище()
	
	ОбъектДок = РеквизитФормыВЗначение("Объект");
	Возврат ПоместитьВоВременноеХранилище(ОбъектДок.Состав.Выгрузить(,"Номенклатура"),ЭтаФорма.УникальныйИдентификатор);
	
КонецФункции

&НаКлиенте
Процедура СообщитьПользователю()
	
	Сообщение = Новый СообщениеПользователю();
	Сообщение.Текст = "Данная процедура не доступна!";
	Сообщение.Сообщить();
	
КонецПроцедуры
//КотлячковаЕВ-- 10.04.14 получение остатков РЦ в магазине

//dps+ 06.08.14 №000122628
&НаКлиенте
Процедура СтруктураШапки()
	Элементы.ГруппаДат.Видимость = ?(Централизованный = 1,Истина, ЛОЖЬ);
КонецПроцедуры

