Функция ПечатьОП23(МассивОбъектов,ОбъектыПечати) Экспорт
	ТабДок = Новый ТабличныйДокумент;	
	//Макет = ПолучитьМакет("ОП23");
	Макет = УправлениеПечатью.ПолучитьМакет("Документ.ГотоваяПродукция.ОП23");
	ТабДок.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
	НомерСтрокиНачало = 0;
	Для каждого док из массивОбъектов цикл
		Если Док.ВидПроизводства <> Перечисления.ВидыПроизводства.Разделка Тогда
			Продолжить;
		КонецЕсли;	
		Запрос = новый Запрос;
		Запрос.Текст ="ВЫБРАТЬ
		              |	ВложенныйЗапрос.Продукция КАК Продукция,
		              |	СУММА(ВложенныйЗапрос.ПродукцияКоличество) КАК ПродукцияКоличество,
		              |	ВложенныйЗапрос.Материал КАК Материал,
		              |	СУММА(ВложенныйЗапрос.МатериалКоличество) КАК МатериалКоличествоФакт,
		              |	ВложенныйЗапрос.МатериалЕдИзм КАК МатериалЕдИзм,
		              |	ВложенныйЗапрос.МатериалЕдИзмКод КАК МатериалЕдИзмКод,
		              |	ВложенныйЗапрос.ПродукцияЕдИзм КАК ПродукцияЕдИзм,
		              |	ВложенныйЗапрос.ПродукцияЕдИзмКод КАК ПродукцияЕдИзмКод,
		              |	ВложенныйЗапрос.МатериалПроцент КАК МатериалПроцентНорма,
		              |	ВложенныйЗапрос.Материал.Код КАК МатериалКод,
		              |	ВложенныйЗапрос.Продукция.Код КАК ПродукцияКод,
		              |	СУММА(ЕСТЬNULL(МатериалСуммы.СуммаБезНДС, 0)) КАК МатериалСуммаФакт,
		              |	СУММА(ЕСТЬNULL(ПродукцияСуммы.СуммаБезНДС, 0)) КАК ПродукцияСумма,
		              |	СУММА(ЕСТЬNULL(ВЫБОР
		              |				КОГДА ВложенныйЗапрос.МатериалКоличество <> 0
		              |					ТОГДА МатериалСуммы.СуммаБезНДС / ВложенныйЗапрос.МатериалКоличество
		              |				ИНАЧЕ МатериалСуммы.СуммаБезНДС
		              |			КОНЕЦ, 0)) КАК МатериалЦенаФакт,
		              |	СУММА(ЕСТЬNULL(ВЫБОР
		              |				КОГДА ВложенныйЗапрос.ПродукцияКоличество <> 0
		              |					ТОГДА ПродукцияСуммы.СуммаБезНДС / ВложенныйЗапрос.ПродукцияКоличество
		              |				ИНАЧЕ ПродукцияСуммы.СуммаБезНДС
		              |			КОНЕЦ, 0)) КАК ПродукцияЦена,
		              |	СУММА(ЕСТЬNULL(ВложенныйЗапрос.ПродукцияКоличество * ТехнологическиеКарты.Масса,0)) КАК МатериалКоличествоНорма,
		              |	ВложенныйЗапрос.МатериалКоличество - ЕСТЬNULL(ВложенныйЗапрос.ПродукцияКоличество * ТехнологическиеКарты.Масса,0) КАК МатериалОтклонение
		              |ИЗ
		              |	(ВЫБРАТЬ
		              |		ГотоваяПродукцияПродукция.Номенклатура КАК Продукция,
		              |		СУММА(ГотоваяПродукцияПродукция.Количество * ГотоваяПродукцияПродукция.Коэффициент) КАК ПродукцияКоличество,
		              |		ГотоваяПродукцияСостав.Номенклатура КАК Материал,
		              |		СУММА(ГотоваяПродукцияСостав.Количество * ГотоваяПродукцияСостав.Коэффициент) КАК МатериалКоличество,
		              |		ГотоваяПродукцияСостав.Номенклатура.БазоваяЕдиницаИзмерения КАК МатериалЕдИзм,
		              |		ГотоваяПродукцияСостав.Номенклатура.БазоваяЕдиницаИзмерения.Код КАК МатериалЕдИзмКод,
		              |		ГотоваяПродукцияПродукция.Номенклатура.БазоваяЕдиницаИзмерения.Наименование КАК ПродукцияЕдИзм,
		              |		ГотоваяПродукцияПродукция.Номенклатура.БазоваяЕдиницаИзмерения.Код КАК ПродукцияЕдИзмКод,
		              |		ГотоваяПродукцияСостав.КоэффициентРаспределенияЦены КАК МатериалПроцент,
		              |		ГотоваяПродукцияПродукция.ТехнологическаяКарта КАК ТехнологическаяКарта
		              |	ИЗ
		              |		Документ.ГотоваяПродукция.Продукция КАК ГотоваяПродукцияПродукция
		              |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ГотоваяПродукция.Состав КАК ГотоваяПродукцияСостав
		              |			ПО ГотоваяПродукцияПродукция.Ключ = ГотоваяПродукцияСостав.Ключ
		              |	ГДЕ
		              |		ГотоваяПродукцияПродукция.Ссылка = &Ссылка
		              |		И ГотоваяПродукцияСостав.Ссылка = &Ссылка
		              |	
		              |	СГРУППИРОВАТЬ ПО
		              |		ГотоваяПродукцияПродукция.Номенклатура,
		              |		ГотоваяПродукцияСостав.Номенклатура,
		              |		ГотоваяПродукцияСостав.КоэффициентРаспределенияЦены,
		              |		ГотоваяПродукцияПродукция.ТехнологическаяКарта,
		              |		ГотоваяПродукцияСостав.Номенклатура.БазоваяЕдиницаИзмерения,
		              |		ГотоваяПродукцияСостав.Номенклатура.БазоваяЕдиницаИзмерения.Код,
		              |		ГотоваяПродукцияПродукция.Номенклатура.БазоваяЕдиницаИзмерения.Наименование,
		              |		ГотоваяПродукцияПродукция.Номенклатура.БазоваяЕдиницаИзмерения.Код) КАК ВложенныйЗапрос
		              |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		              |			ТехнологическаяКартаСостав.Ссылка.Продукция КАК Продукция,
		              |			ТехнологическаяКартаСостав.Номенклатура КАК Материал,
		              |			ТехнологическаяКартаСостав.Ссылка КАК Ссылка,
		              |			СУММА(ТехнологическаяКартаСостав.КоличествоНетто) КАК Процент,
		              |			ТехнологическаяКартаСостав.Ссылка.МассаПорции * ТехнологическаяКартаСостав.Ссылка.КоличествоПорций * ТехнологическаяКартаСостав.КоличествоНетто / 100 КАК Масса
		              |		ИЗ
		              |			Документ.ТехнологическаяКарта.Состав КАК ТехнологическаяКартаСостав
		              |		
		              |		СГРУППИРОВАТЬ ПО
		              |			ТехнологическаяКартаСостав.Номенклатура,
		              |			ТехнологическаяКартаСостав.Ссылка,
		              |			ТехнологическаяКартаСостав.Ссылка.Продукция,
		              |			ТехнологическаяКартаСостав.Ссылка.МассаПорции * ТехнологическаяКартаСостав.Ссылка.КоличествоПорций * ТехнологическаяКартаСостав.КоличествоНетто / 100) КАК ТехнологическиеКарты
		              |		ПО ВложенныйЗапрос.ТехнологическаяКарта = ТехнологическиеКарты.Ссылка
		              |			И ВложенныйЗапрос.Продукция = ТехнологическиеКарты.Продукция
		              |			И ВложенныйЗапрос.Материал = ТехнологическиеКарты.Материал
		              |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		              |			НДСГотоваяПродукция.Продукция КАК Продукция,
		              |			СУММА(НДСГотоваяПродукция.Сумма) - СУММА(НДСГотоваяПродукция.СуммаНДС) КАК СуммаБезНДС
		              |		ИЗ
		              |			РегистрНакопления.ОстаткиНоменклатуры КАК НДСГотоваяПродукция
		              |		ГДЕ
		              |			НДСГотоваяПродукция.Регистратор = &Ссылка
		              |		
		              |		СГРУППИРОВАТЬ ПО
		              |			НДСГотоваяПродукция.Продукция) КАК МатериалСуммы
		              |		ПО ВложенныйЗапрос.Материал = МатериалСуммы.Продукция
		              |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		              |			НДСГотоваяПродукция.Номенклатура КАК Материал,
		              |			СУММА(НДСГотоваяПродукция.Сумма) - СУММА(НДСГотоваяПродукция.СуммаНДС) КАК СуммаБезНДС
		              |		ИЗ
		              |			РегистрНакопления.ОстаткиНоменклатуры КАК НДСГотоваяПродукция
		              |		ГДЕ
		              |			НДСГотоваяПродукция.Регистратор = &Ссылка
		              |		
		              |		СГРУППИРОВАТЬ ПО
		              |			НДСГотоваяПродукция.Номенклатура) КАК ПродукцияСуммы
		              |		ПО ВложенныйЗапрос.Продукция = ПродукцияСуммы.Материал
		              |
		              |СГРУППИРОВАТЬ ПО
		              |	ВложенныйЗапрос.Продукция,
		              |	ВложенныйЗапрос.МатериалЕдИзм,
		              |	ВложенныйЗапрос.ПродукцияЕдИзм,
		              |	ВложенныйЗапрос.Материал,
		              |	ВложенныйЗапрос.МатериалЕдИзмКод,
		              |	ВложенныйЗапрос.ПродукцияЕдИзмКод,
		              |	ВложенныйЗапрос.МатериалПроцент,
		              |	ВложенныйЗапрос.Материал.Код,
		              |	ВложенныйЗапрос.Продукция.Код,
		              //|	ВложенныйЗапрос.МатериалКоличество - ВложенныйЗапрос.ПродукцияКоличество * ТехнологическиеКарты.Масса
					  |	ВложенныйЗапрос.МатериалКоличество - ЕСТЬNULL(ВложенныйЗапрос.ПродукцияКоличество * ТехнологическиеКарты.Масса,0)

					  |ИТОГИ
		              |	СУММА(ПродукцияКоличество),
		              |	СУММА(МатериалКоличествоФакт),
		              |	СУММА(МатериалСуммаФакт),
		              |	СУММА(ПродукцияСумма),
		              |	СУММА(МатериалКоличествоНорма),
		              |	СУММА(МатериалОтклонение)
		              |ПО
		              |	ОБЩИЕ,
		              |	Продукция";
		Запрос.УстановитьПараметр("Ссылка",док);
		Область = Макет.ПолучитьОбласть("Заголовок");
		Область.Параметры.ДатаДок = Формат(Док.Дата,"ДФ=dd.MM.yyyy");
		Область.Параметры.НомерДок = Док.Номер;
		Область.Параметры.Фирма = Док.Фирма;
		Область.Параметры.СтруктурнаяЕдиница = Док.СтруктурнаяЕдиница;
		Область.Параметры.ОКПО = Док.Фирма.КодПоОКПО;
		//Область.Параметры.ОКДП = ФИрма.НаименованиеОКВЭД;
		//*Зернятко А.В.@06.11.2013 - //AKB-374. Ответственные лица СЕ
		//Руководители = обработкаПечатиСервер.ОтветственныеЛицаОрганизационнойЕдиницы(Док.Фирма, Док.Дата);
		Руководители = обработкаПечатиСервер.ОтветственныеЛицаОрганизационнойЕдиницы(Док.Фирма, Док.Дата, Док.СтруктурнаяЕдиница);
		///Зернятко А.В.@ - конец блока
		Область.Параметры.РуководительДолжность =  Руководители.РуководительДолжность;
		Область.Параметры.РуководительФИО = Руководители.ФИОРуководителя;
		табДок.Вывести(Область);
		Результат = Запрос.Выполнить();
		выборкаОбщиеИтоги = РЕзультат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		продукт = "";
		ИтогоПродукцияСумма = 0;
		ИтогоПРодукцияКоличество = 0;
		ИтогоМатериалКоличествоНорма = 0;
		ИтогоМатериалСуммаФакт = 0;
		//popn+ 191112
		ИтогоМатериалКоличествоФакт = 0;
		ИтогоСоставОтклонение = 0;
		//popn-
		ВыборкаОбщиеИтоги = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		ИтогоПолуфабрикатыПрописью = 0;
		Пока ВыборкаОбщиеИтоги.Следующий() цикл
			ВыборкаПродукция = ВыборкаОбщиеИтоги.Выбрать(обходРезультатаЗАпроса.ПоГруппировкам);
			пока выборкапродукция.следующий() цикл
				ВыборкаДетали = ВыборкаПродукция.Выбрать();
				МатериалКоличествоНорма = ВыборкаПродукция.МатериалКоличествоНорма;
				Пока ВыборкаДетали.следующий() цикл
					Область = Макет.ПолучитьОбласть("Строка");
					Область.Параметры.Заполнить(ВыборкаДетали);
					
					Если ВыборкаДетали.Продукция = Продукт и  ЗначениеЗаполнено(ВыборкаДетали.продукция) тогда
						Область.Параметры.Продукция = "";
						Область.Параметры.ПродукцияКод = "";
						Область.Параметры.ПРодукцияЕдИзм = "";
						Область.Параметры.ПродукцияЕдИзмКод = "";
						Область.Параметры.ПродукцияКоличество = "";
						Область.пАраметры.ПРодукцияСУмма = "";
						Область.Параметры.ПродукцияЦена = ""; 	
					Иначе
						ИтогоПродукцияКоличество = ИтогоПродукцияКоличество + ВыборкаДетали.ПродукцияКоличество;
						ИтогоПродукцияСумма = ИтогоПродукцияСУмма + ВыборкаДетали.ПродукцияСумма;
						ИтогоМатериалКоличествоНорма = ИтогоМатериалКоличествоНорма + ВыборкаДетали.МатериалКоличествоНорма;
						ИтогоМатериалСуммаФакт = ИтогоМатериалСуммаФакт +  ВыборкаДетали.МатериалСуммаФакт;
						ИтогоМатериалКоличествоФакт = ИтогоМатериалКоличествоФакт + ВыборкаДетали.МатериалКоличествоФакт;
						ИтогоСоставОтклонение = ИтогоСоставОтклонение + ВыборкаДетали.МатериалОтклонение;
					Конецесли;
					Продукт = ВыборкаДетали.Продукция;
					//Область.Параметры.материалПроцентНорма =?(материалКоличествоНорма =0,0, ВыборкаДетали.МатериалКоличествоНорма* 100/материалКоличествоНорма);
					ТабДок.Вывести(область);
				конеццикла;
			конеццикла;
			Область = Макет.ПолучитьОбласть("Итого");
			Область.Параметры.Заполнить(ВыборкаОбщиеИтоги);
			Область.Параметры.ИтогоПродукцияКоличество = ИтогоПродукцияКоличество;
			Область.Параметры.ИтогоПродукциясумма = ИтогоПродукцияСумма;
			
			
			
			ИтогоПолуфабрикатыПрописью = ВыборкаОбщиеИтоги.МатериалКоличествоФАкт;
			ТабДок.Вывести(Область);
		Конеццикла;
		Область = Макет.ПолучитьОбласть("Подвал");
		Область.параметры.ИтогоПродукцияПрописью =  ОбработкаПечатисервер.КоличествоПрописью(ИтогоПродукцияКоличество);
		Область.Параметры.ИтогоПолуфабрикатыПрописью = ОбработкаПечатисервер.КоличествоПрописью(ИтогоПолуфабрикатыПрописью);
		ТабДок.вывести(область);
		УправлениеПечатью.ЗадатьОбластьПечатиДокумента(ТабДок, 
		НомерСтрокиНачало, ОбъектыПечати,Док.Ссылка);
		НомерСтрокиНачало = ТабДок.ВысотаТаблицы+1;
	КонецЦикла;
	Возврат ТабДок;
КонецФункции

Функция ПечатьМ11(МассивОбъектов,ОбъектыПечати,ПечатьСРазбивкой) экспорт
	ТабДок = Новый ТабличныйДокумент;	
	//Макет = ПолучитьОбщийМакет("М11");
	Макет = УправлениеПечатью.ПолучитьМакет("ОбщийМакет.М11");
	ТабДок.ОриентацияСтраницы = ОриентацияСтраницы.Ландшафт;
	НомерСтрокиНачало = 0;
	Для каждого док из массивОбъектов цикл
		Запрос = Новый ПостроительЗапроса;
		Запрос.Текст = "ВЫБРАТЬ
		               |	ВложенныйЗапрос.Продукция КАК Продукция,
		               |	СУММА(ВложенныйЗапрос.КоличествоПродукция) КАК КоличествоПродукция,
		               |	ВложенныйЗапрос.Ингредиент КАК Материал,
		               |	СУММА(ВЫБОР
		               |			КОГДА УП.СхемаНалогообложения = ЗНАЧЕНИЕ(перечисление.СхемыНалогообложения.Упрощенная)
		               |					ИЛИ УП.СхемаНалогообложения = ЗНАЧЕНИЕ(Перечисление.СхемыНалогообложения.УпрощеннаяЕНВД)
		               |				ТОГДА ЕСТЬNULL(ОстаткиНоменклатуры.СуммаБезНДС, 0) + ЕСТЬNULL(ОстаткиНоменклатуры.СуммаНДС, 0)
		               |			ИНАЧЕ ЕСТЬNULL(ОстаткиНоменклатуры.СуммаБезНДС, 0)
		               |		КОНЕЦ) КАК СуммаБезНДС,
		               |	СУММА(ЕСТЬNULL(ОстаткиНоменклатуры.СуммаНДС, 0)) КАК СуммаНДС,
		               |	СУММА(ЕСТЬNULL(ВложенныйЗапрос.КоличествоИнгредиент, 0)) КАК КоличествоМатериал,
		               |	ОстаткиНоменклатуры.Материал.Код КАК МатериалКод,
		               |	ВложенныйЗапрос.ЕдиницаИзмеренияЕдиницаПоКлассификаторуКод КАК ЕдиницаИзмеренияКод,
		               |	ВложенныйЗапрос.ЕдиницаИзмеренияНаименование КАК ЕдиницаИзмерения,
		               |	ВложенныйЗапрос.Ингредиент.ВидТовара КАК ВидТовара,
		               |	ВложенныйЗапрос.Фирма,
		               |	ВложенныйЗапрос.Номер,
		               |	ВложенныйЗапрос.Дата,
		               |	ВложенныйЗапрос.Склад,
		               |	ВложенныйЗапрос.ФирмаКодПоОКПО КАК КодПоОКПО,
		               |	ВложенныйЗапрос.СкладВидСклада КАК ВидСклада,
		               |	ВложенныйЗапрос.СкладПроизводства
		               |ИЗ
		               |	(ВЫБРАТЬ
		               |		ГотоваяПродукцияПродукция.Номенклатура КАК Продукция,
		               |		СУММА(ГотоваяПродукцияПродукция.Количество) КАК КоличествоПродукция,
		               |		ГотоваяПродукцияСостав.Номенклатура КАК Ингредиент,
		               |		СУММА(ГотоваяПродукцияСостав.Количество) КАК КоличествоИнгредиент,
		               |		ГотоваяПродукцияСостав.ЕдиницаИзмерения.Наименование КАК ЕдиницаИзмеренияНаименование,
		               |		ГотоваяПродукцияСостав.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код КАК ЕдиницаИзмеренияЕдиницаПоКлассификаторуКод,
		               |		ГотоваяПродукцияПродукция.Ссылка.Фирма КАК Фирма,
		               |		ГотоваяПродукцияПродукция.Ссылка.Номер КАК Номер,
		               |		ГотоваяПродукцияПродукция.Ссылка.Дата КАК Дата,
		               |		ГотоваяПродукцияПродукция.Ссылка.Склад КАК Склад,
		               |		ГотоваяПродукцияПродукция.Ссылка.Фирма.КодПоОКПО КАК ФирмаКодПоОКПО,
		               |		ГотоваяПродукцияПродукция.Ссылка.Склад.ВидСклада КАК СкладВидСклада,
		               |		ГотоваяПродукцияПродукция.Ссылка.СкладПроизводства КАК СкладПроизводства
		               |	ИЗ
		               |		Документ.ГотоваяПродукция.Продукция КАК ГотоваяПродукцияПродукция
		               |			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ГотоваяПродукция.Состав КАК ГотоваяПродукцияСостав
		               |			ПО ГотоваяПродукцияПродукция.Ключ = ГотоваяПродукцияСостав.Ключ
		               |	ГДЕ
		               |		ГотоваяПродукцияПродукция.Ссылка = &Ссылка
		               |		И ГотоваяПродукцияСостав.Ссылка = &Ссылка
		               |	
		               |	СГРУППИРОВАТЬ ПО
		               |		ГотоваяПродукцияПродукция.Номенклатура,
		               |		ГотоваяПродукцияСостав.Номенклатура,
		               |		ГотоваяПродукцияСостав.ЕдиницаИзмерения.Наименование,
		               |		ГотоваяПродукцияПродукция.Ссылка.Фирма,
		               |		ГотоваяПродукцияПродукция.Ссылка.Номер,
		               |		ГотоваяПродукцияПродукция.Ссылка.Дата,
		               |		ГотоваяПродукцияПродукция.Ссылка.Склад,
		               |		ГотоваяПродукцияСостав.ЕдиницаИзмерения.ЕдиницаПоКлассификатору.Код,
		               |		ГотоваяПродукцияПродукция.Ссылка.Фирма.КодПоОКПО,
		               |		ГотоваяПродукцияПродукция.Ссылка.Склад.ВидСклада,
		               |		ГотоваяПродукцияПродукция.Ссылка.СкладПроизводства) КАК ВложенныйЗапрос
		               |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		               |			НДСГотоваяПродукция.Продукция КАК Продукция,
		               |			НДСГотоваяПродукция.Номенклатура КАК Материал,
		               |			СУММА(НДСГотоваяПродукция.Сумма) - СУММА(НДСГотоваяПродукция.СуммаНДС) КАК СуммаБезНДС,
		               |			СУММА(НДСГотоваяПродукция.СуммаНДС) КАК СуммаНДС
		               |		ИЗ
		               |			РегистрНакопления.ОстаткиНоменклатуры КАК НДСГотоваяПродукция
		               |		ГДЕ
		               |			НДСГотоваяПродукция.Регистратор = &Ссылка
		               |		
		               |		СГРУППИРОВАТЬ ПО
		               |			НДСГотоваяПродукция.Продукция,
		               |			НДСГотоваяПродукция.Номенклатура) КАК ОстаткиНоменклатуры
		               |		ПО (ОстаткиНоменклатуры.Продукция = ВложенныйЗапрос.Продукция)
		               |			И (ОстаткиНоменклатуры.Материал = ВложенныйЗапрос.Ингредиент)
		               |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		               |			УчетнаяПолитикаНалоговыйУчетСрезПоследних.СхемаНалогообложения КАК СхемаНалогообложения,
		               |			УчетнаяПолитикаНалоговыйУчетСрезПоследних.Организация КАК Организация
		               |		ИЗ
		               |			РегистрСведений.УчетнаяПолитикаНалоговыйУчет.СрезПоследних(&СсылкаДата, ) КАК УчетнаяПолитикаНалоговыйУчетСрезПоследних) КАК УП
		               |		ПО ВложенныйЗапрос.Фирма = УП.Организация
		               |
		               |СГРУППИРОВАТЬ ПО
		               |	ОстаткиНоменклатуры.Материал.Код,
		               |	ВложенныйЗапрос.ЕдиницаИзмеренияЕдиницаПоКлассификаторуКод,
		               |	ВложенныйЗапрос.ЕдиницаИзмеренияНаименование,
		               |	ВложенныйЗапрос.Фирма,
		               |	ВложенныйЗапрос.Номер,
		               |	ВложенныйЗапрос.Дата,
		               |	ВложенныйЗапрос.Склад,
		               |	ВложенныйЗапрос.ФирмаКодПоОКПО,
		               |	ВложенныйЗапрос.СкладВидСклада,
		               |	ВложенныйЗапрос.Продукция,
		               |	ВложенныйЗапрос.Ингредиент,
		               |	ВложенныйЗапрос.Ингредиент.ВидТовара,
		               |	ВложенныйЗапрос.СкладПроизводства
		               |{ИТОГИ ПО
		               |	Продукция}";
		
		Запрос.Параметры.Вставить("Ссылка", док);
		запрос.Параметры.Вставить("СсылкаДата",док.Дата);
		Запрос.Измерения.Добавить("Продукция");
		
		Если ПечатьСРазбивкой Тогда
			Запрос.Выполнить();
			Результат = Запрос.Результат;
			ВыборкаГруппировка = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			ПерваяСтраница = Истина;
			Пока ВыборкаГруппировка.Следующий() Цикл
				Выборка = ВыборкаГруппировка.Выбрать();
				ВыводПервойСтроки = Истина;
				СуммаИтого = 0;
				Пока Выборка.Следующий() Цикл
					Если ВыводПервойСтроки Тогда
						Если ПерваяСтраница Тогда
							ПерваяСтраница = Ложь;
						Иначе	
							ТабДок.ВывестиГоризонтальныйРазделительСтраниц();
						КонецЕсли;
						Шапка = Макет.ПолучитьОбласть("Шапка");
						Шапка.Параметры.Фирма = Выборка.Фирма;
						Шапка.Параметры.Номер = Выборка.Номер;
						Шапка.Параметры.КодОКПО = Выборка.КодПоОКПО;
						Шапка.Параметры.ДатаДок = Выборка.Дата;
						Шапка.Параметры.ПодразделениеОтправитель = Выборка.СкладПроизводства;
						Шапка.Параметры.ПодразделениеПолучатель = Выборка.Склад;
						Шапка.Параметры.КорСчет = "20.01";
						Шапка.Параметры.Продукция = Выборка.Продукция;
						Строка = Макет.ПолучитьОбласть("Строка");
						Подвал = Макет.ПолучитьОбласть("Подвал");
						ТабДок.Вывести(Шапка);
						
						ВыводПервойСтроки = Ложь;
					КонецЕсли;
					
					Строка.Параметры.МатЦенность = Выборка.Материал;
					Строка.Параметры.Код = Выборка.Материал.Код;
					Строка.Параметры.ЕдиницаИзмеренияКод = Выборка.ЕдиницаИзмеренияКод;
					Строка.Параметры.ЕдиницаИзмерения = Выборка.ЕдиницаИзмерения;
					Строка.Параметры.КоличествоЗатребовано = Выборка.КоличествоМатериал;
					Строка.Параметры.КоличествоОтпущено = Выборка.КоличествоМатериал;
					Строка.Параметры.МатериалЦенаБезНДС = ?(Выборка.КоличествоМатериал = 0, 0, Выборка.СуммаБезНДС/Выборка.КоличествоМатериал);
					Строка.Параметры.МатериалСумма = Выборка.СуммаБезНДС;
					СуммаИтого = СуммаИтого + Выборка.СуммаБезНДС;
					Строка.Параметры.СубСчет = "10.1";
					ТабДок.Вывести(Строка);
				КонецЦикла;
				Подвал.Параметры.СуммаИтого = СуммаИтого;
				ТабДок.Вывести(Подвал);
			КонецЦикла;
		Иначе
			Запрос.Выполнить();
			Результат = Запрос.Результат;
			ВыборкаГруппировка = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
			СуммаИтого = 0;
			Начало = Истина;
			Пока ВыборкаГруппировка.Следующий() Цикл
				Выборка = ВыборкаГруппировка.Выбрать();
				Выборка.Следующий();
				Если Начало Тогда
					Шапка = Макет.ПолучитьОбласть("Шапка");
					Шапка.Параметры.Фирма = Выборка.Фирма;
					Шапка.Параметры.Номер = Выборка.Номер;
					Шапка.Параметры.КодОКПО = Выборка.КодПоОКПО;
					Шапка.Параметры.ДатаДок = Выборка.Дата;
					Шапка.Параметры.ПодразделениеОтправитель = Выборка.СкладПроизводства;
					Шапка.Параметры.ПодразделениеПолучатель = Выборка.Склад;
					Шапка.Параметры.КорСчет = "20.01";
					Шапка.Параметры.Продукция = Выборка.Продукция;
					ТабДок.Вывести(Шапка);
					Начало = Ложь;
				Иначе
					ТабДок.ВставитьОбласть(ТабДок.Область("R8"), ТабДок.Область("R8"), ТипСмещенияТабличногоДокумента.ПоВертикали);
					ТабДок.Область(НомерСтрокиНачало+8,2,НомерСтрокиНачало+8,2).Текст = Выборка.Дата;
					ТабДок.Область(НомерСтрокиНачало+8,4,НомерСтрокиНачало+8,4).Текст = Выборка.Склад;
					ТабДок.Область(НомерСтрокиНачало+8,7,НомерСтрокиНачало+8,7).Текст = Выборка.Склад;
					ТабДок.Область(НомерСтрокиНачало+8,11,НомерСтрокиНачало+8,11).Текст = "20.01";
					ТабДок.Область(НомерСтрокиНачало+8,13,НомерСтрокиНачало+8,13).Текст = Выборка.Продукция;
				КонецЕсли;
			КонецЦикла;
			
			Строка = Макет.ПолучитьОбласть("Строка");
			Подвал = Макет.ПолучитьОбласть("Подвал");
			Запрос.ЗаполнитьНастройки();
			Запрос.ВыбранныеПоля.Удалить(Запрос.ВыбранныеПоля.Найти("Продукция"));
			Запрос.Выполнить();
			
			Выборка = Запрос.Результат.Выбрать();
			Пока Выборка.Следующий() Цикл
				Строка.Параметры.МатЦенность = Выборка.Материал;
				Строка.Параметры.Код = Выборка.МатериалКод;
				Строка.Параметры.ЕдиницаИзмеренияКод = Выборка.ЕдиницаИзмеренияКод;
				Строка.Параметры.ЕдиницаИзмерения = Выборка.ЕдиницаИзмерения;
				Строка.Параметры.КоличествоЗатребовано = Выборка.КоличествоМатериал;
				Строка.Параметры.КоличествоОтпущено = Выборка.КоличествоМатериал;
				Строка.Параметры.МатериалЦенаБезНДС = ?(Выборка.СуммаБезНДС > 0 И Выборка.КоличествоМатериал > 0, Выборка.СуммаБезНДС/Выборка.КоличествоМатериал, "");
				Строка.Параметры.МатериалСумма = Выборка.СуммаБезНДС;
				СуммаИтого = СуммаИтого + Выборка.СуммаБезНДС;
				Строка.Параметры.СубСчет = "10.1";
				ТабДок.Вывести(Строка);
			КонецЦикла;
			Подвал.Параметры.СуммаИтого = СуммаИтого;
			ТабДок.Вывести(Подвал);
			
		КонецЕсли;	
		УправлениеПечатью.ЗадатьОбластьПечатиДокумента(ТабДок, 
		НомерСтрокиНачало, ОбъектыПечати,Док.Ссылка);
		НомерСтрокиНачало = ТабДок.ВысотаТаблицы+1;
	КонецЦикла;
	Возврат ТабДок;
КонецФункции

Процедура Печать(МассивОбъектов, ПараметрыПечати, КоллекцияПечатныхФорм,
	ОбъектыПечати, ПараметрыВывода) Экспорт
	ПараметрыВывода.ДоступнаПечатьПоКомплектно = Истина;
	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "ОП23") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм,
		"ОП23", "ОП-23", ПечатьОП23(массивОбъектов,ОбъектыПечати));
	ИначеЕсли УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "М11") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм,
		"М11", "М-11", ПечатьМ11(массивОбъектов,ОбъектыПечати,ПараметрыПечати.ПечатьСРазбивкой));
	КонецЕсли;
КонецПроцедуры

