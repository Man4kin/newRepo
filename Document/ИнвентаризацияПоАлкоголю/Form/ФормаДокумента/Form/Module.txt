&НаКлиенте
Перем ВремСклад,ВремНоменклатура;

Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	УстановитьПараметрыФункциональныхОпцийФормы(Новый Структура("СтруктурнаяЕдиница",Объект.СтруктурнаяЕдиница));
	ОбщегоНазначенияСервер.ЗапретМодификацииОбъектов(ЭтаФорма);
	ДополнительныеОтчетыИОбработки.ПриСозданииНаСервере(ЭтаФорма);
КонецПроцедуры

&НаСервере
Процедура ПриЗагрузкеДанныхИзНастроекНаСервере(Настройки)
	Если Элементы.Найти("ПодборНоменклатуры")<>Неопределено тогда
		Значение = Настройки.Получить("ОтображениеТаблицыПодбор");
		Если Значение<>Неопределено тогда
			Элементы.ПодборНоменклатуры.Отображение = Значение;
		конецесли;
	конецесли;
	Если ЗначениеЗаполнено(Объект.Ссылка) или ЗначениеЗаполнено(Параметры.Основание) или ЗначениеЗаполнено(Параметры.ЗначениеКопирования) Тогда
		Настройки.Очистить();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПриСохраненииДанныхВНастройкахНаСервере(Настройки)
	Если Элементы.Найти("ПодборНоменклатуры")<>Неопределено тогда
		Настройки.вставить("ОтображениеТаблицыПодбор",элементы.подборНоменклатуры.Отображение);
	конецесли;
КонецПроцедуры

&НаСервере
Функция ПолучитьСтруктуруОстатковАлкоголя(Номенклатура)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВложенныйЗапрос.Номенклатура,
		|	СУММА(ВложенныйЗапрос.КоличествоОстаткиНоменклатуры) КАК КоличествоОстаткиНоменклатуры,
		|	СУММА(ВложенныйЗапрос.КоличествоУчетАлкоголя) КАК КоличествоУчетАлкоголя
		|ИЗ
		|	(ВЫБРАТЬ
		|		ОстаткиНоменклатурыОстатки.Номенклатура КАК Номенклатура,
		|		ОстаткиНоменклатурыОстатки.КоличествоОстаток КАК КоличествоОстаткиНоменклатуры,
		|		0 КАК КоличествоУчетАлкоголя
		|	ИЗ
		|		РегистрНакопления.ОстаткиНоменклатуры.Остатки(
		|				&Дата,
		|				Номенклатура = &Номенклатура
		|					И МестоХранения.Владелец = &СтруктурнаяЕдиница
		|					И Фирма = &Фирма) КАК ОстаткиНоменклатурыОстатки
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				НоменклатураДополнительныеРеквизиты.Ссылка КАК Ссылка,
		|				НоменклатураДополнительныеРеквизиты.Значение КАК Значение
		|			ИЗ
		|				Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
		|			ГДЕ
		|				НоменклатураДополнительныеРеквизиты.Ссылка = &Номенклатура
		|				И НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоВидАлкогольнойПродукции) КАК ТабВидАлкогольнойПродукции
		|			ПО ОстаткиНоменклатурыОстатки.Номенклатура = ТабВидАлкогольнойПродукции.Ссылка
		|	ГДЕ
		|		НЕ ТабВидАлкогольнойПродукции.Значение ЕСТЬ NULL 
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		УчетАлкоголяПоПроизводителямОстатки.Номенклатура,
		|		0,
		|		УчетАлкоголяПоПроизводителямОстатки.КоличествоОстаток
		|	ИЗ
		|		РегистрНакопления.УчетАлкоголяПоПроизводителям.Остатки(
		|				&Дата,
		|				Номенклатура = &Номенклатура
		|					И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
		|					И Фирма = &Фирма) КАК УчетАлкоголяПоПроизводителямОстатки
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				НоменклатураДополнительныеРеквизиты.Ссылка КАК Ссылка,
		|				НоменклатураДополнительныеРеквизиты.Значение КАК Значение
		|			ИЗ
		|				Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
		|			ГДЕ
		|				НоменклатураДополнительныеРеквизиты.Ссылка = &Номенклатура
		|				И НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоВидАлкогольнойПродукции) КАК ТабВидАлкогольнойПродукции
		|			ПО УчетАлкоголяПоПроизводителямОстатки.Номенклатура = ТабВидАлкогольнойПродукции.Ссылка
		|	ГДЕ
		|		НЕ ТабВидАлкогольнойПродукции.Значение ЕСТЬ NULL) КАК ВложенныйЗапрос
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.Номенклатура";
		
	Запрос.УстановитьПараметр("Фирма",Объект.Фирма);
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница",Объект.СтруктурнаяЕдиница);
	Запрос.УстановитьПараметр("Номенклатура",Номенклатура);
	Запрос.УстановитьПараметр("Дата",Объект.Дата);
    Запрос.УстановитьПараметр("СвойствоВидАлкогольнойПродукции",ПланыВидовХарактеристик.ДополнительныеРеквизитыНоменклатуры.НайтиПоКоду(ОбщегоНазначения.ПолучитьЗначениеСвойстваСлужебногоЗначения(ПланыВидовХарактеристик.СлужебныеЗначения.КодРеквизитаВидАлкогольнойПродукции)));
	
	СтруктураОстатков = Новый Структура;
	
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		СтруктураОстатков.Вставить("КоличествоОстаткиНоменклатуры",0);
		СтруктураОстатков.Вставить("КоличествоУчетАлкоголя",0);
	Иначе
		Выборка = РезультатЗапроса.Выбрать();
		Выборка.Следующий();
		СтруктураОстатков.Вставить("КоличествоОстаткиНоменклатуры",Выборка.КоличествоОстаткиНоменклатуры);
		СтруктураОстатков.Вставить("КоличествоУчетАлкоголя",Выборка.КоличествоУчетАлкоголя);
	КонецЕсли;
	
	Возврат СтруктураОстатков;
	
КонецФункции

&НаКлиенте
Процедура ПодборНоменклатурыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	Для Каждого Строка Из Элемент.ВыделенныеСтроки Цикл
		Количество = 0;
		ТекСтрока = ОбработкаТабличныхЧастейКлиент.ЗаполнитьИзПодбора(ЭтаФорма,Объект,Элемент.ДанныеСтроки(Строка),Элементы.состав,СтандартнаяОбработка,Количество);	
		Если ТекСтрока <> Неопределено Тогда
			
			СтруктураОстатковАлкоголя = ПолучитьСтруктуруОстатковАлкоголя(ТекСтрока.Номенклатура);
			ТекСтрока.Количество     = СтруктураОстатковАлкоголя.КоличествоОстаткиНоменклатуры;
			ТекСтрока.КоличествоУчет = СтруктураОстатковАлкоголя.КоличествоУчетАлкоголя;
			ТекСтрока.КоличествоРазница = ТекСтрока.Количество - ТекСтрока.КоличествоУчет;
			
			стрВопрос = "Производители по номенклатуре """+Строка(ТекСтрока.Номенклатура)+""" будут перезаполнены. Продолжить?";
			Если Вопрос(стрВопрос,РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
				Возврат;
			КонецЕсли;
			
			мсв = Объект.СоставПоПроизводителям.НайтиСтроки(Новый Структура("Номенклатура",ТекСтрока.Номенклатура));
			Для каждого эл из мсв Цикл
				Объект.СоставПоПроизводителям.Удалить(эл);
			КонецЦикла;	
			
			ОбновитьОстаткиПоПроизводителям(ТекСтрока.Номенклатура);
			
		КонецЕсли;	
	КонецЦикла;	
КонецПроцедуры

процедура Установитьпараметры()
	
	//ПодборНоменклатуры.Параметры.УстановитьЗначениеПараметра("МестоХранения", Объект.Склад);
	ПодборНоменклатуры.Параметры.УстановитьЗначениеПараметра("ТолькоОтрицательныеОстатки", ЛОЖЬ);
	
конецпроцедуры

&НаКлиенте
Процедура ПодборОткрыть(Команда)
	УстановитьПараметры();
	Элементы.ГруппаПодбор.Видимость = НЕ Элементы.ГруппаПодбор.Видимость;
КонецПроцедуры
&НаСервере
Процедура Сохранитьпараметрыподбора()
	ПОдборНоменклатурыСервер.СохранитьПараметрыПодбора(Объект.Ссылка.Метаданные().имя,ЭтаФорма.ИмяФормы,ЭтаФорма.Элементы);
конецпроцедуры

&НаСервере
Функция получитьНастройкуПодбора()
	возврат подборНоменклатурыСервер.ПолучитьНастройкуподбора(Объект.Ссылка.Метаданные().Имя,ЭтаФорма.ИмяФормы);	
конецфункции

&НаКлиенте
процедура ЗагрузитьНастройкиПодбора()
	Настройки = ПолучитьНастройкуПодбора();
	ОбработкаТабличныхЧастейКлиент.загрузитьнастройкиподбора(ЭтаФорма,Настройки);
конецпроцедуры

&НаКлиенте
Процедура СоставПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	Отказ = Истина;
	ПодборОткрыть(Неопределено);
КонецПроцедуры

&НаКлиенте
Процедура ВнешнееСобытие(Источник, Событие, Данные)
	Если Источник = "BarCodeScaner" И Событие = "BarCodeValue" Тогда
		Если Не ВводДоступен() Тогда
			КомпонентаСканераШК.СобытиеОбработано();
			Возврат;   
		КонецЕсли;
		СтруктураПодбора = ПолучитьСтруктуруЗапросаПодбора();
		СтрокаТЧ = РаботаСоСканеромШККлиент.ОбработкаШтрихКодаВДокументах(ЭтаФорма,Объект,Элементы.Состав,Данные,СтруктураПодбора);
		КомпонентаСканераШК.СобытиеОбработано();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция ПолучитьСтруктуруЗапросаПодбора() Экспорт
	СтруктураПодбора = Новый Структура;
	СтруктураПодбора.Вставить("ТекстЗапроса",ПодборНоменклатуры.ТекстЗапроса);
	СтруктураПодбора.Вставить("Параметры",ПодборНоменклатуры.Параметры);
	Возврат СтруктураПодбора;
КонецФункции	

&НаКлиенте
Процедура ОбновитьОстатки(Команда)
	
	стрВопрос = "Установить значение фактического количества равное учетному количеству?";
	ОбновитьОстаткиСервер(Истина,Вопрос(стрВопрос,РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Да);
	Элементы.Состав.Обновить();
	Элементы.СоставПоПроизводителям.Обновить();
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьОстаткиСервер(флОбновления,флПерезаполнятьФакт)
	
	//заполняем табличную часть "Состав"
	Запрос = Новый Запрос;
	
	Запрос.УстановитьПараметр("Фирма",Объект.Фирма);
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница",Объект.СтруктурнаяЕдиница);
	Запрос.УстановитьПараметр("Дата",Объект.Дата);
    Запрос.УстановитьПараметр("СвойствоВидАлкогольнойПродукции",ПланыВидовХарактеристик.ДополнительныеРеквизитыНоменклатуры.НайтиПоКоду(ОбщегоНазначения.ПолучитьЗначениеСвойстваСлужебногоЗначения(ПланыВидовХарактеристик.СлужебныеЗначения.КодРеквизитаВидАлкогольнойПродукции)));
	
	Если флОбновления Тогда
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	врСостав.Номенклатура
		|ПОМЕСТИТЬ врСостав
		|ИЗ
		|	&врСостав КАК врСостав
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВложенныйЗапрос.Номенклатура,
		|	СУММА(ВложенныйЗапрос.КоличествоОстаткиНоменклатуры) КАК КоличествоОстаткиНоменклатуры,
		|	СУММА(ВложенныйЗапрос.КоличествоУчетАлкоголя) КАК КоличествоУчетАлкоголя
		|ИЗ
		|	(ВЫБРАТЬ
		|		ОстаткиНоменклатурыОстатки.Номенклатура КАК Номенклатура,
		|		ОстаткиНоменклатурыОстатки.КоличествоОстаток КАК КоличествоОстаткиНоменклатуры,
		|		0 КАК КоличествоУчетАлкоголя
		|	ИЗ
		|		РегистрНакопления.ОстаткиНоменклатуры.Остатки(
		|				&Дата,
		|				Номенклатура В
		|						(ВЫБРАТЬ
		|							с.Номенклатура
		|						ИЗ
		|							врСостав КАК с)
		|					И МестоХранения.Владелец = &СтруктурнаяЕдиница
		|					И Фирма = &Фирма) КАК ОстаткиНоменклатурыОстатки
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				НоменклатураДополнительныеРеквизиты.Ссылка КАК Ссылка,
		|				НоменклатураДополнительныеРеквизиты.Значение КАК Значение
		|			ИЗ
		|				Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
		|			ГДЕ
		|				НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоВидАлкогольнойПродукции) КАК ТабВидАлкогольнойПродукции
		|			ПО ОстаткиНоменклатурыОстатки.Номенклатура = ТабВидАлкогольнойПродукции.Ссылка
		|	ГДЕ
		|		НЕ ТабВидАлкогольнойПродукции.Значение ЕСТЬ NULL 
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		УчетАлкоголяПоПроизводителямОстатки.Номенклатура,
		|		0,
		|		УчетАлкоголяПоПроизводителямОстатки.КоличествоОстаток
		|	ИЗ
		|		РегистрНакопления.УчетАлкоголяПоПроизводителям.Остатки(
		|				&Дата,
		|				Номенклатура В
		|						(ВЫБРАТЬ
		|							с.Номенклатура
		|						ИЗ
		|							врСостав КАК с)
		|					И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
		|					И Фирма = &Фирма) КАК УчетАлкоголяПоПроизводителямОстатки
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				НоменклатураДополнительныеРеквизиты.Ссылка КАК Ссылка,
		|				НоменклатураДополнительныеРеквизиты.Значение КАК Значение
		|			ИЗ
		|				Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
		|			ГДЕ
		|				НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоВидАлкогольнойПродукции) КАК ТабВидАлкогольнойПродукции
		|			ПО УчетАлкоголяПоПроизводителямОстатки.Номенклатура = ТабВидАлкогольнойПродукции.Ссылка
		|	ГДЕ
		|		НЕ ТабВидАлкогольнойПродукции.Значение ЕСТЬ NULL) КАК ВложенныйЗапрос
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.Номенклатура";
		
		Запрос.УстановитьПараметр("врСостав",Объект.Состав.Выгрузить());
	Иначе
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВложенныйЗапрос.Номенклатура,
		|	СУММА(ВложенныйЗапрос.КоличествоОстаткиНоменклатуры) КАК КоличествоОстаткиНоменклатуры,
		|	СУММА(ВложенныйЗапрос.КоличествоУчетАлкоголя) КАК КоличествоУчетАлкоголя
		|ИЗ
		|	(ВЫБРАТЬ
		|		ОстаткиНоменклатурыОстатки.Номенклатура КАК Номенклатура,
		|		ОстаткиНоменклатурыОстатки.КоличествоОстаток КАК КоличествоОстаткиНоменклатуры,
		|		0 КАК КоличествоУчетАлкоголя
		|	ИЗ
		|		РегистрНакопления.ОстаткиНоменклатуры.Остатки(
		|			&Дата,
		|			МестоХранения.Владелец = &СтруктурнаяЕдиница И Фирма = &Фирма) КАК ОстаткиНоменклатурыОстатки
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				НоменклатураДополнительныеРеквизиты.Ссылка КАК Ссылка,
		|				НоменклатураДополнительныеРеквизиты.Значение КАК Значение
		|			ИЗ
		|				Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
		|			ГДЕ
		|				НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоВидАлкогольнойПродукции) КАК ТабВидАлкогольнойПродукции
		|			ПО ОстаткиНоменклатурыОстатки.Номенклатура = ТабВидАлкогольнойПродукции.Ссылка
		|	ГДЕ
		|		НЕ ТабВидАлкогольнойПродукции.Значение ЕСТЬ NULL 
		|	
		|	ОБЪЕДИНИТЬ ВСЕ
		|	
		|	ВЫБРАТЬ
		|		УчетАлкоголяПоПроизводителямОстатки.Номенклатура,
		|		0,
		|		УчетАлкоголяПоПроизводителямОстатки.КоличествоОстаток
		|	ИЗ
		|		РегистрНакопления.УчетАлкоголяПоПроизводителям.Остатки(
		|			&Дата,
		|			СтруктурнаяЕдиница = &СтруктурнаяЕдиница И Фирма = &Фирма) КАК УчетАлкоголяПоПроизводителямОстатки
		|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|				НоменклатураДополнительныеРеквизиты.Ссылка КАК Ссылка,
		|				НоменклатураДополнительныеРеквизиты.Значение КАК Значение
		|			ИЗ
		|				Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
		|			ГДЕ
		|				НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоВидАлкогольнойПродукции) КАК ТабВидАлкогольнойПродукции
		|			ПО УчетАлкоголяПоПроизводителямОстатки.Номенклатура = ТабВидАлкогольнойПродукции.Ссылка
		|	ГДЕ
		|		НЕ ТабВидАлкогольнойПродукции.Значение ЕСТЬ NULL) КАК ВложенныйЗапрос
		|
		|СГРУППИРОВАТЬ ПО
		|	ВложенныйЗапрос.Номенклатура";
	КонецЕсли;
	
	РезультатЗапроса = Запрос.Выполнить();
	ТаблицаЗапроса = РезультатЗапроса.Выгрузить();
	
	Для Каждого СтрокаТаблицыЗапроса Из ТаблицаЗапроса Цикл
	
		Если флОбновления Тогда
			мсв=Объект.Состав.НайтиСтроки(Новый Структура("Номенклатура",СтрокаТаблицыЗапроса.Номенклатура));
			Если мсв.Количество()>0 Тогда
				СтрокаСостава = мсв[0];
				СтрокаСостава.КоличествоУчет = СтрокаТаблицыЗапроса.КоличествоУчетАлкоголя;
				СтрокаСостава.Количество = СтрокаТаблицыЗапроса.КоличествоОстаткиНоменклатуры;
				СтрокаСостава.КоличествоРазница = СтрокаСостава.Количество - СтрокаСостава.КоличествоУчет;
			КонецЕсли;
		Иначе
			СтрокаСостава = Объект.Состав.Добавить();
			СтрокаСостава.Номенклатура        = СтрокаТаблицыЗапроса.Номенклатура;
			СтрокаСостава.КоличествоУчет      = СтрокаТаблицыЗапроса.КоличествоУчетАлкоголя;
			СтрокаСостава.Количество      = СтрокаТаблицыЗапроса.КоличествоОстаткиНоменклатуры;
			СтрокаСостава.КоличествоРазница = СтрокаСостава.Количество - СтрокаСостава.КоличествоУчет;
		КонецЕсли;	
	
	КонецЦикла;
	
	//заполняем табличную часть "СоставПоПроизводителям"
	Запрос = Новый Запрос;
	
	Запрос.УстановитьПараметр("Фирма",Объект.Фирма);
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница",Объект.СтруктурнаяЕдиница);
	Запрос.УстановитьПараметр("Дата",Объект.Дата);
    Запрос.УстановитьПараметр("СвойствоВидАлкогольнойПродукции",ПланыВидовХарактеристик.ДополнительныеРеквизитыНоменклатуры.НайтиПоКоду(ОбщегоНазначения.ПолучитьЗначениеСвойстваСлужебногоЗначения(ПланыВидовХарактеристик.СлужебныеЗначения.КодРеквизитаВидАлкогольнойПродукции)));
	
	Если флОбновления Тогда
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	врСостав.Номенклатура
		|ПОМЕСТИТЬ врСостав
		|ИЗ
		|	&врСостав КАК врСостав
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	УчетАлкоголяПоПроизводителямОстатки.Номенклатура КАК Номенклатура,
		|	УчетАлкоголяПоПроизводителямОстатки.ВидАлкогольнойПродукции КАК ВидАлкогольнойПродукции,
		|	УчетАлкоголяПоПроизводителямОстатки.Производитель КАК Производитель,
		|	УчетАлкоголяПоПроизводителямОстатки.КоличествоОстаток КАК КоличествоОстаток
		|ИЗ
		|	РегистрНакопления.УчетАлкоголяПоПроизводителям.Остатки(
		|			&Дата,
		|			Номенклатура В
		|					(ВЫБРАТЬ
		|						с.Номенклатура
		|					ИЗ
		|						врСостав КАК с)
		|				И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
		|				И Фирма = &Фирма) КАК УчетАлкоголяПоПроизводителямОстатки
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			НоменклатураДополнительныеРеквизиты.Ссылка КАК Ссылка,
		|			НоменклатураДополнительныеРеквизиты.Значение КАК Значение
		|		ИЗ
		|			Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
		|		ГДЕ
		|			НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоВидАлкогольнойПродукции) КАК ТабВидАлкогольнойПродукции
		|		ПО УчетАлкоголяПоПроизводителямОстатки.Номенклатура = ТабВидАлкогольнойПродукции.Ссылка
		|ГДЕ
		|	НЕ ТабВидАлкогольнойПродукции.Значение ЕСТЬ NULL";
		
		Запрос.УстановитьПараметр("врСостав",Объект.Состав.Выгрузить());
	Иначе
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	УчетАлкоголяПоПроизводителямОстатки.Номенклатура КАК Номенклатура,
		|	УчетАлкоголяПоПроизводителямОстатки.ВидАлкогольнойПродукции КАК ВидАлкогольнойПродукции,
		|	УчетАлкоголяПоПроизводителямОстатки.Производитель КАК Производитель,
		|	УчетАлкоголяПоПроизводителямОстатки.КоличествоОстаток КАК КоличествоОстаток
		|ИЗ
		|	РегистрНакопления.УчетАлкоголяПоПроизводителям.Остатки(
		|			&Дата,
		|			СтруктурнаяЕдиница = &СтруктурнаяЕдиница
		|				И Фирма = &Фирма) КАК УчетАлкоголяПоПроизводителямОстатки
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			НоменклатураДополнительныеРеквизиты.Ссылка КАК Ссылка,
		|			НоменклатураДополнительныеРеквизиты.Значение КАК Значение
		|		ИЗ
		|			Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
		|		ГДЕ
		|			НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоВидАлкогольнойПродукции) КАК ТабВидАлкогольнойПродукции
		|		ПО УчетАлкоголяПоПроизводителямОстатки.Номенклатура = ТабВидАлкогольнойПродукции.Ссылка
		|ГДЕ
		|	НЕ ТабВидАлкогольнойПродукции.Значение ЕСТЬ NULL";
	КонецЕсли;
	
	РезультатЗапроса = Запрос.Выполнить();
	ТаблицаЗапроса = РезультатЗапроса.Выгрузить();
	
	Для Каждого СтрокаТаблицыЗапроса Из ТаблицаЗапроса Цикл
		Если флОбновления Тогда
			мсв=Объект.СоставПоПроизводителям.НайтиСтроки(Новый Структура("Номенклатура,ВидАлкогольнойПродукции,Производитель",СтрокаТаблицыЗапроса.Номенклатура,СтрокаТаблицыЗапроса.ВидАлкогольнойПродукции,СтрокаТаблицыЗапроса.Производитель));
			Если мсв.Количество()>0 Тогда
				СтрокаСостава = мсв[0];
				СтрокаСостава.КоличествоУчет = СтрокаТаблицыЗапроса.КоличествоОстаток;
				Если флПерезаполнятьФакт Тогда
					СтрокаСостава.Количество = СтрокаТаблицыЗапроса.КоличествоОстаток;
				КонецЕсли;	
			Иначе
				СтрокаСостава = Объект.СоставПоПроизводителям.Добавить();
				СтрокаСостава.Номенклатура        = СтрокаТаблицыЗапроса.Номенклатура;
				СтрокаСостава.ВидАлкогольнойПродукции = СтрокаТаблицыЗапроса.ВидАлкогольнойПродукции;
				СтрокаСостава.Производитель       = СтрокаТаблицыЗапроса.Производитель;
				СтрокаСостава.КоличествоУчет      = СтрокаТаблицыЗапроса.КоличествоОстаток;
				Если флПерезаполнятьФакт Тогда
					СтрокаСостава.Количество      = СтрокаТаблицыЗапроса.КоличествоОстаток;
				КонецЕсли;
			КонецЕсли;
		Иначе
			СтрокаСостава = Объект.СоставПоПроизводителям.Добавить();
			СтрокаСостава.Номенклатура        = СтрокаТаблицыЗапроса.Номенклатура;
			СтрокаСостава.ВидАлкогольнойПродукции = СтрокаТаблицыЗапроса.ВидАлкогольнойПродукции;
			СтрокаСостава.Производитель       = СтрокаТаблицыЗапроса.Производитель;
			СтрокаСостава.КоличествоУчет      = СтрокаТаблицыЗапроса.КоличествоОстаток;
			Если флПерезаполнятьФакт Тогда
				СтрокаСостава.Количество      = СтрокаТаблицыЗапроса.КоличествоОстаток;
			КонецЕсли;
		КонецЕсли;	
	КонецЦикла;
	
	//заполним табчасть СоставПоПроизводителям теми товарами, которых не нашли в алкогольном регистре
	Для Каждого СтрокаСостава Из Объект.Состав Цикл
		мсв=Объект.СоставПоПроизводителям.НайтиСтроки(Новый Структура("Номенклатура",СтрокаСостава.Номенклатура));
		Если мсв.Количество() = 0 Тогда
			СтрокаСоставаПоПроизводителям = Объект.СоставПоПроизводителям.Добавить();
			СтрокаСоставаПоПроизводителям.Номенклатура            = СтрокаСостава.Номенклатура;
			СтрокаСоставаПоПроизводителям.ВидАлкогольнойПродукции = УчетАлкогольнойПродукции.ОсновнойВидАлкогольнойПродукции(СтрокаСостава.Номенклатура);
			СтрокаСоставаПоПроизводителям.Производитель           = УчетАлкогольнойПродукции.ОсновнойПроизводительАлкогольнойПродукции(СтрокаСостава.Номенклатура);
			СтрокаСоставаПоПроизводителям.КоличествоУчет          = 0;
			СтрокаСоставаПоПроизводителям.Количество              = СтрокаСостава.Количество;
		КонецЕсли;
	КонецЦикла;

КонецПроцедуры	

&НаКлиенте
Процедура ЗаполнитьОстаткиПоПроизводителям(Команда)
	
	ТекСтрокаСостав = Элементы.Состав.ТекущиеДанные;
	
	Если ТекСтрокаСостав = Неопределено Тогда
		Возврат;
	КонецЕсли;	
	
	стрВопрос = "Производители по номенклатуре """+Строка(ТекСтрокаСостав.Номенклатура)+""" будут перезаполнены. Продолжить?";
	Если Вопрос(стрВопрос,РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;

	мсв = Объект.СоставПоПроизводителям.НайтиСтроки(Новый Структура("Номенклатура",ТекСтрокаСостав.Номенклатура));
	Для каждого эл из мсв Цикл
		Объект.СоставПоПроизводителям.Удалить(эл);
	КонецЦикла;	
	
	ОбновитьОстаткиПоПроизводителям(ТекСтрокаСостав.Номенклатура);
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьОстаткиПоПроизводителям(Номенклатура)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	УчетАлкоголяПоПроизводителямОстатки.Номенклатура КАК Номенклатура,
		|	УчетАлкоголяПоПроизводителямОстатки.ВидАлкогольнойПродукции КАК ВидАлкогольнойПродукции,
		|	УчетАлкоголяПоПроизводителямОстатки.Производитель КАК Производитель,
		|	УчетАлкоголяПоПроизводителямОстатки.КоличествоОстаток КАК КоличествоОстаток
		|ИЗ
		|	РегистрНакопления.УчетАлкоголяПоПроизводителям.Остатки(
		|			&Дата, Номенклатура = &Номенклатура
		|			    И СтруктурнаяЕдиница = &СтруктурнаяЕдиница
		|				И Фирма = &Фирма) КАК УчетАлкоголяПоПроизводителямОстатки
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			НоменклатураДополнительныеРеквизиты.Ссылка КАК Ссылка,
		|			НоменклатураДополнительныеРеквизиты.Значение КАК Значение
		|		ИЗ
		|			Справочник.Номенклатура.ДополнительныеРеквизиты КАК НоменклатураДополнительныеРеквизиты
		|		ГДЕ
		|			НоменклатураДополнительныеРеквизиты.Ссылка = &Номенклатура
		|			И НоменклатураДополнительныеРеквизиты.Свойство = &СвойствоВидАлкогольнойПродукции) КАК ТабВидАлкогольнойПродукции
		|		ПО УчетАлкоголяПоПроизводителямОстатки.Номенклатура = ТабВидАлкогольнойПродукции.Ссылка
		|ГДЕ
		|	НЕ ТабВидАлкогольнойПродукции.Значение ЕСТЬ NULL";
		
	Запрос.УстановитьПараметр("Фирма",Объект.Фирма);
	Запрос.УстановитьПараметр("СтруктурнаяЕдиница",Объект.СтруктурнаяЕдиница);
	Запрос.УстановитьПараметр("Номенклатура",Номенклатура);
	Запрос.УстановитьПараметр("Дата",Объект.Дата);
    Запрос.УстановитьПараметр("СвойствоВидАлкогольнойПродукции",ПланыВидовХарактеристик.ДополнительныеРеквизитыНоменклатуры.НайтиПоКоду(ОбщегоНазначения.ПолучитьЗначениеСвойстваСлужебногоЗначения(ПланыВидовХарактеристик.СлужебныеЗначения.КодРеквизитаВидАлкогольнойПродукции)));
	
	РезультатЗапроса = Запрос.Выполнить();
	ТаблицаЗапроса = РезультатЗапроса.Выгрузить();
	
	Для Каждого СтрокаТаблицыЗапроса Из ТаблицаЗапроса Цикл
		СтрокаСостава = Объект.СоставПоПроизводителям.Добавить();
		СтрокаСостава.Номенклатура        = СтрокаТаблицыЗапроса.Номенклатура;
		СтрокаСостава.ВидАлкогольнойПродукции = СтрокаТаблицыЗапроса.ВидАлкогольнойПродукции;
		СтрокаСостава.Производитель       = СтрокаТаблицыЗапроса.Производитель;
		СтрокаСостава.КоличествоУчет      = СтрокаТаблицыЗапроса.КоличествоОстаток;
		СтрокаСостава.Количество          = СтрокаТаблицыЗапроса.КоличествоОстаток;
	КонецЦикла;
	
	//заполним табчасть СоставПоПроизводителям теми товарами, которых не нашли в алкогольном регистре
	Для Каждого СтрокаСостава Из Объект.Состав Цикл
		мсв=Объект.СоставПоПроизводителям.НайтиСтроки(Новый Структура("Номенклатура",СтрокаСостава.Номенклатура));
		Если мсв.Количество() = 0 Тогда
			СтрокаСоставаПоПроизводителям = Объект.СоставПоПроизводителям.Добавить();
			СтрокаСоставаПоПроизводителям.Номенклатура            = СтрокаСостава.Номенклатура;
			СтрокаСоставаПоПроизводителям.ВидАлкогольнойПродукции = УчетАлкогольнойПродукции.ОсновнойВидАлкогольнойПродукции(СтрокаСостава.Номенклатура);
			СтрокаСоставаПоПроизводителям.Производитель           = УчетАлкогольнойПродукции.ОсновнойПроизводительАлкогольнойПродукции(СтрокаСостава.Номенклатура);
			СтрокаСоставаПоПроизводителям.КоличествоУчет          = 0;
			СтрокаСоставаПоПроизводителям.Количество              = СтрокаСостава.Количество;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказатьГруппыВПодборе(Команда)
	элементы.кнГруппы.пометка = не элементы.кнГруппы.пометка;
	флаг = Элементы.кнГруппы.пометка;
	ВЫполнить("ОбработкаТабличныхЧастейКлиент.ОтображениеГрупп(ПодборНоменклатуры,флаг)");
КонецПроцедуры

&НаКлиенте
Процедура УбратьГруппыИзПодбора(Команда)
	выполнить("ОбработкаТабличныхЧастейКлиент.ОтображениеГрупп(ПодборНоменклатуры,ВидСравненияКомпоновкиДанных.Равно)");
КонецПроцедуры


&НаКлиенте
Процедура ПодборЗакрыть(Команда)
	Элементы.ГруппаПодбор.Видимость  = Ложь;
КонецПроцедуры

&НаКлиенте
Процедура Дерево(Команда)
	обработкатабличныхчастейклиент.ОтображениеДинамическогоСпискаДерево(ЭтаФорма);	
КонецПроцедуры

&НаКлиенте
Процедура Иерархия(Команда)
	обработкатабличныхчастейклиент.отображениединамическогоспискаиерархия(этаформа);	
КонецПроцедуры

&НаКлиенте
Процедура Список(Команда)
	обработкатабличныхчастейклиент.ОтображениеДинамическогоСпискаСписок(этаформа);	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	загрузитьНастройкиПодбора();
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПоОстаткам(Команда)
	Если Объект.Состав.Количество() > 0 Тогда
		стрВопрос = "Табличная часть будет перезаполнена. Продолжить?";
		Если Вопрос(стрВопрос,РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	Объект.Состав.Очистить();
	Объект.СоставПоПроизводителям.Очистить();
	ОбновитьОстаткиСервер(Ложь,Истина);
	Элементы.Состав.ТекущаяСтрока = 0;
КонецПроцедуры

Процедура ПриЗакрытии()
	СохранитьПараметрыПодбора();
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	ОбщегоНазначенияКлиент.АктивизироватьОсновноеОкноКлиентскогоПриложения();
КонецПроцедуры

&НаКлиенте
Процедура НастройкаПодбора(Команда)
	ПараметрыПодбора = ОткрытьФормуМодально("ОбщаяФорма.НастройкаПодбора", Новый Структура("ЗапрашиватьКоличество", ЗапрашиватьКоличество));
	ЗапрашиватьКоличество = ПараметрыПодбора.ЗапрашиватьКоличество;
КонецПроцедуры

&НаКлиенте
Процедура СоставПриАктивизацииСтроки(Элемент)
	
	Если Элементы.Состав.ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;	
	
	УстановитьОтборПоНоменклатуреВСоставПоФирмам(Элементы.Состав.ТекущиеДанные.Номенклатура);

КонецПроцедуры

&НаКлиенте
Процедура УстановитьОтборПоНоменклатуреВСоставПоФирмам(текНоменклатура)
	
	Элементы.СоставПоПроизводителям.ОтборСтрок= Новый ФиксированнаяСтруктура("Номенклатура",текНоменклатура);
	
КонецПроцедуры

&НаКлиенте
Процедура СоставПоПроизводителямПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	
	Если НоваяСтрока Тогда
		ТекущиеДанные = Элементы.Состав.ТекущиеДанные;
		Если Не ТекущиеДанные = Неопределено Тогда					
			Элемент.Текущиеданные.Номенклатура            = ТекущиеДанные.Номенклатура;
			Элемент.Текущиеданные.ВидАлкогольнойПродукции = ОсновнойВидАлкогольнойПродукции(ТекущиеДанные.Номенклатура);
			Элемент.Текущиеданные.Производитель           = ОсновнойПроизводительАлкогольнойПродукции(ТекущиеДанные.Номенклатура);
		КонецЕсли;	
	КонецЕсли;
	
	Если Копирование Тогда
		Элемент.Текущиеданные.КоличествоУчет = 0;
		Элемент.Текущиеданные.Количество     = 0;
	КонецЕсли;

КонецПроцедуры

&НаСервере
Функция ОсновнойВидАлкогольнойПродукции(ТекНоменклатура)
    Возврат УчетАлкогольнойПродукции.ОсновнойВидАлкогольнойПродукции(ТекНоменклатура);
КонецФункции

&НаСервере
Функция ОсновнойПроизводительАлкогольнойПродукции(ТекНоменклатура)
    Возврат УчетАлкогольнойПродукции.ОсновнойПроизводительАлкогольнойПродукции(ТекНоменклатура);
КонецФункции

&НаКлиенте
Процедура СоставПоПроизводителямПриИзменении(Элемент)
	// Вставить содержимое обработчика.
КонецПроцедуры

&НаКлиенте
Процедура СоставПередУдалением(Элемент, Отказ)
	
	ТекСтрокаСостав = Элементы.Состав.ТекущиеДанные;
	мсв = Объект.СоставПоПроизводителям.НайтиСтроки(Новый Структура("Номенклатура",ТекСтрокаСостав.Номенклатура));
	Для каждого эл из мсв Цикл
		Объект.СоставПоПроизводителям.Удалить(эл);
	КонецЦикла;	
	
КонецПроцедуры

&НаКлиенте
Процедура СоставПоПроизводителямКоличествоПриИзменении(Элемент)
	
	ТекСтрокаСостав = Элементы.Состав.ТекущиеДанные;
	МаксимальноеКоличество = ТекСтрокаСостав.Количество;
	ИтоговоеКоличество = 0;
	
	мсв = Объект.СоставПоПроизводителям.НайтиСтроки(Новый Структура("Номенклатура",ТекСтрокаСостав.Номенклатура));
	Для каждого эл из мсв Цикл
		ИтоговоеКоличество = ИтоговоеКоличество + эл.Количество;
	КонецЦикла;
	
	Если ИтоговоеКоличество > МаксимальноеКоличество Тогда
		Состояние("Для номенклатуры """+Строка(ТекСтрокаСостав.Номенклатура)+""" итог фактического количества по производителям не может превышать "+Строка(МаксимальноеКоличество),,,БиблиотекаКартинок.Предупреждение32);
		//Предупреждение("Для номенклатуры """+Строка(ТекСтрокаСостав.Номенклатура)+""" итог фактического количества по производителям не может превышать "+Строка(МаксимальноеКоличество));
		Элементы.СоставПоПроизводителям.ТекущиеДанные.Количество = 0;
	КонецЕсли;
	
КонецПроцедуры

//&НаКлиенте
//Процедура СкладПриИзменении(Элемент)
//	Установитьпараметры();
//КонецПроцедуры

                                                            




