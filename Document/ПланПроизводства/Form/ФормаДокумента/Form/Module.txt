&НаКлиенте
Процедура ЕдиницаИзмеренияПриИзменении(Элемент)
	ОбработкаТабличныхЧастейКлиент.ПриИзмененииЕдиницыИзмеренияВТабличнойЧасти(ЭтаФорма);
КонецПроцедуры

&НаСервере
Процедура ПриЗагрузкеДанныхИзНастроекНаСервере(Настройки)
	Если Элементы.Найти("ПодборНоменклатуры")<>Неопределено тогда
		Значение = Настройки.Получить("ОтображениеТаблицыПодбор");
		Если Значение<>Неопределено тогда
			Элементы.ПодборНоменклатуры.Отображение = Значение;
		конецесли;
	конецесли;
	Если ЗначениеЗаполнено(Объект.Ссылка) или ЗначениеЗаполнено(Параметры.Основание) или ЗначениеЗаполнено(Параметры.ЗначениеКопирования) Тогда
		Настройки.Очистить();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПриСохраненииДанныхВНастройкахНаСервере(Настройки)
	Если Элементы.Найти("ПодборНоменклатуры")<>Неопределено тогда
		Настройки.вставить("ОтображениеТаблицыПодбор",элементы.подборНоменклатуры.Отображение);
	конецесли;
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Если ПараметрыСеанса.ЭтоЦентр Тогда
		ТолькоПросмотр = РаботаСФормамиСервер.ЗапрещеноРедактировать(Объект.Ссылка,ЭтаФорма);
	Иначе
		ТолькоПросмотр = Истина;
	КонецЕсли;	
	ОбщегоНазначенияСервер.ЗапретМодификацииОбъектов(ЭтаФорма);
	ДополнительныеОтчетыИОбработки.ПриСозданииНаСервере(ЭтаФорма);
КонецПроцедуры

//Процедуры и функции для организации подбора
&НаКлиенте
Процедура ПодборНоменклатурыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	Для Каждого Строка Из Элемент.ВыделенныеСтроки Цикл
		ТекСтрока = ОбработкаТабличныхЧастейКлиент.ЗаполнитьИзПодбора(ЭтаФорма,Объект,Элемент.ДанныеСтроки(Строка),Элементы.состав,СтандартнаяОбработка);
		Если ТекСтрока <> Неопределено Тогда
			ЗаполнитьРаспределение(ТекСтрока.Номенклатура,ТекСтрока.ЕдиницаИзмерения,ТекСтрока.Коэффициент,ТекСтрока.Ключ);
		КонецЕсли;	
	КонецЦикла;	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьРаспределение(Номенклатура,ЕдиницаИзмерения,Коэффициент,Ключ)
	Отбор = Новый Структура;
	Отбор.Вставить("Ключ",Ключ);
	Массив = Объект.Распределение.НайтиСтроки(Отбор);
	Если Массив.Количество() = 0 Тогда
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	СтатусыНоменклатуры.СтруктурнаяЕдиница
			|ИЗ
			|	РегистрСведений.СтатусыНоменклатуры КАК СтатусыНоменклатуры
			|ГДЕ
			|	СтатусыНоменклатуры.Статус = &Статус
			|	И СтатусыНоменклатуры.Номенклатура = &Номенклатура";

		Запрос.УстановитьПараметр("Номенклатура", Номенклатура);
		Запрос.УстановитьПараметр("Статус", Перечисления.СтатусыТоваров.Активный);

		Результат = Запрос.Выполнить();

		ВыборкаДетальныеЗаписи = Результат.Выбрать();

		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			НоваяСтрока = Объект.Распределение.Добавить();
			НоваяСтрока.Номенклатура = Номенклатура;
			НоваяСтрока.СтруктурнаяЕдиница = ВыборкаДетальныеЗаписи.СтруктурнаяЕдиница;
			НоваяСтрока.ЕдиницаИзмерения = ЕдиницаИзмерения;
			НоваяСтрока.Коэффициент = Коэффициент;
			НоваяСтрока.Ключ = Ключ;
		КонецЦикла;
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура ПодборОткрыть(Команда)
	Элементы.ГруппаПодбор.Видимость = НЕ Элементы.ГруппаПодбор.Видимость;
КонецПроцедуры

&НаКлиенте
Процедура СоставПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	Отказ = Истина;
	ПодборОткрыть(Неопределено);
КонецПроцедуры

 &НаКлиенте
Процедура ПоказатьГруппыВПодборе(Команда)
	элементы.кнГруппы.пометка = не элементы.кнГруппы.пометка;
	флаг = Элементы.кнГруппы.пометка;
	ВЫполнить("ОбработкаТабличныхЧастейКлиент.ОтображениеГрупп(ПодборНоменклатуры,флаг)");
КонецПроцедуры

 &НаСервере
Процедура Сохранитьпараметрыподбора()
	ПОдборНоменклатурыСервер.СохранитьПараметрыПодбора(Объект.Ссылка.Метаданные().имя,ЭтаФорма.ИмяФормы,ЭтаФорма.Элементы);
конецпроцедуры

&НаСервере
Функция получитьНастройкуПодбора()
	возврат подборНоменклатурыСервер.ПолучитьНастройкуподбора(Объект.Ссылка.Метаданные().Имя,ЭтаФорма.ИмяФормы);	
конецфункции

&НаКлиенте
процедура ЗагрузитьНастройкиПодбора()
		Настройки = ПолучитьНастройкуПодбора();
		ОбработкаТабличныхЧастейКлиент.загрузитьнастройкиподбора(ЭтаФорма,Настройки);
конецпроцедуры

&НаКлиенте
Процедура ПодборЗакрыть(Команда)
	Элементы.ГруппаПодбор.Видимость  = Ложь;
КонецПроцедуры


&НаКлиенте
Процедура Дерево(Команда)
	обработкатабличныхчастейклиент.ОтображениеДинамическогоСпискаДерево(ЭтаФорма);	
КонецПроцедуры


&НаКлиенте
Процедура Иерархия(Команда)
	обработкатабличныхчастейклиент.отображениединамическогоспискаиерархия(этаформа);	
КонецПроцедуры


&НаКлиенте
Процедура Список(Команда)
	обработкатабличныхчастейклиент.ОтображениеДинамическогоСпискаСписок(этаформа);	
КонецПроцедуры


//Конец Процедуры и функции для организации подбора

&НаКлиенте
Процедура УправлениеДоступностьюЭлементов()
	Элементы.ГруппаПодбор.Видимость  = ?(Не ЗначениеЗаполнено(Объект.Склад),Ложь,Элементы.ГруппаПодбор.Видимость);
конецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	УправлениеДоступностьюЭлементов();
	Установитьпараметры();
	загрузитьНастройкиПодбора();
КонецПроцедуры

&НаКлиенте
Процедура СкладПриИзменении(Элемент)
	УправлениеДоступностьюЭлементов();
	Установитьпараметры();
КонецПроцедуры

Процедура Установитьпараметры()
	ПодборНоменклатуры.Параметры.установитьзначениепараметра("СтруктурнаяЕдиница",Объект.Склад.Владелец);
	ПодборНоменклатуры.Параметры.установитьзначениепараметра("Склад",Объект.Склад);
конецпроцедуры

&НаКлиенте
Процедура СоставПриАктивизацииСтроки(Элемент)
	Если Элемент.ТекущиеДанные <> Неопределено Тогда
		Элементы.Распределение.ОтборСтрок = Новый ФиксированнаяСтруктура("Ключ", Элемент.ТекущиеДанные.Ключ);
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура РаспределениеКоличествоПриИзменении(Элемент)
	РаспределениеТекущиеДанные = Элементы.Распределение.ТекущиеДанные;
	Отбор = Новый Структура;
	Отбор.Вставить("Ключ",РаспределениеТекущиеДанные.Ключ);
	Массив = Объект.Распределение.НайтиСтроки(Отбор);
	Итог = 0;
	Для I=0 по Массив.Количество()-1 Цикл
		Итог = Итог+Массив[I][Элемент.Имя];
	КонецЦикла;	
	РаспределениеТекущиеДанные.Итого = 
	РаспределениеТекущиеДанные.Понедельник + 
	РаспределениеТекущиеДанные.Вторник +
	РаспределениеТекущиеДанные.Среда +
	РаспределениеТекущиеДанные.Четверг +
	РаспределениеТекущиеДанные.Пятница +
	РаспределениеТекущиеДанные.Суббота +
	РаспределениеТекущиеДанные.Воскресенье;
	
	Массив = Объект.Состав.НайтиСтроки(Отбор);
	ТекущаяСтрока = Массив[0];
	ТекущаяСтрока[Элемент.Имя] = Итог;
	ТекущаяСтрока.Итого = 
	ТекущаяСтрока.Понедельник + 
	ТекущаяСтрока.Вторник +
	ТекущаяСтрока.Среда +
	ТекущаяСтрока.Четверг +
	ТекущаяСтрока.Пятница +
	ТекущаяСтрока.Суббота +
	ТекущаяСтрока.Воскресенье;
КонецПроцедуры

&НаКлиенте
Процедура СоставПередУдалением(Элемент, Отказ)
	Отбор = Новый Структура;
	Отбор.Вставить("Ключ",Элементы.Состав.ТекущиеДанные.Ключ);
	Массив = Объект.Распределение.НайтиСтроки(Отбор);
	Для I=0 по Массив.Количество()-1 Цикл
		Объект.Распределение.Удалить(Массив[I]);
	КонецЦикла;	
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии()
	СохранитьПараметрыПодбора();
КонецПроцедуры
