Процедура ОбработкаПроведения(Отказ, Режим)
	Движение = Движения.ДенежныеСредства.Добавить();
	Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
	Движение.Период = Дата;
	Движение.ДенежнаяЯчейка = Касса;
	Движение.Фирма = Фирма;
	Движение.Сумма = Сумма;
	Движение.КлассификаторДДС = КлассификаторДДС;
	Движение.Валюта = Валюта;
	Если КлассификаторДДС = ПланыВидовХарактеристик.КлассификаторДДС.РасчетыСПодотчетниками или КлассификаторДДС = ПланыВидовХарактеристик.КлассификаторДДС.ОперацииСККМ Тогда
		Движение = Движения.ДенежныеСредства.Добавить();
		Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
		Движение.Период = Дата;
		Движение.ДенежнаяЯчейка = Аналитика;
		Движение.Фирма = Фирма;
		Движение.Сумма = Сумма;
		Движение.КлассификаторДДС = КлассификаторДДС;
		Движение.Валюта = Валюта;
	КонецЕсли;	
КонецПроцедуры

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, СтандартнаяОбработка)
	
	Если ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ПриходнаяНакладная") Тогда
		
		Фирма            = ДанныеЗаполнения.Фирма;
		Основание        = ДанныеЗаполнения;
		ДокОснование     = ДанныеЗаполнения;
		Сумма            = ДанныеЗаполнения.СуммаИтого;
		СтавкаНДС        = ОбщегоНазначенияСервер.ПолучитьОсновнуюСтавкуНДС();
		СуммаНДС         = Окр(Сумма * СтавкаНДС.Ставка / (100 + СтавкаНДС.Ставка),2);
		ТипДоговора      = ДанныеЗаполнения.ТипДоговора;
		КлассификаторДДС = ПланыВидовХарактеристик.КлассификаторДДС.РасчетыСПоставщиками;
        Аналитика        = ДанныеЗаполнения.Контрагент;
		
	ИначеЕсли ТипЗнч(ДанныеЗаполнения) = Тип("ДокументСсылка.ВозвратнаяНакладнаяОтПокупателя") Тогда
		
		Фирма            = ДанныеЗаполнения.Фирма;
		Основание        = ДанныеЗаполнения;
		ДокОснование     = ДанныеЗаполнения;
		Сумма            = ДанныеЗаполнения.СуммаИтого;
		СтавкаНДС        = ОбщегоНазначенияСервер.ПолучитьОсновнуюСтавкуНДС();
		СуммаНДС         = Окр(Сумма * СтавкаНДС.Ставка / (100 + СтавкаНДС.Ставка),2);
		ТипДоговора      = ДанныеЗаполнения.ТипДоговора;
		КлассификаторДДС = ПланыВидовХарактеристик.КлассификаторДДС.РасчетыСПоставщиками;
        Аналитика        = ДанныеЗаполнения.Контрагент;
		
	КонецЕсли;	
	
	ИнициализироватьДокумент();
КонецПроцедуры

Процедура ИнициализироватьДокумент()
	Автор = ПараметрыСеанса.ТекущийПользователь;
	Если Не ЗначениеЗаполнено(Валюта) Тогда
		Если ТипЗнч(Аналитика) = ТипЗнч("СправочникСсылка.Контрагенты") И ЗначениеЗаполнено(Аналитика.Валюта) Тогда
			Валюта = Аналитика.Валюта;
		Иначе
			Валюта = СтруктурныеЕдиницы.ПолучитьВалютуТекущейСЕ();
		КонецЕсли;
		
		СтруктураКурса = РаботаСКурсамиВалют.ЗаполнитьДанныеКурсаДляВалюты(Валюта);
		Курс = СтруктураКурса.Курс;
		Кратность = СтруктураКурса.Кратность;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(КлассификаторДДС) Тогда
		КлассификаторДДС = ПланыВидовХарактеристик.КлассификаторДДС.РасчетыСПодотчетниками;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(СтавкаНДС) Тогда
		СтавкаНДС = ОбщегоНазначенияСервер.ПолучитьОсновнуюСтавкуНДС();
	КонецЕсли;
	
	Если не ЗначениеЗаполнено(Касса) Тогда
		
		Запрос = Новый Запрос(
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	КассыФирмы.Ссылка
		|ИЗ
		|	Справочник.КассыФирмы КАК КассыФирмы
		|ГДЕ
		|	(НЕ КассыФирмы.ПометкаУдаления)");
		Выборка = Запрос.Выполнить().Выбрать();
		Выборка.Следующий();
		Касса =  Выборка.Ссылка;
		
	КонецЕсли;	
	Если НЕ ЗначениеЗаполнено(СтруктурнаяЕдиница) И НЕ ПараметрыСеанса.ТекущаяСтруктурнаяЕдиница.ЭтоГруппа Тогда
		СтруктурнаяЕдиница = ПараметрыСеанса.ТекущаяСтруктурнаяЕдиница;
	КонецЕсли;
КонецПроцедуры

Процедура ПриКопировании(ОбъектКопирования)
	Автор = ПараметрыСеанса.ТекущийПользователь;
КонецПроцедуры

Процедура ОбработкаПроверкиЗаполнения(Отказ, ПроверяемыеРеквизиты)
	Если КлассификаторПокупательПоставщик(ЭтотОбъект.КлассификаторДДС) Тогда
		ПроверяемыеРеквизиты.Добавить("ТипДоговора");
	КонецЕсли;
	Если НЕ ЭтотОбъект.КлассификаторДДС = ПредопределенноеЗначение("ПланВидовХарактеристик.КлассификаторДДС.ПрочиеВыплатыИПоступления") ИЛИ ЗначениеЗаполнено(ЭтотОбъект.СтатьяДвиженияДенежныхСредств.ТипАналитики) Тогда
		ПроверяемыеРеквизиты.Добавить("Аналитика");
	КонецЕсли;	
КонецПроцедуры
	
Функция КлассификаторПокупательПоставщик(КлассификаторДДС)
	Да = КлассификаторДДС = ПланыВидовХарактеристик.КлассификаторДДС.РасчетыСПокупателями
	ИЛИ КлассификаторДДС = ПланыВидовХарактеристик.КлассификаторДДС.РасчетыСПоставщиками;
	Возврат Да;
КонецФункции



