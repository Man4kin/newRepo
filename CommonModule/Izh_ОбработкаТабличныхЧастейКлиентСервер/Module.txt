
//{ СИТЕК БрыляковЕЮ 2014-10-02  
Процедура РассчитатьСуммуВСтрокеТабличнойЧасти(СтрокаТЧ) Экспорт 
	
	НовыеЗначения = Новый Структура("Цена, ЦенаУпр, ЦенаБезНДС, СтавкаНДС, Сумма, СуммаУпр, СуммаБезНДС, СуммаНДСУпр, СуммаНДС, Количество");
	ЗаполнитьЗначенияСвойств(НовыеЗначения, СтрокаТЧ);
	
	Для каждого Реквизит Из НовыеЗначения Цикл
		Если Реквизит.Значение = Неопределено Тогда
			НовыеЗначения.Удалить(Реквизит.Ключ);
		КонецЕсли;
	КонецЦикла;
	
	Если НовыеЗначения.Свойство("ЦенаУпр") И НовыеЗначения.Свойство("СуммаУпр") Тогда
		НовыеЗначения.СуммаУпр = НовыеЗначения.Количество * НовыеЗначения.ЦенаУпр;
	КонецЕсли;
	
	Если НовыеЗначения.Свойство("СтавкаНДС") Тогда
	
		СуммаВключаетНДС = ОбщегоНазначенияСервер.ПолучитьЗначениеКонстанты("ВключатьНДСВЦеныКонтрагентов");
		СтавкаНДС = ОбщегоНазначенияСервер.ПолучитьСтавкуНДС(НовыеЗначения.СтавкаНДС);
		
		Цена = ?(НЕ СуммаВключаетНДС И НовыеЗначения.Свойство("ЦенаБезНДС"), НовыеЗначения.ЦенаБезНДС, НовыеЗначения.Цена);
		
		Сумма = Окр(НовыеЗначения.Количество * Цена, 2);
		СуммаНДС = Окр(РассчитатьСуммуНДС(Сумма, СуммаВключаетНДС, СтавкаНДС), 2);
		
		Если СуммаВключаетНДС Тогда
			СуммаСНДС = Сумма;
			СуммаБезНДС = Сумма - СуммаНДС;
		Иначе
			СуммаСНДС = Сумма + СуммаНДС;
			СуммаБезНДС = Сумма;
		КонецЕсли;
		
		Если НовыеЗначения.Количество = 0 Тогда
			НовыеЗначения.Удалить("Цена");
			НовыеЗначения.Удалить("ЦенаБезНДС");
		Иначе
			Если СуммаВключаетНДС Тогда
				ЦенаСНДС = Цена;
				ЦенаБезНДС = СуммаБезНДС / НовыеЗначения.Количество;
			Иначе
				ЦенаСНДС = СуммаСНДС / НовыеЗначения.Количество;
				ЦенаБезНДС = Цена;
			КонецЕсли;
		КонецЕсли;
		
		ЗаполнитьЗначенияСвойств(НовыеЗначения, Новый Структура(
			"Цена, ЦенаБезНДС, Сумма, СуммаБезНДС, СуммаНДС",
			ЦенаСНДС, ЦенаБезНДС, СуммаСНДС, СуммаБезНДС, СуммаНДС
		));
		
		Если НовыеЗначения.Свойство("СуммаНДСУпр") И СуммаВключаетНДС Тогда
			НовыеЗначения.СуммаНДСУпр = РассчитатьСуммуНДС(НовыеЗначения.СуммаНДСУпр, СуммаВключаетНДС, СтавкаНДС);
		КонецЕсли;
		
	Иначе
		
		НовыеЗначения.Сумма = НовыеЗначения.Количество * НовыеЗначения.Цена;
		
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(СтрокаТЧ, НовыеЗначения);
	
КонецПроцедуры

Функция РассчитатьСуммуНДС(Сумма, СуммаВключаетНДС, СтавкаНДС) Экспорт
	
	Если СуммаВключаетНДС Тогда
		СуммаБезНДС = 100 * Сумма / (100 + СтавкаНДС);
		СуммаНДС = Сумма - СуммаБезНДС;
	Иначе
		СуммаБезНДС = Сумма;
	КонецЕсли;
	
	Если НЕ СуммаВключаетНДС Тогда
		СуммаНДС = СуммаБезНДС * СтавкаНДС / 100;
	КонецЕсли;
	
	Возврат СуммаНДС;
	
КонецФункции
// СИТЕК БрыляковЕЮ 2014-10-02 }

//{ ВетровИА 26.03.2015 Наряд №000145346
&НаСервере
Функция ПроверитьНаПравилоПерепродажи(Объект) Экспорт
	Отказ = Ложь;
	МассивНоменклатуры = Объект.Состав.ВыгрузитьКолонку("Номенклатура");
	тзРезультат = РегистрыСведений.Перепродажа.ПравилаПерепродажи(МассивНоменклатуры, Объект.Контрагент, Объект.Фирма, Объект.Дата);	
	
	Если тзРезультат.Количество() <> 0 Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		               |	ТЗРезультат.Номенклатура,
		               |	ТЗРезультат.ФирмаПолучатель	
		               |ПОМЕСТИТЬ ТЗПоФирмамПолучателям
		               |ИЗ
		               |	&ТЗРезультат КАК ТЗРезультат
		               |;
					   
					   |ВЫБРАТЬ
		               |	ТЗСостав.Номенклатура
		               |ПОМЕСТИТЬ ТЗСоставНоменклатуры
		               |ИЗ
		               |	&ТЗСостав КАК ТЗСостав
		               |;

					|///////////////////////////////////////
					|ВЫБРАТЬ
					|   ТЗСоставНоменклатуры.Номенклатура,
	                |	ЕСТЬNULL(ТЗПоФирмамПолучателям.ФирмаПолучатель, 0) КАК ФирмаПолучатель 
	                |ИЗ
	                |	ТЗСоставНоменклатуры
				    |ЛЕВОЕ СОЕДИНЕНИЕ ТЗПоФирмамПолучателям ПО 
				    |	(ТЗПоФирмамПолучателям.Номенклатура = ТЗСоставНоменклатуры.Номенклатура)
				  	|УПОРЯДОЧИТЬ ПО ФирмаПолучатель
					|ИТОГИ 
					|	КОЛИЧЕСТВО(ФирмаПолучатель)
					|ПО
					|	ФирмаПолучатель
					|";
		Запрос.УстановитьПараметр("ТЗРезультат", тзРезультат);
		Запрос.УстановитьПараметр("ТЗСостав", Объект.Состав.Выгрузить());
		ВыборкаЗапроса = Запрос.Выполнить();
		ВыборкаЗапроса = ВыборкаЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
		ВыборкаЗапроса.Следующий();
		ВыборкаЗапросаНоменклатура = ВыборкаЗапроса.Выбрать(); 
		
		Отбор = Новый Структура("ФирмаПолучатель", тзРезультат[0].ФирмаПолучатель);
		Строки = тзРезультат.НайтиСтроки(Отбор);
		Если Строки.Количество() <> Объект.Состав.Количество() Тогда
			Сообщить("Табличная часть содержит товары групп различных правил перепродажи. Разделите заказ.");
			Пока ВыборкаЗапросаНоменклатура.Следующий() Цикл
				Сообщить(ВыборкаЗапросаНоменклатура.Номенклатура);	
			КонецЦикла;	
			Отказ = Истина;
		КонецЕсли	
	КонецЕсли;
	Возврат Отказ;
КонецФункции
// ВетровИА 26.03.2015 Наряд №000145346}

//{ ВетровИА 23.06.2015 Наряд №000154451
&НаСервере
Функция  ПроверитьНаОграниченияПоВозвратамИСписаниям(Объект) Экспорт
	
	Отказ = Ложь;	
	
	МассивНоменклатуры = Объект.Состав.ВыгрузитьКолонку("Номенклатура");
	тзРезультат = РегистрыСведений.Izh_ОграниченияПоВозвратамИСписаниям.ОграниченияПоВозвратамИСписаниям(МассивНоменклатуры, ПараметрыСеанса.ТекущаяСтруктурнаяЕдиница, Объект.Дата);	
	
	Если тзРезультат.Количество() <> 0 Тогда
		
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ
		              	|	ТЗРезультат.Номенклатура,
		               	|	ТЗРезультат.ЗапрещенВозвратНаРЦ,
						|	ТЗРезультат.ЗапрещеноСписаниеВМагазине,
						|	ТЗРезультат.ЗапрещеноПеремещениеМеждуМагазинами
		               |ПОМЕСТИТЬ ТЗПоОграничениям
		               |ИЗ
		               |	&ТЗРезультат КАК ТЗРезультат
		               |;
					   
					   |ВЫБРАТЬ
		               |	ТЗСостав.Номенклатура
		               |ПОМЕСТИТЬ ТЗСоставНоменклатуры
		               |ИЗ
		               |	&ТЗСостав КАК ТЗСостав
		               |;

					|///////////////////////////////////////
					|ВЫБРАТЬ
					|   ТЗСоставНоменклатуры.Номенклатура,
	                |	ТЗПоОграничениям.ЗапрещенВозвратНаРЦ,
					|	ТЗПоОграничениям.ЗапрещеноСписаниеВМагазине,
					|	ТЗПоОграничениям.ЗапрещеноПеремещениеМеждуМагазинами
	                |ИЗ
	                |	ТЗСоставНоменклатуры
				    |ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТЗПоОграничениям ПО 
				    |	(ТЗПоОграничениям.Номенклатура = ТЗСоставНоменклатуры.Номенклатура)";
		Запрос.УстановитьПараметр("ТЗРезультат", тзРезультат);
		Запрос.УстановитьПараметр("ТЗСостав", Объект.Состав.Выгрузить());
		ВыборкаЗапроса = Запрос.Выполнить().Выгрузить();
		
		Если ТипЗнч(Объект.Ссылка) = Тип("ДокументСсылка.РасходнаяНакладная") Тогда
			Для Каждого СтрокаВыборкаЗапроса ИЗ ВыборкаЗапроса Цикл 
				Если (Объект.Контрагент.Код = 1) И (СтрокаВыборкаЗапроса.ЗапрещенВозвратНаРЦ) Тогда
					Сообщить("По номенклатуре " + СтрокаВыборкаЗапроса.Номенклатура + " запрещен возврат на РЦ.");	
					Отказ = Истина;	
				ИначеЕсли СтрокаВыборкаЗапроса.ЗапрещеноПеремещениеМеждуМагазинами Тогда
					Сообщить("По номенклатуре " + СтрокаВыборкаЗапроса.Номенклатура + " запрещено перемещение между магазинами.");	
					Отказ = Истина;	
				КонецЕсли;
			КонецЦикла
		ИначеЕсли ТипЗнч(Объект.Ссылка) = Тип("ДокументСсылка.КоррекцияЗапасов") Тогда
			Для Каждого СтрокаВыборкаЗапроса ИЗ ВыборкаЗапроса Цикл 
				Если СтрокаВыборкаЗапроса.ЗапрещеноСписаниеВМагазине Тогда
					Сообщить("По номенклатуре " + СтрокаВыборкаЗапроса.Номенклатура + " запрещено списание в магазине.");	
					Отказ = Истина;			
				КонецЕсли;
			КонецЦикла	
		КонецЕсли;	
	КонецЕсли;
	Возврат Отказ;	
КонецФункции
// ВетровИА 23.06.2015 Наряд №000154451 }

