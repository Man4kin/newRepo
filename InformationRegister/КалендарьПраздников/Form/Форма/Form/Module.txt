
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	НомерТекущегоГода		= Год(ТекущаяДатаСеанса());
	Элементы.Календарь.НачалоПериодаОтображения	= Дата(НомерТекущегоГода, 1, 1);
	Элементы.Календарь.КонецПериодаОтображения	= Дата(НомерТекущегоГода, 12, 31);
	ТаблицаРегистра.Загрузить(ПолучитьПраздники(НомерТекущегоГода));
КонецПроцедуры

&НаКлиенте
Процедура Заполнить(Команда)
	Год = Год(ТекущаяДата());
	Если ВвестиЧисло(Год,"Введите год",4,0) Тогда
		ЗаполнитьНаСервере(Год);
		ЭтаФорма.ОбновитьОтображениеДанных();
	КонецЕсли;	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьНаСервере(Год)
	Набор = РегистрыСведений.КалендарьПраздников.СоздатьНаборЗаписей();
	Набор.Отбор.Год.Установить(Год);
	Набор.Прочитать();
	Набор.Очистить();
	Набор.Записать();
	
	Макет = РегистрыСведений.КалендарьПраздников.ПолучитьМакет("Макет");
	Для R=1 по Макет.ВысотаТаблицы Цикл
		День = Макет.Область("R"+R+"C1").Текст;
		Месяц = Макет.Область("R"+R+"C2").Текст;
		Название = Макет.Область("R"+R+"C3").Текст;
		ДатаКалендаря = Дата(Год,Месяц,День);
		Если НЕ ЗначениеЗаполнено(ДатаКалендаря) Тогда
			Прервать;
		КонецЕсли;
		Праздник = Справочники.Праздники.НайтиПоНаименованию(Название);
		Если Праздник.Пустая() Тогда
			ПраздникОбъект = Справочники.Праздники.СоздатьЭлемент();
			ПраздникОбъект.Наименование = Название;
			ПраздникОбъект.Записать();
			Праздник = ПраздникОбъект.Ссылка;
		КонецЕсли;	
		
		
		Запись = РегистрыСведений.КалендарьПраздников.СоздатьМенеджерЗаписи();
		Запись.ДатаКалендаря = ДатаКалендаря;
		Запись.Год = Год;
		Запись.Праздник = Праздник;
		Запись.Записать();
		//Если ДеньНедели(ДатаКалендаря) = 6 Тогда
		//	ДатаПереноса = ДатаКалендаря + 3600*24*2;
		//ИначеЕсли  ДеньНедели(ДатаКалендаря) = 7 Тогда
		//	ДатаПереноса = ДатаКалендаря + 3600*24; 
		//Иначе
		//	Продолжить;
		//КонецЕсли;
		//Запись = РегистрыСведений.КалендарьПраздников.СоздатьМенеджерЗаписи();
		//Запись.ДатаКалендаря = ДатаПереноса;
		//Запись.Год = Год;
		//Запись.Комментарий = "Перенос выходного дня";
		//Запись.Записать();
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура КалендарьПриВыводеПериода(Элемент, ОформлениеПериода)
	Для Каждого СтрокаОформленияПериода Из ОформлениеПериода.Даты Цикл
		СтрокаТаблицыРегистра = ТаблицаРегистра.НайтиСтроки(Новый Структура("Дата",СтрокаОформленияПериода.Дата));
		
		Если СтрокаТаблицыРегистра.Количество() <> 0 Тогда
			СтрокаОформленияПериода.ЦветТекста = WebЦвета.Красный;
			СтрокаОформленияПериода.Подсказка = СтрокаТаблицыРегистра[0].Название;
		//Иначе
		//	СтрокаОформленияПериода.ЦветТекста = WebЦвета.Черный;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

&НаСервере
Функция ПолучитьПраздники(НомерГода)
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ТекущийГод",	НомерГода);
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КалендарьПраздников.ДатаКалендаря КАК Дата,
	|	КалендарьПраздников.Праздник Как Название
	|ИЗ
	|	РегистрСведений.КалендарьПраздников КАК КалендарьПраздников
	|ГДЕ
	|	КалендарьПраздников.Год = &ТекущийГод";
	
	Возврат Запрос.Выполнить().Выгрузить();
КонецФункции	
