
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Параметры.Свойство("СтруктурнаяЕдиница", СтруктурнаяЕдиницаИсточник);
	Параметры.Свойство("СтруктурнаяЕдиница", СтруктурнаяЕдиницаПриемник);
	
	Если Параметры.Свойство("Номенклатура", ВыбранныеЭлементы) Тогда
		ЧастичноеКопирование = 1;
	Иначе
		ЧастичноеКопирование = 0;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ЧастичноеКопированиеПриИзменении(Неопределено);
КонецПроцедуры

&НаСервере
Функция КопированиеНаСервереВыполнено()
	
	НаборЗаписей = РегистрыСведений.ПараметрыЗаказов.СоздатьНаборЗаписей();
	Если ЧастичноеКопирование = 1 Тогда
		Для Каждого ЭлементСписка Из Номенклатура Цикл
			НаборЗаписей.Отбор.СтруктурнаяЕдиница.Установить(СтруктурнаяЕдиницаИсточник);
			НаборЗаписей.Отбор.Номенклатура.Установить(ЭлементСписка.Значение);
			НаборЗаписей.Прочитать();
			
			ВременнаяТаблица = НаборЗаписей.Выгрузить();
			ВременнаяТаблица.ЗаполнитьЗначения(СтруктурнаяЕдиницаПриемник, "СтруктурнаяЕдиница");
			
			НаборЗаписей.Отбор.СтруктурнаяЕдиница.Установить(СтруктурнаяЕдиницаПриемник);
			НаборЗаписей.Загрузить(ВременнаяТаблица);
			НаборЗаписей.Записать();
		КонецЦикла;
	Иначе
		НаборЗаписей.Отбор.СтруктурнаяЕдиница.Установить(СтруктурнаяЕдиницаИсточник);
		НаборЗаписей.Прочитать();
		
		ВременнаяТаблица = НаборЗаписей.Выгрузить();
		ВременнаяТаблица.ЗаполнитьЗначения(СтруктурнаяЕдиницаПриемник, "СтруктурнаяЕдиница");
		
		НаборЗаписей.Отбор.СтруктурнаяЕдиница.Установить(СтруктурнаяЕдиницаПриемник);
		НаборЗаписей.Загрузить(ВременнаяТаблица);
		НаборЗаписей.Записать();
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

&НаКлиенте
Процедура ВыполнитьКопирование(Команда)
	
	Если Не СтруктурнаяЕдиницаИсточник.Пустая() И Не СтруктурнаяЕдиницаПриемник.Пустая() Тогда
		Если Не СтруктурнаяЕдиницаИсточник = СтруктурнаяЕдиницаПриемник Тогда
			Если КопированиеНаСервереВыполнено() Тогда
				Оповестить("Копирование_ПараметрыЗаказов");
			КонецЕсли;
		КонецЕсли;
		Закрыть();
		
	Иначе
		Сообщение = Новый СообщениеПользователю;
		Сообщение.Текст = "Укажите структурную единицу";
		Если СтруктурнаяЕдиницаИсточник.Пустая() Тогда
			Сообщение.Поле = "СтруктурнаяЕдиницаИсточник";
		Иначе
			Сообщение.Поле = "СтруктурнаяЕдиницаПриемник";
		КонецЕсли;
		Сообщение.Сообщить();
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ЧастичноеКопированиеПриИзменении(Элемент)
	Номенклатура.Очистить();
	Если ЧастичноеКопирование = 0 Тогда
		Номенклатура.Добавить("<Весь справочник>");
	Иначе
		Для Каждого ЭС Из ВыбранныеЭлементы Цикл
			//dps+ 27.05.2014 Ошибка релиза. На клиенте нет доступа к СправочникСсылка.<Имя справочника>.<Имя общего реквизита>			
			рекГруппа = Новый Структура;
			рекГруппа.Вставить("Группа");
			рекГруппаЗНЧ = ОбщегоНазначенияСервер.ПолучитьЗначенияРеквизитовОбъекта(ЭС.Значение, рекГруппа);
			Если рекГруппаЗНЧ.Группа = 1 Тогда
			//dps- 27.05.2014 	
				Картинка = БиблиотекаКартинок.Папка;
			Иначе
				Картинка = БиблиотекаКартинок.Элемент;   
			КонецЕсли;
			Номенклатура.Добавить(ЭС.Значение,,, Картинка);
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры
