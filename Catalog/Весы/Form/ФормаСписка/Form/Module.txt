&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	//ПодборНоменклатурыСервер.НастроитьЭлеметыФормыДляПодбора(ЭтаФорма);	
КонецПроцедуры

&НаСервере
Процедура ПриЗагрузкеДанныхИзНастроекНаСервере(Настройки)
	Если Элементы.Найти("ПодборНоменклатуры")<>Неопределено Тогда
		Значение = Настройки.Получить("ОтображениеТаблицыПодбор");
		Если Значение<>Неопределено Тогда
			Элементы.ПодборНоменклатуры.Отображение = Значение;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПриСохраненииДанныхВНастройкахНаСервере(Настройки)
	Если Элементы.Найти("ПодборНоменклатуры")<>Неопределено Тогда
		Настройки.вставить("ОтображениеТаблицыПодбор",элементы.подборНоменклатуры.Отображение);
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура СписокПриАктивизацииСтроки(Элемент)
	Если Элемент.ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	ВесовойТовар.Отбор.Элементы.Очистить();
	Отбор = ВесовойТовар.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	Отбор.Использование = Истина;
	Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСписке;
	Отбор.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Владелец");
	//Отбор.ПравоеЗначение = Элемент.ТекущаяСтрока;
	Отбор.ПравоеЗначение = ПолучитьСписокВесовВладельцев(Элемент.ТекущаяСтрока);
	
КонецПроцедуры

&НаКлиенте
Процедура ПодборНоменклатурыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	Если Не ЗначениеЗаполнено(Элементы.Список.ТекущаяСтрока) Тогда
		Сообщить("Не выбраны весы.");
		Возврат;
	КонецЕсли;
	
	ДобавитьВСписокВесовыхТоваров(Элементы.Список.ТекущаяСтрока, ВыбраннаяСтрока);
КонецПроцедуры

&НаКлиенте
Процедура ПодборОткрыть(Команда)
	Элементы.ГруппаПодбор.Видимость = НЕ Элементы.ГруппаПодбор.Видимость;
	ИмяКнопкиПодбора = "ВесовойТоварОткрытьПодборОткрыть";
	Элементы[ИмяКнопкиПодбора].Пометка = Элементы.ГруппаПодбор.Видимость;
КонецПроцедуры

&НаКлиенте
Процедура ВесовойТоварПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	Отказ = Истина;
	Если Копирование Тогда
		Возврат;
	КонецЕсли;	
	ТекущийВладелец = Элементы.Список.ТекущаяСтрока;
	Если ТекущийВладелец = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ПодборОткрыть(Неопределено);
КонецПроцедуры

&НаСервере
Функция ПолучитьМассивНоменклатурыСШКСервер(Номенклатура)

	мНоменклатураСШК = ШтриховыеКоды.ПолучитьМассивНоменклатурыСШКДляВесов(Номенклатура);
	
	Возврат мНоменклатураСШК;
КонецФункции

&НаКлиенте
//в параметр Номенклатура передается транзакционный товар
Процедура ДобавитьВСписокВесовыхТоваров(Весы, Номенклатура)
	

	мНоменклатураСШК = ПолучитьМассивНоменклатурыСШКСервер(Номенклатура);
	Если мНоменклатураСШК.Количество() = 0 Тогда
		Сообщить("У номенклатуры " + Номенклатура + " нет штрих-кода");
	ИначеЕсли мНоменклатураСШК.Количество() = 1 Тогда
		ДобавитьВесовойТовар(Весы, мНоменклатураСШК[0]);
		СписокПриАктивизацииСтроки(Элементы.Список);
	Иначе
		сз = Новый СписокЗначений;
		сз.ЗагрузитьЗначения(мНоменклатураСШК);
		СтрукОтбор     = Новый Структура("Ссылка",сз);
		СтрукПараметры = Новый Структура("Отбор",СтрукОтбор);
		ФормаВыбора = ПолучитьФорму("Справочник.Номенклатура.ФормаВыбора", СтрукПараметры, ЭтаФорма);
		//ФормаВыбора.Открыть();
		ФормаВыбора.Заголовок = "Выберите товар со штрих-кодом";
		//ФормаВыбора.Список.Отбор.РежимОтображения = РежимОтображенияЭлементаНастройкиКомпоновкиДанных.Недоступный;
		//сз = Новый СписокЗначений;
		//сз.ЗагрузитьЗначения(мНоменклатураСШК);
		//Отбор = ФормаВыбора.Список.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		//Отбор.Использование = Истина;
		//Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСписке;
		//Отбор.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Ссылка");
		//Отбор.ПравоеЗначение = сз;
		//Отбор.РежимОтображения = РежимОтображенияЭлементаНастройкиКомпоновкиДанных.Недоступный;
		ОбработкаТабличныхЧастейКлиент.ОтображениеДинамическогоСпискаСписок(ФормаВыбора, "Список");
		ОбработкаТабличныхЧастейКлиент.ОтображениеГрупп(ФормаВыбора.Список,Ложь);
		ФормаВыбора.Элементы.кнГруппы.Пометка = Ложь;
		ФормаВыбора.Открыть();
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ДобавитьВесовойТовар(Весы, Номенклатура)

	Если НЕ Весы.Родитель.Пустая() Тогда
		Весы = Весы.Родитель;
	КонецЕсли;
	
	ШтриховыеКоды.ДобавитьВесовойТовар(Весы, Номенклатура);

КонецПроцедуры // ДобавитьВесовойТовар()

&НаСервере
Функция ПолучитьСписокВесовВладельцев(Весы)

	СписокВесов =Новый СписокЗначений;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Ссылка", Весы);
	Запрос.Текст = "ВЫБРАТЬ
	               |	Весы.Ссылка КАК Ссылка
	               |ИЗ
	               |	Справочник.Весы КАК Весы
	               |ГДЕ
	               |	Весы.Ссылка = &Ссылка
	               |ИТОГИ ПО
	               |	Ссылка ТОЛЬКО ИЕРАРХИЯ";
	СписокВесов.ЗагрузитьЗначения(Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка"));

	Возврат СписокВесов;
КонецФункции // ()

&НаКлиенте
Процедура ПриЗакрытии()
		СохранитьПараметрыподбора();
КонецПроцедуры

&НаКлиенте
Процедура ПоказатьГруппыВПодборе(Команда)
	элементы.кнГруппы.пометка = не элементы.кнГруппы.пометка;
	флаг = Элементы.кнГруппы.пометка;
	ВЫполнить("ОбработкаТабличныхЧастейКлиент.ОтображениеГрупп(ПодборНоменклатуры,флаг)");
КонецПроцедуры

&НаСервере
Процедура Сохранитьпараметрыподбора()
	ПОдборНоменклатурыСервер.СохранитьПараметрыПодбора("Весы",ЭтаФорма.ИмяФормы,ЭтаФорма.Элементы);
конецпроцедуры

&НаСервере
Функция получитьНастройкуПодбора()
	возврат подборНоменклатурыСервер.ПолучитьНастройкуподбора("Весы",ЭтаФорма.ИмяФормы);	
конецфункции

&НаКлиенте
процедура ЗагрузитьНастройкиПодбора()
		Настройки = ПолучитьНастройкуПодбора();
		ОбработкаТабличныхЧастейКлиент.загрузитьнастройкиподбора(ЭтаФорма,Настройки);
конецпроцедуры

&НаКлиенте
Процедура ПодборЗакрыть(Команда)
	Элементы.ГруппаПодбор.Видимость  = Ложь;
КонецПроцедуры



&НаКлиенте
Процедура СоставВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	если поле.Имя = "СоставНоменклатура" тогда
		Стандартнаяобработка = ложь;
		ПодборОткрыть(Неопределено);
	конецесли;
КонецПроцедуры


&НаКлиенте
Процедура Дерево(Команда)
	обработкатабличныхчастейклиент.ОтображениеДинамическогоСпискаДерево(ЭтаФорма);	
КонецПроцедуры


&НаКлиенте
Процедура Иерархия(Команда)
	обработкатабличныхчастейклиент.отображениединамическогоспискаиерархия(этаформа);	
КонецПроцедуры


&НаКлиенте
Процедура Список(Команда)
	обработкатабличныхчастейклиент.ОтображениеДинамическогоСпискаСписок(этаформа);	
КонецПроцедуры


&НаКлиенте
Процедура ПриОткрытии(Отказ)
	загрузитьНастройкиПодбора();
КонецПроцедуры

&НаКлиенте
//выбор происходит товара с шк, когда невозможно определить основной шк из формы, открытой в ДобавитьВСписокВесовыхТоваров()
Процедура ОбработкаВыбора(ВыбранноеЗначение, ИсточникВыбора)
	Весы = Элементы.Список.ТекущаяСтрока;
	ДобавитьВесовойТовар(Весы, ВыбранноеЗначение);
	СписокПриАктивизацииСтроки(Элементы.Список);
КонецПроцедуры

