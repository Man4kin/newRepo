

Процедура РегистрацияПравила() Экспорт
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	АвтоЗаказПоСтруктурнымЕдиницам.СтруктурнаяЕдиница
		|ИЗ
		|	РегистрСведений.АвтоЗаказПоСтруктурнымЕдиницам КАК АвтоЗаказПоСтруктурнымЕдиницам
		|ГДЕ
		|	АвтоЗаказПоСтруктурнымЕдиницам.Правило = &Правило";

	Запрос.УстановитьПараметр("Правило",Ссылка);	
	Результат = Запрос.Выполнить();

	Узел = ПланыОбмена.ОбменRIB.НайтиПоКоду(1);
	
	Если НЕ Узел.Пустая() Тогда
		ВыборкаДетальныеЗаписи = Результат.Выбрать();
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			НаборЗаписей = РегистрыСведений.АвтоЗаказПоСтруктурнымЕдиницам.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Правило.Установить(Ссылка);
			НаборЗаписей.Отбор.СтруктурнаяЕдиница.Установить(ВыборкаДетальныеЗаписи.СтруктурнаяЕдиница);
			ПланыОбмена.ЗарегистрироватьИзменения(Узел,НаборЗаписей);	
		КонецЦикла;
	КонецЕсли;	
КонецПроцедуры

Процедура ПриЗаписи(Отказ)
	Если Ссылка.ПометкаУдаления Тогда
		ОчиститьДанныеАвтоЗаказа();
	Иначе 
		РегистрацияПравила();
	КонецЕсли;
КонецПроцедуры

//++Минин 0000136414 2015-08-19
Процедура ОчиститьДанныеАвтоЗаказа()
	Запрос = Новый Запрос;
	Запрос.Текст = 		
	"ВЫБРАТЬ
	|	АвтоЗаказПоСтруктурнымЕдиницам.СтруктурнаяЕдиница
	|ИЗ
	|	РегистрСведений.АвтоЗаказПоСтруктурнымЕдиницам КАК АвтоЗаказПоСтруктурнымЕдиницам
	|ГДЕ
	|	АвтоЗаказПоСтруктурнымЕдиницам.Правило = &Правило";
	
	Запрос.УстановитьПараметр("Правило",Ссылка);	
	Результат = Запрос.Выполнить();
	
	Если Не Результат.Пустой() Тогда 
		ВыборкаДетальныеЗаписи = Результат.Выбрать();
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл 
			МенеджерЗаписи = РегистрыСведений.АвтоЗаказПоСтруктурнымЕдиницам.СоздатьМенеджерЗаписи();
			МенеджерЗаписи.Правило = Ссылка;
			МенеджерЗаписи.СтруктурнаяЕдиница = ВыборкаДетальныеЗаписи.СтруктурнаяЕдиница;
			МенеджерЗаписи.Прочитать();
			МенеджерЗаписи.Удалить();
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры
//--Минин 0000136414 2015-08-19
